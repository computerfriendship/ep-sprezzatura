function initializeInkgine(t){let a=new inkjs.Story(t);function s(t,e){var e=Math.ceil(Math.log2(e)),n=t.slice(-e),t=t.slice(0,-e);return[function t(e){return 0==e.length?0:e[e.length-1]+(t(e.slice(0,-1))<<1)}(n),t]}return{register:function(t){function i(){return a.canContinue?(t.ports.lineAvailableRaw.send({line:a.Continue(),tags:a.currentTags,choices:a.currentChoices.map(t=>t.text),nextLineAvailable:a.canContinue}),!0):1==a.currentChoices.length&&(a.ChooseChoiceIndex(0),i())}function r(t){try{a.ChooseChoiceIndex(t),i()}catch(t){console.error("Error while submitting a choice to Ink!  Most likely, Elm sent us an invalid choice index."),console.log(t)}}t.ports.requestNextLine_.subscribe(i),t.ports.reinitialize_.subscribe(function(t){for(var[e,t]=t,t=(console.log("Ink reseting..."),a.ResetState(),i(),function t(e){if(0<e.length){for(;i(););var[e,n]=s(e,a.currentChoices.length);return r(e),[e,...t(n)]}return[]}(t)),n=0;n<e;n++)i();console.log("Ink reset to position:",t,e)}),t.ports.makeChoice.subscribe(r)},metadata:a.globalTags??[]}}(i=>{function j(t,e,n){return n.a=t,n.f=e,n}function c(n){return j(2,n,function(e){return function(t){return n(e,t)}})}function d(i){return j(3,i,function(n){return function(e){return function(t){return i(n,e,t)}}})}function h(r){return j(4,r,function(i){return function(n){return function(e){return function(t){return r(i,n,e,t)}}}})}function r(a){return j(5,a,function(r){return function(i){return function(n){return function(e){return function(t){return a(r,i,n,e,t)}}}}})}function a(s){return j(6,s,function(a){return function(r){return function(i){return function(n){return function(e){return function(t){return s(a,r,i,n,e,t)}}}}}})}function s(o){return j(7,o,function(s){return function(a){return function(r){return function(i){return function(n){return function(e){return function(t){return o(s,a,r,i,n,e,t)}}}}}}})}function f(t,e,n){return 2===t.a?t.f(e,n):t(e)(n)}function p(t,e,n,i){return 3===t.a?t.f(e,n,i):t(e)(n)(i)}function m(t,e,n,i,r){return 4===t.a?t.f(e,n,i,r):t(e)(n)(i)(r)}function u(t,e,n,i,r,a){return 5===t.a?t.f(e,n,i,r,a):t(e)(n)(i)(r)(a)}function B(t,e,n,i,r,a,s){return 6===t.a?t.f(e,n,i,r,a,s):t(e)(n)(i)(r)(a)(s)}function M(t,e,n,i,r,a,s,o){return 7===t.a?t.f(e,n,i,r,a,s,o):t(e)(n)(i)(r)(a)(s)(o)}function l(t,e){for(var n,i=[],r=G(t,e,0,i);r&&(n=i.pop());r=G(n.a,n.b,0,i));return r}function G(t,e,n,i){if(t!==e){if("object"!=typeof t||null===t||null===e)return"function"==typeof t&&Q(5),!1;if(100<n)i.push({a:t,b:e});else for(var r in t.$<0&&(t=hn(t),e=hn(e)),t)if(!G(t[r],e[r],n+1,i))return!1}return!0}function g(t,e,n){if("object"!=typeof t)return t===e?0:t<e?-1:1;if(void 0===t.$)return(n=(n=g(t.a,e.a))||g(t.b,e.b))||g(t.c,e.c);for(;t.b&&e.b&&!(n=g(t.a,e.a));t=t.b,e=e.b);return n||(t.b?1:e.b?-1:0)}var q=c(function(t,e){t=g(t,e);return t<0?on:t?sn:an}),U=0;function v(t,e){var n,i={};for(n in t)i[n]=t[n];for(n in e)i[n]=e[n];return i}function b(t,e){if("string"==typeof t)return t+e;if(!t.b)return e;var n={$:1,a:t.a,b:e};t=t.b;for(var i=n;t.b;t=t.b)i=i.b={$:1,a:t.a,b:e};return n}var C={$:0};function K(t,e){return{$:1,a:t,b:e}}var H=c(K);function S(t){for(var e=C,n=t.length;n--;)e={$:1,a:t[n],b:e};return e}function J(t){for(var e=[];t.b;t=t.b)e.push(t.a);return e}var z=d(function(t,e,n){for(var i=[];e.b&&n.b;e=e.b,n=n.b)i.push(f(t,e.a,n.a));return S(i)}),X=d(function(t,e,n){for(var i=Array(t),r=0;r<t;r++)i[r]=n(e+r);return i}),Y=c(function(t,e){for(var n=Array(t),i=0;i<t&&e.b;i++)n[i]=e.a,e=e.b;return n.length=i,{a:n,b:e}}),Z=c(function(t,e){return e[t]});function Q(t){throw Error("https://github.com/elm/core/blob/1.0.0/hints/"+t+".md")}var tt=c(function(t,e){return t+e}),et=c(Math.pow),nt=c(function(t,e){e%=t;return 0===t?Q(11):0<e&&t<0||e<0&&0<t?e+t:e}),it=Math.ceil,rt=Math.floor,at=Math.log,st=c(function(t,e){return t+e}),ot=d(function(t,e,n){for(var i=n.length;i--;){var r=n[i],a=n.charCodeAt(i);e=f(t,r=a<56320||57343<a?r:n[--i]+r,e)}return e}),lt=c(function(t,e){return e.join(t)}),ht=d(function(t,e,n){return n.slice(t,e)}),t=c(function(t,e){return!!~e.indexOf(t)}),ut=c(function(t,e){return 0==e.indexOf(t)}),ct=c(function(t,e){var n=t.length;if(n<1)return C;for(var i=0,r=[];~(i=e.indexOf(t,i));)r.push(i),i+=n;return S(r)}),dt={$:2,b:function(t){return"number"!=typeof t||(t<=-2147483647||2147483647<=t||(0|t)!==t)&&(!isFinite(t)||t%1)?w("an INT",t):x(t)}},ft={$:2,b:function(t){return"boolean"==typeof t?x(t):w("a BOOL",t)}},pt={$:2,b:function(t){return"string"==typeof t?x(t):t instanceof String?x(t+""):w("a STRING",t)}},mt=c(function(t,e){return{$:6,d:t,b:e}}),gt=c(function(t,e){return{$:10,b:e,h:t}}),vt=c(function(t,e){return{$:9,f:t,g:[e]}}),bt=c(y);function y(t,e){switch(t.$){case 2:return t.b(e);case 5:return null===e?x(t.c):w("null",e);case 3:return St(e)?Ct(t.b,e,S):w("a LIST",e);case 4:return St(e)?Ct(t.b,e,yt):w("an ARRAY",e);case 6:var n=t.d;return"object"==typeof e&&null!==e&&n in e?(a=y(t.b,e[n]),F(a)?a:A(f(cn,n,a.a))):w("an OBJECT with a field named `"+n+"`",e);case 7:n=t.e;return St(e)?n<e.length?(a=y(t.b,e[n]),F(a)?a:A(f(dn,n,a.a))):w("a LONGER array. Need index "+n+" but only see "+e.length+" entries",e):w("an ARRAY",e);case 8:if("object"!=typeof e||null===e||St(e))return w("an OBJECT",e);var i,r=C;for(i in e)if(e.hasOwnProperty(i)){var a=y(t.b,e[i]);if(!F(a))return A(f(cn,i,a.a));r={$:1,a:{a:i,b:a.a},b:r}}return x(En(r));case 9:for(var s=t.f,o=t.g,l=0;l<o.length;l++){a=y(o[l],e);if(!F(a))return a;s=s(a.a)}return x(s);case 10:a=y(t.b,e);return F(a)?y(t.h(a.a),e):a;case 11:for(var h=C,u=t.g;u.b;u=u.b){a=y(u.a,e);if(F(a))return a;h={$:1,a:a.a,b:h}}return A(fn(En(h)));case 1:return A(f(un,t.a,e));case 0:return x(t.a)}}function Ct(t,e,n){for(var i=e.length,r=Array(i),a=0;a<i;a++){var s=y(t,e[a]);if(!F(s))return A(f(dn,a,s.a));r[a]=s.a}return x(n(r))}function St(t){return Array.isArray(t)||"undefined"!=typeof FileList&&t instanceof FileList}function yt(e){return f(jn,e.length,function(t){return e[t]})}function w(t,e){return A(f(un,"Expecting "+t,e))}function wt(t,e){if(t===e)return!0;if(t.$!==e.$)return!1;switch(t.$){case 0:case 1:return t.a===e.a;case 2:return t.b===e.b;case 5:return t.c===e.c;case 3:case 4:case 8:return wt(t.b,e.b);case 6:return t.d===e.d&&wt(t.b,e.b);case 7:return t.e===e.e&&wt(t.b,e.b);case 9:return t.f===e.f&&Et(t.g,e.g);case 10:return t.h===e.h&&wt(t.b,e.b);case 11:return Et(t.g,e.g)}}function Et(t,e){var n=t.length;if(n!==e.length)return!1;for(var i=0;i<n;i++)if(!wt(t[i],e[i]))return!1;return!0}function _t(t){return t}function Tt(t){return{$:0,a:t}}var At=c(function(t,e){return{$:3,b:t,d:e}}),xt=0;function It(t){t={$:0,e:xt++,f:t,g:null,h:[]};return kt(t),t}function Pt(e){return{$:2,b:function(t){t({$:0,a:It(e)})},c:null}}function Nt(t,e){t.h.push(e),kt(t)}var Ot=c(function(e,n){return{$:2,b:function(t){Nt(e,n),t({$:0,a:U})},c:null}}),Ft=!1,Wt=[];function kt(t){if(Wt.push(t),!Ft){for(Ft=!0;t=Wt.shift();)(e=>{for(;e.f;){var t=e.f.$;if(0===t||1===t){for(;e.g&&e.g.$!==t;)e.g=e.g.i;if(!e.g)return;e.f=e.g.b(e.f.a),e.g=e.g.i}else{if(2===t)return e.f.c=e.f.b(function(t){e.f=t,kt(e)});if(5===t){if(0===e.h.length)return;e.f=e.f.b(e.h.shift())}else e.g={$:3===t?0:1,b:e.f.b,i:e.g},e.f=e.f.d}}})(t);Ft=!1}}function Rt(t,e,n,i,r,a){var t=f(bt,t,e?e.flags:void 0),s=(F(t)||Q(2),{}),e=n(t.a),o=e.a,l=a(h,o),n=((t,e)=>{var n,i;for(i in E){var r=E[i];r.a&&((n=n||{})[i]=r.a(i,e)),t[i]=((t,e)=>{var i={g:e,h:void 0},r=t.c,a=t.d,s=t.e,o=t.f;function l(n){return f(At,l,{$:5,b:function(t){var e=t.a;return 0===t.$?p(a,i,e,n):s&&o?m(r,i,e.i,e.j,n):p(r,i,s?e.i:e.j,n)}})}return i.h=It(f(At,l,t.b))})(r,e)}return n})(s,h);function h(t,e){t=f(i,t,o);l(o=t.a,e),Mt(s,t.b,r(o))}return Mt(s,e.b,r(o)),n?{ports:n}:{}}var E={},Lt=c(function(e,n){return{$:2,b:function(t){e.g(n),t({$:0,a:U})},c:null}}),Dt=c(function(t,e){return f(Ot,t.h,{$:0,a:e})});function $t(e){return function(t){return{$:1,k:e,l:t}}}function Vt(t){return{$:2,m:t}}var jt=[],Bt=!1;function Mt(t,e,n){if(jt.push({p:t,q:e,r:n}),!Bt){Bt=!0;for(var i;i=jt.shift();)((t,e,n)=>{var i,r={};for(i in Gt(!0,e,r,null),Gt(!1,n,r,null),t)Nt(t[i],{$:"fx",a:r[i]||{i:C,j:C}})})(i.p,i.q,i.r);Bt=!1}}function Gt(t,e,n,i){switch(e.$){case 1:var r=e.k,a=((t,e,n,i)=>{function r(t){for(var e=n;e;e=e.t)t=e.s(t);return t}return f(t?E[e].e:E[e].f,r,i)})(t,r,i,e.l);return void(n[r]=((t,e,n)=>(n=n||{i:C,j:C},t?n.i={$:1,a:e,b:n.i}:n.j={$:1,a:e,b:n.j},n))(t,a,n[r]));case 2:for(var s=e.m;s.b;s=s.b)Gt(t,s.a,n,i);return;case 3:Gt(t,e.o,n,{s:e.n,t:i})}}function qt(t){E[t]&&Q(3)}function Ut(t,e){return qt(t),E[t]={e:Kt,u:e,a:Ht},$t(t)}var Kt=c(function(t,e){return e});function Ht(t){var n,s=[],o=E[t].u,l=(n=0,{$:2,b:function(t){var e=setTimeout(function(){t({$:0,a:U})},n);return function(){clearTimeout(e)}},c:null});return E[t].b=l,E[t].c=d(function(t,e,n){for(;e.b;e=e.b)for(var i=s,r=o(e.a),a=0;a<i.length;a++)i[a](r);return l}),{subscribe:function(t){s.push(t)},unsubscribe:function(t){(t=(s=s.slice()).indexOf(t))<0||s.splice(t,1)}}}var Jt,zt=c(function(e,n){return function(t){return e(n(t))}});function Xt(t,i){var r=C,a=E[t].u,s={$:0,a:null};return E[t].b=s,E[t].c=d(function(t,e,n){return r=e,s}),{send:function(t){F(t=f(bt,a,t))||Q(4);for(var e=t.a,n=r;n.b;n=n.b)i(n.a(e))}}}var Yt="undefined"!=typeof document?document:{};function Zt(t){return{$:0,a:t}}var Qt,_=c(function(a,s){return c(function(t,e){for(var n=[],i=0;e.b;e=e.b){var r=e.a;i+=r.b||0,n.push(r)}return i+=n.length,{$:1,c:s,d:ue(t),e:n,f:a,b:i}})})(void 0),te=c(function(a,s){return c(function(t,e){for(var n=[],i=0;e.b;e=e.b){var r=e.a;i+=r.b.b||0,n.push(r)}return i+=n.length,{$:2,c:s,d:ue(t),e:n,f:a,b:i}})})(void 0),ee=c(function(t,e){return{$:"a0",n:t,o:e}}),ne=c(function(t,e){return{$:"a1",n:t,o:e}}),ie=c(function(t,e){return{$:"a2",n:t,o:e}}),re=c(function(t,e){return{$:"a3",n:t,o:e}}),ae=/^script$/i,se=/^(on|formAction$)/i,oe=/^\s*j\s*a\s*v\s*a\s*s\s*c\s*r\s*i\s*p\s*t\s*:/i,le=/^\s*(j\s*a\s*v\s*a\s*s\s*c\s*r\s*i\s*p\s*t\s*:|d\s*a\s*t\s*a\s*:\s*t\s*e\s*x\s*t\s*\/\s*h\s*t\s*m\s*l\s*(,|;))/i;function he(t){return le.test(t)?"":t}function ue(t){for(var e={};t.b;t=t.b){var n,i=t.a,r=i.$,a=i.n,i=i.o;"a2"===r?"className"===a?ce(e,a,i):e[a]=i:(n=e[r]||(e[r]={}),"a3"===r&&"class"===a?ce(n,a,i):n[a]=i)}return e}function ce(t,e,n){var i=t[e];t[e]=i?i+" "+n:n}function de(t,e){var n=t.$;if(5===n)return de(t.k||(t.k=t.m()),e);if(0===n)return Yt.createTextNode(t.a);if(4===n){for(var i=t.k,r=t.j;4===i.$;)"object"!=typeof r?r=[r,i.j]:r.push(i.j),i=i.k;var a={j:r,p:e};(s=de(i,a)).elm_event_node_ref=a}else if(3===n)fe(s=t.h(t.g),e,t.d);else{var s=t.f?Yt.createElementNS(t.f,t.c):Yt.createElement(t.c);Jt&&"a"==t.c&&s.addEventListener("click",Jt(s)),fe(s,e,t.d);for(var o=t.e,l=0;l<o.length;l++)s.appendChild(de(1===n?o[l]:o[l].b,e))}return s}function fe(t,e,n){for(var i in n){var r=n[i];"a1"===i?((t,e)=>{var n,i=t.style;for(n in e)i[n]=e[n]})(t,r):"a0"===i?((t,e,n)=>{var i,r=t.elmFs||(t.elmFs={});for(i in n){var a=n[i],s=r[i];if(a){if(s){if(s.q.$===a.$){s.q=a;continue}t.removeEventListener(i,s)}s=((l,t)=>{function h(t){var e=h.q,n=y(e.a,t);if(F(n)){for(var i,e=Gn(e),n=n.a,r=e?e<3?n.a:n.s:n,a=1==e?n.b:3==e&&n.ai,s=(a&&t.stopPropagation(),(2==e?n.b:3==e&&n.af)&&t.preventDefault(),l);i=s.j;){if("function"==typeof i)r=i(r);else for(var o=i.length;o--;)r=i[o](r);s=s.p}s(r,a)}}return h.q=t,h})(e,a),t.addEventListener(i,s,Qt&&{passive:Gn(a)<2}),r[i]=s}else t.removeEventListener(i,s),r[i]=void 0}})(t,e,r):"a3"===i?((t,e)=>{for(var n in e){var i=e[n];void 0!==i?t.setAttribute(n,i):t.removeAttribute(n)}})(t,r):"a4"===i?((t,e)=>{for(var n in e){var i=e[n],r=i.f,i=i.o;void 0!==i?t.setAttributeNS(r,n,i):t.removeAttributeNS(r,n)}})(t,r):("value"!==i&&"checked"!==i||t[i]!==r)&&(t[i]=r)}}try{window.addEventListener("t",null,Object.defineProperty({},"passive",{get:function(){Qt=!0}}))}catch(t){}function pe(t,e){var n=[];return N(t,e,n,0),n}function P(t,e,n,i){e={$:e,r:n,s:i,t:void 0,u:void 0};return t.push(e),e}function N(t,e,n,i){if(t!==e){var r=t.$,a=e.$;if(r!==a){if(1!==r||2!==a)return void P(n,0,i,e);e=(t=>{for(var e=t.e,n=e.length,i=Array(n),r=0;r<n;r++)i[r]=e[r].b;return{$:1,c:t.c,d:t.d,e:i,f:t.f,b:t.b}})(e),a=1}switch(a){case 5:for(var s=t.l,o=e.l,l=s.length,h=l===o.length;h&&l--;)h=s[l]===o[l];if(h)return void(e.k=t.k);e.k=e.m();var u=[];return N(t.k,e.k,u,0),void(0<u.length&&P(n,1,i,u));case 4:for(var c=t.j,d=e.j,f=!1,p=t.k;4===p.$;)f=!0,"object"!=typeof c?c=[c,p.j]:c.push(p.j),p=p.k;for(var m=e.k;4===m.$;)f=!0,"object"!=typeof d?d=[d,m.j]:d.push(m.j),m=m.k;return f&&c.length!==d.length?void P(n,0,i,e):((f?((t,e)=>{for(var n=0;n<t.length;n++)if(t[n]!==e[n])return;return 1})(c,d):c===d)||P(n,2,i,d),void N(p,m,n,i+1));case 0:return void(t.a!==e.a&&P(n,3,i,e.a));case 1:return void me(t,e,n,i,ve);case 2:return void me(t,e,n,i,be);case 3:if(t.h!==e.h)return void P(n,0,i,e);u=ge(t.d,e.d),u=(u&&P(n,4,i,u),e.i(t.g,e.g));u&&P(n,5,i,u)}}}function me(t,e,n,i,r){var a;t.c!==e.c||t.f!==e.f?P(n,0,i,e):((a=ge(t.d,e.d))&&P(n,4,i,a),r(t,e,n,i))}function ge(t,e,n){var i,r,a,s,o;for(r in t)"a1"===r||"a0"===r||"a3"===r||"a4"===r?(a=ge(t[r],e[r]||{},r))&&((i=i||{})[r]=a):r in e?(a=t[r])===(s=e[r])&&"value"!==r&&"checked"!==r||"a0"===n&&((t,e)=>t.$==e.$&&wt(t.a,e.a))(a,s)||((i=i||{})[r]=s):(i=i||{})[r]=n?"a1"===n?"":"a0"===n||"a3"===n?void 0:{f:t[r].f,o:void 0}:"string"==typeof t[r]?"":null;for(o in e)o in t||((i=i||{})[o]=e[o]);return i}function ve(t,e,n,i){var r=t.e,a=e.e,t=r.length,e=a.length;e<t?P(n,6,i,{v:e,i:t-e}):t<e&&P(n,7,i,{v:t,e:a});for(var s=t<e?t:e,o=0;o<s;o++){var l=r[o];N(l,a[o],n,++i),i+=l.b||0}}function be(t,e,n,i){for(var r=[],a={},s=[],o=t.e,l=e.e,h=o.length,u=l.length,c=0,d=0,f=i;c<h&&d<u;){var p=o[c],m=l[d],g=p.a,v=m.a,b=p.b,C=m.b,S=void 0,y=void 0;if(g===v)N(b,C,r,++f),f+=b.b||0,c++,d++;else{var w,E,_,T,A=o[c+1],x=l[d+1];if(A&&(E=A.b,y=v===(w=A.a)),x&&(T=x.b,S=g===(_=x.a)),S&&y)N(b,T,r,++f),Se(a,r,g,C,d,s),f+=b.b||0,ye(a,r,g,E,++f),f+=E.b||0,c+=2,d+=2;else if(S)f++,Se(a,r,v,C,d,s),N(b,T,r,f),f+=b.b||0,c+=1,d+=2;else if(y)ye(a,r,g,b,++f),f+=b.b||0,N(E,C,r,++f),f+=E.b||0,c+=2,d+=1;else{if(!A||w!==_)break;ye(a,r,g,b,++f),Se(a,r,v,C,d,s),f+=b.b||0,N(E,T,r,++f),f+=E.b||0,c+=2,d+=2}}}for(;c<h;){b=(p=o[c]).b;ye(a,r,p.a,b,++f),f+=b.b||0,c++}for(;d<u;){var I=I||[];Se(a,r,(m=l[d]).a,m.b,void 0,I),d++}(0<r.length||0<s.length||I)&&P(n,8,i,{w:r,x:s,y:I})}var Ce="_elmW6BL";function Se(t,e,n,i,r,a){var s,o=t[n];o?1===o.c?(a.push({r:r,A:o}),o.c=2,N(o.z,i,s=[],o.r),o.r=r,o.s.s={w:s,A:o}):Se(t,e,n+Ce,i,r,a):(a.push({r:r,A:o={c:0,z:i,r:r,s:void 0}}),t[n]=o)}function ye(t,e,n,i,r){var a,s=t[n];s?0===s.c?(s.c=2,N(i,s.z,a=[],r),P(e,9,r,{w:a,A:s})):ye(t,e,n+Ce,i,r):(a=P(e,9,r,void 0),t[n]={c:1,z:i,r:r,s:a})}function we(t,e,n,i){!function t(e,n,i,r,a,s,o){var l=i[r];var h=l.r;for(;h===a;){var u,c=l.$;if(1===c?we(e,n.k,l.s,o):8===c?(l.t=e,l.u=o,0<(u=l.s.w).length&&t(e,n,u,0,a,s,o)):9===c?(l.t=e,l.u=o,(c=l.s)&&(c.A.s=e,0<(u=c.w).length)&&t(e,n,u,0,a,s,o)):(l.t=e,l.u=o),!(l=i[++r])||(h=l.r)>s)return r}var d=n.$;if(4===d){for(var f=n.k;4===f.$;)f=f.k;return t(e,f,i,r,a+1,s,e.elm_event_node_ref)}var p=n.e;var m=e.childNodes;for(var g=0;g<p.length;g++){var v=1===d?p[g]:p[g].b,b=++a+(v.b||0);if(a<=h&&h<=b&&(r=t(m[g],v,i,r,a,b,o),!(l=i[r])||(h=l.r)>s))return r;a=b}return r}(t,e,n,0,0,e.b,i)}function Ee(t,e,n,i){return 0===n.length?t:(we(t,e,n,i),_e(t,n))}function _e(t,e){for(var n=0;n<e.length;n++){var i=e[n],r=i.t,i=((t,e)=>{switch(e.$){case 0:return((t,e,n)=>{var i=t.parentNode;return(e=de(e,n)).elm_event_node_ref||(e.elm_event_node_ref=t.elm_event_node_ref),i&&e!==t&&i.replaceChild(e,t),e})(t,e.s,e.u);case 4:return fe(t,e.u,e.s),t;case 3:return t.replaceData(0,t.length,e.s),t;case 1:return _e(t,e.s);case 2:return t.elm_event_node_ref?t.elm_event_node_ref.j=e.s:t.elm_event_node_ref={j:e.s,p:e.u},t;case 6:for(var n=e.s,i=0;i<n.i;i++)t.removeChild(t.childNodes[n.v]);return t;case 7:for(var r=(n=e.s).e,i=n.v,a=t.childNodes[i];i<r.length;i++)t.insertBefore(de(r[i],e.u),a);return t;case 9:var s;return(n=e.s)?(void 0!==(s=n.A).r&&t.parentNode.removeChild(t),s.s=_e(t,n.w)):t.parentNode.removeChild(t),t;case 8:return((t,e)=>{for(var n=e.s,i=((t,e)=>{if(t){for(var n=Yt.createDocumentFragment(),i=0;i<t.length;i++){var r=t[i].A;n.appendChild(2===r.c?r.s:de(r.z,e.u))}return n}})(n.y,e),r=(t=_e(t,n.w),n.x),a=0;a<r.length;a++){var s=r[a],o=s.A,o=2===o.c?o.s:de(o.z,e.u);t.insertBefore(o,t.childNodes[s.r])}return i&&t.appendChild(i),t})(t,e);case 5:return e.s(t);default:Q(10)}})(r,i);r===t&&(t=i)}return t}function Te(t){if(3===t.nodeType)return{$:0,a:t.textContent};if(1!==t.nodeType)return{$:0,a:""};for(var e=C,n=t.attributes,i=n.length;i--;)var r=n[i],e={$:1,a:f(re,r.name,r.value),b:e};for(var a=t.tagName.toLowerCase(),s=C,o=t.childNodes,i=o.length;i--;)s={$:1,a:Te(o[i]),b:s};return p(_,a,e,s)}var Ae=h(function(e,t,n,i){return Rt(t,i,e.be,e.bn,e.bm,function(i,t){var r=e.ag&&e.ag(i),a=e.bo,s=Yt.title,o=Yt.body,l=Te(o);return Ie(t,function(t){Jt=r;var t=a(t),e=_("body")(C)(t.a6),n=pe(l,e);o=Ee(o,l,n,i),l=e,Jt=0,s!==t.aZ&&(Yt.title=s=t.aZ)})})}),xe="undefined"!=typeof requestAnimationFrame?requestAnimationFrame:function(t){return setTimeout(t,1e3/60)};function Ie(n,i){i(n);var r=0;function a(){r=1===r?0:(xe(a),i(n),1)}return function(t,e){n=t,e?(i(n),2===r&&(r=1)):(0===r&&xe(a),r=2)}}function Pe(){return ri(Yt.location.href).a||Q(1)}var Ne=c(function(t,e){return f(fi,ai,{$:2,b:function(){history.pushState({},"",e),t()},c:null})}),Oe={addEventListener:function(){},removeEventListener:function(){}},Fe="undefined"!=typeof document?document:Oe,We="undefined"!=typeof window?window:Oe,ke=d(function(n,i,r){return Pt({$:2,b:function(t){function e(t){It(r(t))}return n.addEventListener(i,e,Qt&&{passive:!0}),function(){n.removeEventListener(i,e)}},c:null})}),Re=c(function(t,e){t=y(t,e);return F(t)?I(t.a):O});function Le(t){return p(vn,c(function(t,e){return e+1}),0,t)}function De(t){return 97<=(t=wn(t))&&t<=122}function $e(t){return(t=wn(t))<=90&&65<=t}function Ve(t){return De(t)||$e(t)||(t=>(t=wn(t))<=57&&48<=t)(t)}function je(t){return t.a}function Be(t){return""===t}function Me(t){return p(oi,hi(T),W(C),t)}function Ge(t){return p(vn,c(function(t,e){return p(Si,t.a,t.b,e)}),gi,t)}function qe(t){return p(wi,T,C,t)}function Ue(t){return p(oi,Ai,C,t)}function Ke(t){var e,n,i,r,a,s,o,l,h,u,c,d;return(t=p(On,Wi,k(f(Oi,C,6)),f(Fi,0,Ri(f(k,_i,qe(t)))))).$?A(t.a):t.a.b&&t.a.a.b&&t.a.a.b.b&&t.a.a.b.b.b&&t.a.a.b.b.b.b&&t.a.a.b.b.b.b.b&&t.a.a.b.b.b.b.b.b&&!t.a.a.b.b.b.b.b.b.b&&t.a.b.b&&t.a.b.a.b&&t.a.b.a.b.b&&t.a.b.a.b.b.b&&t.a.b.a.b.b.b.b&&t.a.b.a.b.b.b.b.b&&t.a.b.a.b.b.b.b.b.b&&!t.a.b.a.b.b.b.b.b.b.b?(n=(r=(e=(d=(c=(t=t.a).a).b).b).b).a,i=(r=r.b).a,r=r.b.a,a=(u=(t=t.b).a).a,s=(u=u.b).a,o=(u=u.b).a,l=(u=u.b).a,h=(u=u.b).a,u=u.b.a,t=t.b,c=Ti(S([c.a,d.a,e.a])),d=Ti(S([n,i,r,a,s,o,l,h,u])),x(f(pi,d,f(xi,c,Ue(t))))):A(1)}function He(t){return{$:2,a:t}}function Je(t){switch(t){case 13:case 32:return wr;default:return ar}}function ze(t){return Dr(er(t))}function Xe(t){var e=t._;return{M:t.M,aW:e.b?{$:1,a:e}:t.ad?Li:Ir,P:f(k,ze,t.P)}}function Ye(t){return{$:0,a:t}}function Ze(t){return t.b?I(t.a):O}function Qe(t){return p(vn,pn,0,t)}function tn(t){switch(t.$){case 0:return Hn(t.a);case 1:case 2:case 3:e=t.a;return Vr()(e);default:var e=t.a;return 2+Vr()(e)}}Oe=c(function(n,i){return{$:2,b:function(t){var e=setInterval(function(){It(i)},n);return function(){clearInterval(e)}},c:null}});var en,nn=r(function(t,e,n,i,r){for(var a=t.length,s=e+a<=r.length,o=0;s&&o<a;)var l=r.charCodeAt(e),s=t[o++]===r[e++]&&(10==l?(n++,i=1):(i++,55296==(63488&l)?t[o++]===r[e++]:1));return{a:s?e:-1,b:n,c:i}}),rn=d(function(t,e,n){return e<n.length?55296==(63488&n.charCodeAt(e))?t(n.substr(e,2))?e+2:-1:t(n[e])?"\n"===n[e]?-2:e+1:-1:-1}),an=1,sn=2,on=0,T=H,ln=d(function(t,e,n){for(;;){if(-2===n.$)return e;var i=n.d,r=t,a=p(t,n.b,n.c,p(ln,t,e,n.e));t=r,e=a,n=i}}),hn=function(t){return p(ln,d(function(t,e,n){return f(T,{a:t,b:e},n)}),C,t)},A=function(t){return{$:1,a:t}},un=c(function(t,e){return{$:3,a:t,b:e}}),cn=c(function(t,e){return{$:0,a:t,b:e}}),dn=c(function(t,e){return{$:1,a:t,b:e}}),x=function(t){return{$:0,a:t}},fn=function(t){return{$:2,a:t}},pn=tt,I=function(t){return{$:0,a:t}},O={$:1},mn=function(t){return t+""},gn=c(function(t,e){return f(lt,t,J(e))}),vn=d(function(t,e,n){for(;;){if(!n.b)return e;var i=n.b,r=t,a=f(t,n.a,e);t=r,e=a,n=i}}),bn=z,Cn=d(function(t,e,n){for(;;){if(1<=g(t,e))return n;var i=t,r=e-1,a=f(T,e,n);t=i,e=r,n=a}}),Sn=c(function(t,e){return p(Cn,t,e,C)}),yn=c(function(t,e){return p(bn,t,f(Sn,0,Le(e)-1),e)}),wn=function(t){var e=t.charCodeAt(0);return e<55296||56319<e?e:1024*(e-55296)+t.charCodeAt(1)-56320+65536},En=function(t){return p(vn,T,C,t)},_n=h(function(t,e,n,i){return{$:0,a:t,b:e,c:n,d:i}}),Tn=[],An=it,xn=c(function(t,e){return at(e)/at(t)}),In=An(f(xn,2,32)),Pn=m(_n,0,In,Tn,Tn),Nn=X,On=c(function(t,e){return t(e)}),Fn=rt,Wn=function(t){return t.length},kn=c(function(t,e){return 0<g(t,e)?t:e}),Rn=Y,Ln=c(function(t,e){for(;;){var n=f(Rn,32,t),i=n.b,n=f(T,{$:0,a:n.a},e);if(!i.b)return En(n);t=i,e=n}}),Dn=c(function(t,e){for(;;){var n=An(e/32);if(1===n)return f(Rn,32,t).a;t=f(Ln,t,C),e=n}}),$n=c(function(t,e){var n,i;return e.d?(i=Fn(f(xn,32,(n=32*e.d)-1)),t=t?En(e.f):e.f,t=f(Dn,t,e.d),m(_n,Wn(e.e)+n,f(kn,5,i*In),t,e.e)):m(_n,Wn(e.e),In,Tn,e.e)}),Vn=r(function(t,e,n,i,r){for(;;){if(e<0)return f($n,!1,{f:i,d:n/32|0,e:r});var a={$:1,a:p(Nn,32,e,t)};t=t,e=e-32,n=n,i=f(T,a,i),r=r}}),jn=c(function(t,e){var n;return 0<t?u(Vn,e,t-(n=t%32)-32,t,C,p(Nn,n,t-n,e)):Pn}),F=function(t){return!t.$},Bn=vt,Mn=function(t){return{$:0,a:t}},Gn=function(t){switch(t.$){case 0:return 0;case 1:return 1;case 2:return 2;default:return 3}},qn=function(t){return t},Un=a(function(t,e,n,i,r,a){return{L:a,aB:e,aH:i,aJ:n,aN:t,aO:r}}),Kn=t,Hn=function(t){return t.length},Jn=ht,zn=c(function(t,e){return t<1?e:p(Jn,t,Hn(e),e)}),Xn=ct,Yn=c(function(t,e){return t<1?"":p(Jn,0,t,e)}),Zn=function(t){for(var e=0,n=t.charCodeAt(0),i=43==n||45==n?1:0,r=i;r<t.length;++r){var a=t.charCodeAt(r);if(a<48||57<a)return O;e=10*e+a-48}return r==i?O:I(45==n?-e:e)},Qn=r(function(t,e,n,i,r){var a,s;return""===r||f(Kn,"@",r)?O:(a=f(Xn,":",r)).b?a.b.b||1===(s=Zn(f(zn,(a=a.a)+1,r))).$?O:(s=s,I(B(Un,t,f(Yn,a,r),s,e,n,i))):I(B(Un,t,r,O,e,n,i))}),ti=h(function(t,e,n,i){var r;return""===i?O:(r=f(Xn,"/",i)).b?u(Qn,t,f(zn,r=r.a,i),e,n,f(Yn,r,i)):u(Qn,t,"/",e,n,i)}),ei=d(function(t,e,n){var i;return""===n?O:(i=f(Xn,"?",n)).b?m(ti,t,I(f(zn,(i=i.a)+1,n)),e,f(Yn,i,n)):m(ti,t,O,e,n)}),ni=c(function(t,e){var n;return""===e?O:(n=f(Xn,"#",e)).b?p(ei,t,I(f(zn,(n=n.a)+1,e)),f(Yn,n,e)):p(ei,t,O,e)}),ii=ut,ri=function(t){return f(ii,"http://",t)?f(ni,0,f(zn,7,t)):f(ii,"https://",t)?f(ni,1,f(zn,8,t)):O},ai=function(t){for(;;)0},W=Tt,H=W(0),si=h(function(t,e,n,i){var r,a,s,o;return i.b?(r=i.a,(i=i.b).b?(a=i.a,(i=i.b).b?(s=i.a,(i=i.b).b?(o=i.b,f(t,r,f(t,a,f(t,s,f(t,i.a,500<n?p(vn,t,e,En(o)):m(si,t,e,n+1,o)))))):f(t,r,f(t,a,f(t,s,e)))):f(t,r,f(t,a,e))):f(t,r,e)):e}),oi=d(function(t,e,n){return m(si,t,e,0,n)}),k=c(function(n,t){return p(oi,c(function(t,e){return f(T,n(t),e)}),C,t)}),R=At,li=c(function(e,t){return f(R,function(t){return W(e(t))},t)}),hi=d(function(n,t,i){return f(R,function(e){return f(R,function(t){return W(f(n,e,t))},i)},t)}),ui=Lt,ci=c(function(t,e){return Pt(f(R,ui(t),e))}),tt=d(function(t,e,n){return f(li,function(t){return 0},Me(f(k,ci(t),e)))}),di=(E.Task={b:H,c:tt,d:d(function(t,e,n){return W(0)}),e:c(function(t,e){return f(li,t,e)}),f:void 0},$t("Task")),fi=c(function(t,e){return di(f(li,t,e))}),z=function(e){function n(){n.a(t(Pe()))}var t=e.bh,r=e.bi;return Ae({ag:function(i){return n.a=i,We.addEventListener("popstate",n),~We.navigator.userAgent.indexOf("Trident")&&We.addEventListener("hashchange",n),c(function(t,e){var n;e.ctrlKey||e.metaKey||e.shiftKey||1<=e.button||t.target||t.hasAttribute("download")||(e.preventDefault(),e=t.href,t=Pe(),n=ri(e).a,i(r(n&&t.aN===n.aN&&t.aB===n.aB&&t.aJ.a===n.aJ.a?{$:0,a:n}:{$:1,a:e})))})},be:function(t){return p(e.be,t,Pe(),n)},bo:e.bo,bn:e.bn,bm:e.bm})},pi=c(function(t,e){return{$:0,a:t,b:e}}),it=d(function(t,e,n){return f(t,n,e)}),mi={$:-2},gi=mi,L=r(function(t,e,n,i,r){return{$:-1,a:t,b:e,c:n,d:i,e:r}}),vi=r(function(t,e,n,i,r){var a,s,o,l;return-1!==r.$||r.a?-1!==i.$||i.a||-1!==i.d.$||i.d.a?u(L,t,e,n,i,r):(a=i.d,l=i.e,u(L,0,i.b,i.c,u(L,1,a.b,a.c,a.d,a.e),u(L,1,e,n,l,r))):(a=r.b,s=r.c,o=r.d,r=r.e,-1!==i.$||i.a?u(L,t,a,s,u(L,0,e,n,i,o),r):u(L,0,e,n,u(L,1,i.b,i.c,i.d,l=i.e),u(L,1,a,s,o,r)))}),bi=q,Ci=d(function(t,e,n){if(-2===n.$)return u(L,0,t,e,mi,mi);var i=n.a,r=n.b,a=n.c,s=n.d,o=n.e;switch(f(bi,t,r)){case 0:return u(vi,i,r,a,p(Ci,t,e,s),o);case 1:return u(L,i,r,e,s,o);default:return u(vi,i,r,a,s,p(Ci,t,e,o))}}),Si=d(function(t,e,n){t=p(Ci,t,e,n);return-1!==t.$||t.a?t:u(L,1,t.b,t.c,t.d,t.e)}),yi=c(function(t,e){return{a:t,b:e}}),wi=ot,X=Ge(f(yn,it(yi),qe("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"))),Ei=c(function(t,e){for(;;){if(-2===e.$)return O;var n=e.c,i=e.d,r=e.e;switch(f(bi,t,e.b)){case 0:t=t,e=i;continue;case 1:return I(n);default:t=t,e=r;continue}}}),_i=f(it,Ei,X),Ti=f(vn,c(function(t,e){return(e<<1)+(t?1:0)}),0),Ai=c(function(t,e){return e.b?p(oi,T,e,t):t}),xi=c(function(t,e){for(;;){if(t<=0)return e;if(!e.b)return e;t=t-1,e=e.b}}),Ii=nt,Pi=d(function(t,e,n){for(;;){if(e<=0)return t;t=f(T,n,t),e=e-1,n=n}}),Ni=c(function(t,e){return p(Pi,C,t,e)}),Oi=d(function(t,e,n){for(;;){if(!n)return b(f(Ni,e,!1),t);t=f(T,1===f(Ii,2,n),t),e=e-1,n=n/2|0}}),Fi=c(function(t,e){return e.$?A(t):x(e.a)}),Wi=c(function(t,e){return e.$?A(e.a):x(t(e.a))}),ki=c(function(t,e){return e.$?O:I(t(e.a))}),Ri=function(t){var e;return t.b?t.a.$?O:(e=t.b,f(ki,T(t.a.a),Ri(e))):I(C)},Li={$:0},Di=d(function(t,e,n){return{Z:n,T:e,aG:t}}),$i=f(pi,0,C),Vi=_t,ji=_t,Bi=c(function(t,e){return p(vn,(n=>c(function(t,e){return e.push(n(t)),e}))(t),[],e)}),Mi=Ut("reinitialize_",function(t){var e=t.b;return f(Bi,qn,S([ji(t.a),Bi(Vi)(e)]))}),Gi=d(function(t,e,n){return{a:{w:0,K:O,C:O,D:C,F:t,V:I(p(Di,n,$i,0)),N:O,u:0,i:n,O:!1,A:gi,p:e,H:Li},b:Mi({a:(t=n).a,b:t.b})}}),rt={al:O,a5:O,bl:gi,aZ:O,Y:C},o=d(function(t,e,n){return e(t(n))}),qi=d(function(t,e,n){return{am:n,ay:e,aP:t}}),Ui=d(function(t,e,n){return 1===e.$||1===n.$?O:I(f(t,e.a,n.a))}),Ki=h(function(t,e,n,i){return 1===e.$||1===n.$||1===i.$?O:I(p(t,e.a,n.a,i.a))}),Y=c(function(t,e){t:for(;;){if(!t.a.b)break;if(t.a.b.b){var n,i,r;if("speaker"===t.a.a&&!t.a.b.b.b&&t.b.b)return n=t.a.b.a,i=(r=t.b).b,(r=(t=>{var e,n,i,r,a,s,o;return(t=qe(t)).b&&t.b.b&&t.b.b.b&&t.b.b.b.b&&t.b.b.b.b.b&&t.b.b.b.b.b.b&&!t.b.b.b.b.b.b.b?(e=t.a,n=(t=t.b).a,i=(t=t.b).a,r=(t=t.b).a,o=(t=t.b).a,t=t.b.a,a=function(t){switch(t){case"0":return I(0);case"1":return I(1);case"2":return I(2);case"3":return I(3);case"4":return I(4);case"5":return I(5);case"6":return I(6);case"7":return I(7);case"8":return I(8);case"9":return I(9);case"a":return I(10);case"b":return I(11);case"c":return I(12);case"d":return I(13);case"e":return I(14);case"f":return I(15);default:return O}},o=f(s=c(function(t,e){return p(Ui,c(function(t,e){return 16*t+e}),a(t),a(e))}),o,t),t=f(s,i,r),m(Ki,qi,f(s,e,n),t,o)):O})(r.a)).$?e:(r=r.a,v(e,{bl:p(Si,n,{a:f(gn," ",i),b:r},e.bl)}));break}switch(t.a.a){case"title":return v(e,{aZ:I(f(gn," ",t.b))});case"author":return v(e,{a5:I(f(gn," ",t.b))});case"aspect-ratio":var a,s;if(t.b.b&&t.b.b.b&&!t.b.b.b.b)return a=(s=t.b).b.a,(s={a:Zn(s.a),b:Zn(a)}).a.$||s.b.$?e:v(e,{al:I({a:s.a.a,b:s.b.a})});break t;default:break t}}return v(e,{Y:f(T,t,e.Y)})}),Hi=d(function(t,e,n){return t(e(n))}),Ji=c(function(n,t){return p(oi,c(function(t,e){return n(t)?f(T,t,e):e}),C,t)}),zi=function(t){return!t},Xi=function(t){return J(t).join("")},Yi=function(t){for(var e=t.length,n=Array(e),i=0;i<e;){var r=t.charCodeAt(i);r<55296||56319<r?n[e-i]=t[i]:(n[e-i]=t[i+1],n[e-++i]=t[i-1]),i++}return n.join("")},Zi=c(function(r,t){return f(c(function(t,e){for(;;){if(!e.b)return{a:Yi(Xi(t)),b:""};var n=e.a,i=e.b;if(l(n,r))return{a:Yi(Xi(t)),b:Xi(i)};t=f(T,n,t),e=i}}),C,qe(t))}),Qi=function(t){return t.toLowerCase()},tr=function(t){return S(t.trim().split(/\s+/g))},er=function(t){var e=f(o,tr,Ji(f(Hi,zi,Be))),t=f(Zi,":",t),n=t.b;return{a:f(k,Qi,e(t.a)),b:e(n)}},nr=f(o,k(er),f(oi,Y,rt)),D=c(function(t,e){return e.$?t:e.a}),ir=c(function(t,e){return e.$?t:e.a}),vt=d(function(t,e,n){return p(Gi,n,nr(t),f(ir,$i,Ke(f(D,"",e.L))))}),rr=function(t){return{$:3,b:t}},ar={$:0},sr=pt,or={$:7},lr=Vt,hr=c(function(t,e){return{$:0,a:t,b:e}}),ur=c(function(t,e){return{aM:e,aY:t}}),t=W(f(ur,gi,gi)),cr=c(function(t,e){var n=t.a,t=t.b,i=f(Ei,n,e);return p(Si,n,1===i.$?S([t]):f(T,t,i.a),e)}),dr=function(n){return{$:2,b:function(t){var e=n.f;2===e.$&&e.c&&e.c(),n.f=null,t({$:0,a:U})},c:null}},fr=d(function(t,e,n){for(;;){if(-2===n.$)return e;var i=n.e,r=t,a=p(t,n.b,n.c,p(fr,t,e,n.d));t=r,e=a,n=i}}),pr=a(function(l,h,u,t,e,n){t=p(fr,d(function(t,e,n){for(;;){var i=n.a,r=n.b;if(!i.b)return{a:i,b:p(u,t,e,r)};var a=i.a,s=a.a,a=a.b,o=i.b;if(0<=g(s,t))return 0<g(s,t)?{a:i,b:p(u,t,e,r)}:{a:o,b:m(h,s,a,e,r)};t=t,e=e,n={a:o,b:p(l,s,a,r)}}}),{a:hn(t),b:n},e),n=t.a,e=t.b;return p(vn,c(function(t,e){return p(l,t.a,t.b,e)}),e,n)}),mr=Dt,gr=Oe,vr=Pt,br=d(function(e,t,n){var i,r;return t.b?(r=t.b,t=vr(f(gr,i=t.a,f(mr,e,i))),f(R,function(t){return p(br,e,r,p(Si,i,t,n))},t)):W(n)}),ht=d(function(e,t,n){var n=n.aM,i=d(function(t,e,n){var i=n.c;return{a:n.a,b:n.b,c:f(R,function(t){return i},dr(e))}}),r=p(vn,cr,gi,t),t=B(pr,d(function(t,e,n){var i=n.b,r=n.c;return{a:f(T,t,n.a),b:i,c:r}}),h(function(t,e,n,i){var r=i.c;return{a:i.a,b:p(Si,t,n,i.b),c:r}}),i,r,n,{a:C,b:gi,c:W(0)}),a=t.a,s=t.b;return f(R,function(t){return W(f(ur,r,t))},f(R,function(t){return p(br,e,a,s)},t.c))}),Cr=(en=qn,{$:2,b:function(t){t({$:0,a:en(Date.now())})},c:null}),ct=d(function(n,t,e){var i,t=f(Ei,t,e.aY);return 1===t.$?W(e):(i=t.a,f(R,function(t){return W(e)},f(R,function(e){return Me(f(k,function(t){return f(ui,n,t(e))},i))},Cr)))}),ut=c(function(t,e){return f(hr,e.a,f(Hi,t,e.b))}),Sr=(E.Time={b:t,c:ht,d:ct,e:0,f:ut},$t("Time")),yr=c(function(t,e){return Sr(f(hr,t,e))}),wr={$:1},Er=c(function(t,e){return t}),_r=mt,Tr=f(_r,"keyCode",dt),Ar=gt,xr=ft,tt=(Lt="lineAvailableRaw",H=f(Ar,function(i){return f(Ar,function(n){return f(Ar,function(e){return f(Ar,function(t){return Mn({_:t,M:e,ad:n,P:i})},f(_r,"choices",rr(sr)))},f(_r,"line",sr))},f(_r,"nextLineAvailable",xr))},f(_r,"tags",rr(sr))),qt(Lt),E[Lt]={f:zt,u:H,a:Xt},$t(Lt)),Ir={$:2},Pr=function(t){return{$:4,a:t}},Nr=function(t){return{$:1,a:t}},Or={$:6},Fr=function(t){return{$:3,a:t}},Wr={$:7},kr=function(t){return{$:5,a:t}},Rr=r(function(t,e,n,i,r){return{$:2,a:t,b:e,c:n,d:i,e:r}}),Lr=function(t){return{$:0,a:t}},Dr=function(t){t:for(;;){if(!t.a.b)break;if(t.a.b.b){if("img"!==t.a.a||t.a.b.b.b)break;var e,n,i,r,a;if(t.b.b){if(t.b.b.b){if(t.b.b.b.b&&t.b.b.b.b.b&&!t.b.b.b.b.b.b)return e=t.a.b.a,a=(r=t.b).a,n=(i=(r=r.b).b).a,i=i.b.a,(r={a:Zn(r.a),b:Zn(n),c:Zn(i)}).a.$||r.b.$||r.c.$?Lr(t):u(Rr,e,a,r.a.a,r.b.a,r.c.a);break}if("bg"===t.a.b.a)return Nr(a=t.b.a);break}return Fr(e=t.a.b.a)}if(t.b.b){if(t.b.b.b)break;switch(t.a.a){case"audio":return Pr(t.b.a);case"speaker":return kr(t.b.a);default:break t}}else switch(t.a.a){case"restart":return Wr;case"speaker":return Or;default:break t}}return Lr(t)},$r=f(f(Hi,o,o),Xe,tt);function Vr(){return f(o,k(tn),Qe)}function jr(t){return t.b}function Br(t){return f(Xr,t.D,t.u)}function Mr(t){return{a:b(t.a?"w_":"d_",t.b),b:t}}function Gr(t){var e=t.a,t=t.b,e=p(Oi,C,9,f(fa,f(pa,2,9)-1,e)),n=(t=f(da,6,t)).a,t=t.b,i=f(Ii,6,6-Le(n)),e=b(p(Oi,C,3,i),e),i=i?f(T,b(f(Ni,i,!1),n),t):t,n=b(f(da,6,e).b,i);return Xi(f(k,f(o,Ti,ca),n))}function qr(t){return f(pi,t.a+1,t.b)}function Ur(t){return An(f(xn,2,t))}function e(t){return p($,!1,t.b,t)}function Kr(e){return function(t){return u(Fa,e,t.b,t.aS,t.ap,t)}}function Hr(t){return Va(f(ka,t,{$:8,a:t}))}function Jr(t){return(i=>function(t){var e,n=p(Oa,i.X,t.b,t.a);return l(n,-1)||(n=l(n,-2)?M(Ga,i.U,t.b+1,t.aS+1,1,t.a,t.c,t.aq):M(Ga,i.U,n,t.aS,t.ap+1,t.a,t.c,t.aq),f(Ma,e=p(Jn,t.b,n.b,t.a),i.W))?f(_a,!1,f(Da,t,i.av)):p($,!0,e,n)})({av:ja,U:t.U,W:t.W,X:t.X})}var zr=Vr(),Xr=(Vr=function(){return zr},c(function(t,e){return-1<g(e,zr(f(D,S([{$:0,a:""}]),f(ki,f(o,jr,function(t){return t.aj}),Ze(t)))))})),Yr=lr(C),Zr=d(function(t,e,n){return{$:0,a:t,b:e,c:n}}),Qr=c(function(t,e){return{aI:e,aX:t}}),q=W(f(Qr,C,gi)),ta=c(function(t,e){return{au:e,F:t}}),ea=d(function(e,n,t){return f(li,function(t){return{a:n,b:t}},p(ke,t.a?We:Fe,t.b,function(t){return f(mr,e,f(ta,n,t))}))}),na=c(function(t,e){return p(fr,Si,e,t)}),ot=d(function(r,t,e){var n=d(function(t,e,n){var i=n.c;return{a:n.a,b:n.b,c:f(T,p(ea,r,t,e),i)}}),i=d(function(t,e,n){var i=n.b,r=n.c;return{a:f(T,e,n.a),b:i,c:r}}),a=h(function(t,e,n,i){var r=i.c;return{a:i.a,b:p(Si,t,e,i.b),c:r}}),s=f(k,Mr,t),t=B(pr,i,a,n,e.aI,Ge(s),{a:C,b:gi,c:C}),o=t.b,l=t.c;return f(R,function(t){return W(f(Qr,s,f(na,o,Ge(t))))},f(R,function(t){return Me(l)},Me(f(k,dr,t.a))))}),ia=d(function(t,e,n){t=t(e);return t.$?n:f(T,t.a,n)}),ra=c(function(t,e){return p(oi,ia(t),C,e)}),X=d(function(t,e,n){var i=e.F,r=e.au,e=f(ra,function(t){var e=t.b,e=e.c;return l(t.a,i)?f(Re,e,r):O},n.aX);return f(R,function(t){return W(n)},Me(f(k,ui(t),e)))}),aa=(E["Browser.Events"]={b:q,c:ot,d:X,e:0,f:c(function(t,e){return p(Zr,e.a,e.b,f(Bn,t,e.c))})},$t("Browser.Events")),sa=f(d(function(t,e,n){return aa(p(Zr,t,e,n))}),0,"keypress"),oa=Vt,nt=d(function(t,e,n){for(;;){var i=f(Rn,32,t),r=i.a,i=i.b;if(g(Wn(r),32)<0)return f($n,!0,{f:e,d:n,e:r});t=i,e=f(T,{$:1,a:r},e),n=n+1}}),rt=(Y=qe("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/")).b?p(nt,Y,C,0):Pn,la=4294967295>>>32-In,ha=Z,ua=d(function(t,e,n){for(;;){var i=f(ha,la&e>>>t,n);if(i.$)return f(ha,la&e,i.a);t=t-In,e=e,n=i.a}}),ca=f(o,f(it,c(function(t,e){var n=e.a,i=e.b,r=e.c,e=e.d;return t<0||-1<g(t,n)?O:-1<g(t,n>>>5<<5)?I(f(ha,la&t,e)):I(p(ua,i,t,r))}),rt),D("/")),da=c(function(t,e){var n,i;return e.b?(n=e.a,i=(e=f(da,t,e.b)).b,l(Le(e=e.a),t-1)?{a:C,b:f(T,f(T,n,e),i)}:{a:f(T,n,e),b:i}):{a:C,b:C}}),fa=c(function(t,e){return g(t,e)<0?t:e}),pa=et,ma=Ne,ga=d(function(t,e,n){return{at:n,ah:e,aj:t}}),va=c(function(t,e){return e.$?O:t(e.a)}),ba=function(e){return f(fi,ai,{$:2,b:function(t){try{We.location=e}catch(t){Yt.location.reload(!1)}},c:null})},Ca=Ut("makeChoice",ji),Sa=d(function(t,e,n){var i=n.a,n=n.b,e=p(Oi,C,Ur(t),e);return 1===t?f(pi,i+1,n):f(pi,0,b(e,n))}),ya=c(function(t,e){for(;;){if(!e.b)return!1;var n=e.b;if(t(e.a))return!0;t=t,e=n}}),wa=c(function(e,t){return f(ya,function(t){return l(t,e)},t)}),Ea=oa(C),_a=c(function(t,e){return{$:1,a:t,b:e}}),$=d(function(t,e,n){return{$:0,a:t,b:e,c:n}}),Ta=d(function(a,t,e){var s=t,o=e;return function(t){var e,n,i,r,t=s(t);return 1===t.$?f(_a,t.a,t.b):(e=t.a,n=t.b,1===(t=o(t.c)).$?(i=t.a,f(_a,e||i,t.b)):(i=t.a,r=t.c,p($,e||i,f(a,n,t.b),r)))}}),n=c(function(t,e){return p(Ta,On,t,e)}),Aa={$:0},xa=c(function(t,e){return{$:2,a:t,b:e}}),Ia=d(function(t,e,n){for(;;){if(!n.b)return f(_a,!1,e);var i,r=n.a,a=n.b,r=r(t);if(!r.$)return i=r;if((i=r).a)return i;t=t,e=f(xa,e,i.b),n=a}}),Pa=function(e){return function(t){return p(Ia,t,Aa,e)}},pt=h(function(t,e,n,i){return{$:0,a:t,b:e,c:n,d:i}}),Dt=function(t){var e=t;return function(t){t=e(t);return 1===t.$?f(_a,!1,t.b):p($,!1,t.b,t.c)}},Oe=gi,Na=c(function(t,e){return t}),t=c(function(t,e){return p(Ta,Na,t,e)}),ht=c(function(n,t){var i=t;return function(t){var e,t=i(t);return t.$?f(_a,t.a,t.b):(e=t.c,p($,t.a,n(t.b),e))}}),Oa=rn,Fa=r(function(t,e,n,i,r){for(;;){var a=p(Oa,t,e,r.a);if(l(a,-1))return p($,g(r.b,e)<0,0,{ap:i,aq:r.aq,c:r.c,b:e,aS:n,a:r.a});r=(i=l(a,-2)?(t=t,e=e+1,n=n+1,1):(t=t,e=a,n=n,i+1),r)}}),ct=Kr(function(t){return" "===t||"\n"===t||"\r"===t}),Wa=function(e){return function(t){return p($,!1,e,t)}},ka=c(function(t,e){return{$:0,a:t,b:e}}),Ra=c(function(t,e){return{$:1,a:t,b:e}}),La=h(function(t,e,n,i){return{ap:e,a8:i,aK:n,aS:t}}),Da=c(function(t,e){return f(Ra,Aa,m(La,t.aS,t.ap,e,t.aq))}),$a=nn,Va=function(t){var r=t.a,a=t.b,s=!(""===r);return function(t){var e=u($a,r,t.b,t.aS,t.ap,t.a),n=e.a,i=e.b,e=e.c;return l(n,-1)?f(_a,!1,f(Da,t,a)):p($,s,0,{ap:e,aq:t.aq,c:t.c,b:n,aS:i,a:t.a})}},ja={$:7},Ba=c(function(t,e){return!f(Ei,t,e).$}),Ma=c(function(t,e){return f(Ba,t,e)}),Ga=s(function(t,e,n,i,r,a,s){for(;;){var o=p(Oa,t,e,r);if(l(o,-1))return{ap:i,aq:s,c:a,b:e,aS:n,a:r};s=(a=(r=(i=l(o,-2)?(t=t,e=e+1,n=n+1,1):(t=t,e=o,n=n,i+1),r),a),s)}}),ut=f(n,f(n,f(n,Wa(pt(5)),e),f(t,Dt(f(ht,I,Jr({U:Ve,W:Oe,X:Ve}))),Hr(":"))),f(t,e,ct)),qa=function(e){return function(t){return e(0)(t)}},mt={$:11},dt=c(function(n,i){return function(t){var e=p(Oa,n,t.b,t.a);return l(e,-1)?f(_a,!1,f(Da,t,i)):l(e,-2)?p($,!0,0,{ap:1,aq:t.aq,c:t.c,b:t.b+1,aS:t.aS+1,a:t.a}):p($,!0,0,{ap:t.ap+1,aq:t.aq,c:t.c,b:e,aS:t.aS,a:t.a})}}),gt=Kr,Ua=c(function(i,t){var r=t;return function(t){var e,n=r(t);return 1===n.$?f(_a,n.a,n.b):(e=n.b,p($,n.a,f(i,p(Jn,t.b,(n=n.c).b,t.a),e),n))}}),ft=function(t){return f(Ua,Na,t)},Ka=S(["<",'"',"&"]),zt=f(n,f(n,f(n,Wa(pt(3)),e),f(ht,I,ft(f(t,f(dt,function(t){return!0},mt),gt(function(t){return!f(wa,t,Ka)}))))),e),H=f(n,f(n,f(n,Wa(pt(4)),f(t,e,Dt(Hr("&")))),f(t,Dt(f(ht,I,Jr({U:Ve,W:Oe,X:Ve}))),Hr(";"))),e),Lt=f(n,f(n,f(n,Wa(pt(1)),f(t,e,Dt(Hr("</")))),f(t,Dt(f(ht,I,Jr({U:Ve,W:Oe,X:Ve}))),Hr(">"))),e),tt=f(n,f(n,f(n,Wa(pt(0)),f(t,e,Dt(Hr("<")))),f(t,Dt(f(ht,I,Jr({U:Ve,W:Oe,X:Ve}))),Hr(">"))),e),q=f(n,f(n,f(n,Wa(pt(2)),f(t,e,Hr('"'))),Wa(O)),e),Ha=Pa(S([Lt,tt,q,H,zt]));function Ja(){return Pa(S([f(n,f(n,Wa(T),Ha),qa(function(t){return Ja()})),Wa(C)]))}function za(t){return p(rs,t.aS,t.ap,t.aK)}function Xa(t){return{$:4,a:t}}function Ya(n){return c(function(t,e){return f(ls,!1,S([f(ws,n,t)]))})}function Za(t){return{$:1,a:t}}function Qa(t){return{$:2,a:t}}function ts(t){return{$:3,a:t}}function es(t){switch(t){case 0:return Za;case 1:return Qa;default:return ts}}function ns(e){return f(us,function(t){return f(Cs,Ss(t),f(us,qn,f(ms,As(1),f(ms,e,cs(_s(t))))))},As(0))}var is=Ja(),ot=(Ja=function(){return is},Pa(S([f(n,f(n,Wa(T),ut),is),is]))),rs=d(function(t,e,n){return{ap:e,aK:n,aS:t}}),as=c(function(t,e){for(;;)switch(t.$){case 0:return e;case 1:var n=t.a,i=t.b;t=n,e=f(T,i,e);continue;default:n=t.a,i=t.b;t=n,e=f(as,i,e);continue}}),ss=c(function(t,e){t=t({ap:1,aq:C,c:1,b:0,aS:1,a:e});return t.$?A(f(as,t.b,C)):x(t.b)}),os=f(o,c(function(t,e){t=f(ss,t,e);return t.$?A(f(k,za,t.a)):x(t.a)})(ot),ir(C)),ls=c(function(t,e){return{$:1,a:t,b:e}}),hs=d(function(t,e,n){return{$:0,a:t,b:e,c:n}}),us=c(function(a,t){var s=t;return c(function(t,e){var n,i,r,e=f(s,t,e);return e.$?f(ls,e.a,e.b):(n=e.a,i=e.c,1===(e=f(a(e.b),t,i)).$?(r=e.a,f(ls,n||r,e.b)):(r=e.a,p(hs,n||r,e.b,e.c)))})}),cs=function(n){return c(function(t,e){return p(hs,!1,n,e)})},ds=c(function(t,e){return f(us,f(o,t,cs),e)}),fs=f(oi,c(function(t,e){var r=t,a=e;return c(function(t,e){var n,i=f(r,t,e);return 1===i.$?i.a?f(ls,!0,n=i.b):(n=i.b,1===(t=f(a,t,e)).$?t.a?f(ls,!0,t.b):f(ls,!1,b(n,t.b)):t):i})}),c(function(t,e){return f(ls,!1,C)})),ps=function(n){return c(function(t,e){return f(n(0),t,e)})},ms=it(c(function(t,e){return f(us,function(t){return f(ds,On(t),e)},t)})),gs=function(e){return fs(S([f(ms,ps(function(t){return gs(e)}),f(ms,e,cs(T))),cs(C)]))},vs=d(function(t,e,n){return f(ms,n,f(ds,t,e))}),bs=c(function(t,e){return p(vs,Er,e,t)}),Cs=c(function(t,e){return f(o,T(t),e)}),Ss=function(t){return{$:0,a:t}},ys=c(function(t,e){return{$:1,a:t,b:e}}),ws=c(function(t,e){return{aq:e,aK:t}}),Es=Ge(S([{a:"b",b:0},{a:"i",b:1},{a:"samp",b:2}])),_s=d(function(t,e,n){var i=t.c;return l(i,n.c)?1===(i=f(Ei,f(D,"",i),Es)).$?Ya({$:2,a:t}):cs(f(es,i.a,e)):Ya(f(ys,t,n))}),Ts=c(function(t,e){return{$:0,a:t,b:e}}),As=function(i){return c(function(t,e){var n;return e.b?(n=e.b,l(i,(e=e.a).a)?p(hs,!0,e,n):f(ls,!1,S([f(ws,f(Ts,i,I(e)),t)]))):f(ls,!1,S([f(ws,f(Ts,i,O),t)]))})},xs=Ge(S([{a:"amp",b:"&"},{a:"lt",b:"<"},{a:"gt",b:">"},{a:"quot",b:'"'}])),X=p(On,us,function(t){var e=f(Ei,f(D,"",t.c),xs);return e.$?Ya({$:3,a:t}):cs(e.a)},As(4)),Is=f(ds,Ye,fs(S([f(ds,function(t){return f(D,"",t.c)},As(3)),X])));function Ps(){return fs(S([ns(Ns()),Is]))}function Ns(){return ps(function(t){return gs(Ps())})}var Os=Ps(),Fs=(Ps=function(){return Os},Ns()),Ws=(Ns=function(){return Fs},f(us,function(t){return f(Cs,{$:1,a:t},f(bs,As(2),f(ds,Xa,Fs)))},As(2)));function ks(){return fs(S([ns(Rs()),Ws,Is]))}function Rs(){return ps(function(t){return gs(ks())})}function Ls(t){var e;return(t=f(zs,C,os(t))).$?A((e=t.b).b?ro(e.a):Xs("Parse completed with an error, but no dead ends!  spooky...")):x(t.b)}function Ds(t){switch(t){case 0:return"bold";case 1:return"italic";default:return"monospaced (samp)"}}function $s(t){return f(D,t,f(ki,Ds,f(Ei,t,Es)))}function Vs(t){var e,n,i,r,a,s,o,l;return-1===t.$&&-1===t.d.$&&-1===t.e.$?-1!==t.e.d.$||t.e.d.a?(i=(l=t.e).b,r=l.c,a=l.d,l=l.e,u(L,1,t.b,t.c,u(L,0,(e=t.d).b,e.c,e.d,e.e),u(L,0,i,r,a,l))):(i=(n=t.e).b,r=n.c,s=(a=n.d).d,o=a.e,l=n.e,u(L,0,a.b,a.c,u(L,1,t.b,t.c,u(L,0,(e=t.d).b,e.c,e.d,e.e),s),u(L,1,i,r,o,l))):t}function js(t){var e,n,i,r,a,s,o,l,h;return-1===t.$&&-1===t.d.$&&-1===t.e.$?-1!==t.d.d.$||t.d.d.a?(s=(h=t.e).b,o=h.c,l=h.d,h=h.e,u(L,1,e=t.b,n=t.c,u(L,0,(r=t.d).b,r.c,r.d,r=r.e),u(L,0,s,o,l,h))):(e=t.b,n=t.c,r=(i=t.d).e,s=(a=t.e).b,o=a.c,l=a.d,h=a.e,u(L,0,i.b,i.c,u(L,1,(a=i.d).b,a.c,a.d,a.e),u(L,1,e,n,r,u(L,0,s,o,l,h)))):t}function Bs(t){var e,n,i,r,a,s;return-1===t.$&&-1===t.d.$?(e=t.a,n=t.b,i=t.c,s=(r=t.d).d,a=t.e,1===r.a?-1!==s.$||s.a?-1===(s=Vs(t)).$?(t=s.e,u(vi,s.a,s.b,s.c,Bs(s.d),t)):mi:u(L,e,n,i,Bs(r),a):u(L,e,n,i,Bs(r),a)):mi}function Ms(t){return te((t=>ae.test(t)?"p":t)(t))}function Gs(t){return Vo(f(gn," ",f(k,je,f(Ji,jr,t))))}function qs(t){var e=t.ay,n=t.am;return no(S(["rgb(",mn(t.aP),",",mn(e),",",mn(n),")"]))}function Us(t){return f(Uo,"click",Mn(t))}function Ks(t){switch(t.$){case 0:return!1;case 1:case 2:case 3:var e=t.a;return Ko()(e);default:return!0}}var Hs=ks(),Js=(ks=function(){return Hs},Rs()),zs=(Rs=function(){return Js},fs(S([f(ms,Js,f(ds,function(t){return yi(f(ki,Qi,t.c))},As(5))),f(ds,yi(O),Js)]))),Xs=function(t){return{$:5,a:t}},Ys=c(function(t,e){return{$:2,a:t,b:e}}),Zs=c(function(t,e){return{$:0,a:t,b:e}}),Qs=c(function(t,e){return{$:1,a:t,b:e}}),to=function(t){return{$:4,a:t}},eo=function(t){return{$:3,a:t}},no=function(t){return f(gn,"",t)},io=function(t){switch(t){case 0:return"opening tag";case 1:return"closing tag";case 2:return'quotation mark (")';case 3:return"line of unformatted text";case 4:return"character entity";default:return"speaker tag"}},ro=function(t){var e=t.aK,n=t.aq;switch(e.$){case 1:return f(Ys,e.a,e.b);case 2:return eo(e.a);case 3:return to(e.a);default:switch(e.a){case 2:var i=e.b;return n.b&&1===n.a.$?f(Zs,n.a.a,i):Xs("We expected a closing quote, but it never seems to have been opened!");case 1:i=e.b;return n.b&&!n.a.$?f(Qs,n.a.a,i):Xs("We expected a closing tag, but it never seems to have been opened!");default:i=e.b;return Xs(no(S(["We expected a ",io(e.a)," but we got ",1===i.$?"the end of the file":"a "+io(i.a.a),"."])))}}},ao=Ut("requestNextLine_",function(t){return null})(0),so=d(function(t,e,n){for(;;){if(t<=0)return n;if(!e.b)return n;var i=e.a;t=t-1,e=e.b,n=f(T,i,n)}}),oo=c(function(t,e){return En(p(so,t,e,C))}),lo=d(function(t,e,n){if(0<e){var i,r,a,s,o,l={a:e,b:n};t:for(;;){e:for(;;){if(!l.b.b)return n;if(!l.b.b.b){if(1===l.a)break t;break}switch(l.a){case 1:break t;case 2:var h=l.b;return S([h.a,h.b.a]);case 3:if(l.b.b.b.b)return S([(h=l.b).a,(i=h.b).a,i.b.a]);break e;default:if(l.b.b.b.b&&l.b.b.b.b.b)return o=(s=(a=(r=(i=l.b).b).b).b).b,f(T,i.a,f(T,r.a,f(T,a.a,f(T,s.a,1e3<t?f(oo,e-4,o):p(lo,t+1,e-4,o)))));break e}}return n}return S([l.b.a])}return C}),ho=c(function(t,e){return p(lo,0,t,e)}),uo=d(function(t,e,n){var n=n.b,e=Ur(e),i=t+e,t=Le(n)-t-e,e=Ti(f(ho,e,f(xi,t,n)));return 0<g(i,Le(n))?O:I({a:e,b:i})}),co=c(function(t,n){var i=t.aW,r=n.aG,a=n.T,s=n.Z;return f(yi,a,(()=>{switch(i.$){case 0:return I(v(n,{T:qr(a)}));case 1:var e=Le(i.a);return f(ki,function(t){return v(n,{Z:t.b,T:p(Sa,e,t.a,a)})},p(uo,s,e,r));default:return O}})())}),fo=c(function(t,e){return p(Jn,e.b,e.d,t)}),po=c(function(t,e){return Ue(f(k,t,e))}),V=d(function(t,e,n){var i=n.b,n=n.d,r=Hn(e),a=p(Jn,i,n,e),s=0<g(i,t+3),s=b(s?"\n\n...":"\n\n",p(Jn,s?i-t:0,i,e)),i=g(n+t+3,r)<0,n=b(p(Jn,n,i?n+t:r,e),i?"...\n\n":"\n\n");return{$:3,a:S([{$:0,a:s},{$:1,a:S([{$:0,a:a}])},{$:0,a:n}])}}),mo=c(function(s,o){return f(T,{$:1,a:S([{$:0,a:"Something went wrong while trying to parse this line of dialog.  "}])},(()=>{switch(o.$){case 0:return 1===o.b.$?S([{$:0,a:'It looks like you opened a quote (") but forgot to close it!  In particular, I saw this quotation mark, which I interpretted as the start of a quote:'},p(V,10,s,o.a),{$:0,a:"But I don't see another quotation mark for the rest of the line, so I can never close it.  If you meant for this to be a quote, then consider adding a second quotation mark to close that first one.  But if you don't actually want a quote here, try replacing that first quotation mark with the text "},{$:3,a:S([{$:0,a:"&quot;"}])},{$:0,a:", which I'll replace with a normal quotation mark when I render the line, but I won't count it when I'm looking for quotes."}]):1!==o.b.a.a||o.b.a.c.$?(a=o.b.a,S([{$:0,a:'It looks like you opened a quote (") but forgot to close it!  In particular, I saw this quotation mark, which I interpretted as the start of a quote:'},p(V,10,s,o.a),{$:0,a:"But before I see a closing quote, I see this:"},p(V,10,s,a),{$:0,a:"To be honest, I'm not sure why this caused a problem.  Actually, this branch of code was expected to never execute.  Maybe post an issue on the GitHub, or reach out to Ember to report it.  He/it would appreciate it!"}])):(i=o.b.a,e=i.c.a,S([{$:0,a:'It looks like you opened a quote (") but forgot to close it!  In particular, I saw this quotation mark, which I interpretted as the start of a quote:'},p(V,10,s,o.a),{$:0,a:"But before I see a closing quote, I see a closing tag for a "},{$:0,a:$s(e)},{$:0,a:" tag:"},p(V,10,s,i),{$:0,a:"For syntax reasons, quotes can't stretch outside of the tag that they start in, so you'll need to close this quote before you can close that tag, or alternatively close the tag before you start the quote.  If you don't actually want a quote here, try replacing that first quotation mark with the text "},{$:3,a:S([{$:0,a:"&quot;"}])},{$:0,a:", which I'll replace with a normal quotation mark when I render the line, but I won't count it when I'm looking for quotes."}]));case 1:return 1===o.b.$?S([{$:0,a:"It looks like you opened a "},{$:3,a:S([{$:0,a:f(fo,s,r=o.a)}])},{$:0,a:" tag but forgot to close it!  In particular, I saw this opening tag:"},p(V,10,s,r),{$:0,a:"But I don't see any closing tags for the rest of the line, so I can never close it.  Make sure you add a matching "},{$:3,a:S([{$:0,a:"</"},{$:0,a:f(zn,1,f(fo,s,r))}])},{$:0,a:" tag to keep the balance!"}]):2===o.b.a.a?(e=o.b.a,S([{$:0,a:"It looks like you opened a "},{$:3,a:S([{$:0,a:f(fo,s,r=o.a)}])},{$:0,a:" tag but forgot to close it!  In particular, I saw this opening tag:"},p(V,10,s,r),{$:0,a:"But before I see a closing tag, I see a quotation mark:"},p(V,10,s,e),{$:0,a:"For syntax reasons, quotes can't be nested, and they can't close in a different tag than they open in.  If you meant to close the quote you started earlier, make sure you close this tag first.  If you don't actually want a quote here, try replacing that first quotation mark with the text "},{$:3,a:S([{$:0,a:"&quot;"}])},{$:0,a:", which I'll replace with a normal quotation mark when I render the line, but I won't count it when I'm looking for quotes.  And if you just wanted a quote inside of this quote, try using single quotes ('), which also happens to be a little bit more gramatically correct when it comes to nesting quotes."}])):(a=o.b.a,S([{$:0,a:"It looks like you opened a "},{$:3,a:S([{$:0,a:f(fo,s,r=o.a)}])},{$:0,a:" tag but forgot to close it!  In particular, I saw this opening tag:"},p(V,10,s,r),{$:0,a:"But before I see a closing tag, I see this:"},p(V,10,s,a),{$:0,a:"To be honest, I'm not sure why this caused a problem.  Actually, this branch of code was expected to never execute.  Maybe post an issue on the GitHub, or reach out to Ember to report it.  He/it would appreciate it!"}]));case 2:var t;return o.a.a||o.a.c.$||1!==o.b.a||o.b.c.$?(t=o.b,S([{$:0,a:'I saw a pair of mismatched tags, although something is strange...  The first "tag" appears here:'},p(V,10,s,n=o.a),{$:0,a:"And the second shows up later on, over here:"},p(V,10,s,t),{$:0,a:"But for some reason, one of these tags seems like it might not be a real tag.  It's very strange and you should make a bug report pretty please."}])):(n=o.a,t=o.b,i=t.c.a,S([{$:0,a:"I found a pair of mismatched tags!  In particular, you open a "},{$:0,a:$s(n.c.a)},{$:0,a:" tag here:"},p(V,10,s,n),{$:0,a:"But the closing tag that lines up with it is for a "},{$:0,a:$s(i)},{$:0,a:" tag, over here:"},p(V,10,s,t),{$:0,a:"Tags have to be closed in the opposite order you open them, so if you open a bold tag, italic tag, and monospace tag, you have to close the monospace tag first, then the italic tag, then the bold tag.  "},{$:0,a:"Double check to make sure you've opened and closed your tags in the right order, and that you haven't accidentally made a typo."}]));case 3:var e=o.a;return b(S([{$:0,a:"I encountered a tag that I couldn't understand!  You used a "},{$:3,a:S([{$:0,a:f(fo,s,e)}])},{$:0,a:" tag here:"},p(V,10,s,e),{$:0,a:"But that's not a tag I know how to format.  For the record, the tags that I "},{$:2,a:S([{$:0,a:"do"}])},{$:0,a:" know how to format are:  "}]),(r=c(function(t,e){var n=e.b;return S([{$:3,a:S([{$:0,a:"<"},{$:0,a:e.a},{$:0,a:">"}])},{$:0,a:" for "},{$:0,a:Ds(n)},{$:0,a:" text"},{$:0,a:t}])}),a=hn(Es),Ue(S([f(po,r(", "),f(xi,1,a)),S([{$:0,a:" and "}]),f(po,r("."),f(ho,1,a))]))));case 4:var n=o.a;return b(S([{$:0,a:"I encountered a character entity that I couldn't understand!  You used a "},{$:3,a:S([{$:0,a:f(fo,s,n)}])},{$:0,a:" character entity here:"},p(V,10,s,n),{$:0,a:"But that's not a character entity I know.  For the record, the only character entities that I "},{$:2,a:S([{$:0,a:"do"}])},{$:0,a:" know are:  "}]),(()=>{var t=c(function(t,e){var n=e.b;return S([{$:3,a:S([{$:0,a:"&"},{$:0,a:e.a},{$:0,a:";"}])},{$:0,a:" ("},{$:0,a:n},{$:0,a:")"},{$:0,a:t}])}),e=hn(xs);return Ue(S([f(po,t(", "),f(xi,1,e)),S([{$:0,a:" and "}]),f(po,t("."),f(ho,1,e))]))})());default:var i=o.a;return S([{$:0,a:"I recieved a truely spooky parse error that I don't understand in the least!  The only information I have is this cryptic message..."},{$:3,a:S([{$:0,a:"\n"}])},{$:4,a:S([{$:0,a:i}])}])}var r,a})())}),go=h(function(t,e,n,i){return{aw:t,a0:i,a1:e,a2:n}}),vo=s(function(t,e,n,i,r,a,s){if(-1!==a.$||a.a){for(;;){if(-1!==s.$||1!==s.a)break;if(-1!==s.d.$)return js(e);if(1===s.d.a)return js(e);break}return e}return u(L,n,a.b,a.c,a.d,u(L,0,i,r,a.e,s))}),bo=c(function(t,e){var n,i,r,a,s,o,l;return-2===e.$?mi:(n=e.a,r=e.c,a=e.d,s=e.e,g(t,i=e.b)<0?-1===a.$&&1===a.a?-1!==(o=a.d).$||o.a?-1===(o=Vs(e)).$?(l=o.e,u(vi,o.a,o.b,o.c,f(bo,t,o.d),l)):mi:u(L,n,i,r,f(bo,t,a),s):u(L,n,i,r,f(bo,t,a),s):f(Co,t,M(vo,t,e,n,i,r,a,s)))}),Co=c(function(t,e){var n,i,r,a,s;return-1===e.$?(n=e.a,i=e.c,r=e.d,a=e.e,l(t,e=e.b)?-1===(s=(t=>{for(;;){if(-1!==t.$||-1!==t.d.$)return t;t=t.d}})(a)).$?u(vi,n,s.b,s.c,r,Bs(a)):mi:u(vi,n,e,i,r,f(bo,t,a))):mi}),So=c(function(t,e){t=f(bo,t,e);return-1!==t.$||t.a?t:u(L,1,t.b,t.c,t.d,t.e)}),yo=c(function(t,e){switch(t.$){case 1:return v(e,{K:I(t.a)});case 2:return v(e,{A:p(Si,t.a,m(go,t.b,t.c,t.d,t.e),e.A)});case 3:return v(e,{A:f(So,t.a,e.A)});case 6:return v(e,{C:O});case 5:var n=t.a;return v(e,{C:I(f(D,{a:"UNKNOWN SPEAKER ID: "+n,b:p(qi,255,0,0)},f(Ei,n,e.p.bl)))});default:return e}}),wo=c(function(t,e){return p(oi,yo,e,t)}),Eo=c(function(t,e){switch(t.$){case 0:return{a:e,b:Ea};case 1:return Br(e)||e.O?e.H.$?{a:e,b:Ea}:{a:v(e,{i:qr(e.i)}),b:ao}:{a:v(e,{u:f(pa,2,31)}),b:Ea};case 2:var n=t.a,i=n.M,r=n.aW,a=n.P,s=f(wa,Wr,a),n=1===(n=f(ki,co(n),e.V)).$?{a:O,b:O}:(o=(n=n.a).b,{a:I(n.a),b:I(o)}),o=n.b,n=f(D,e.i,n.a),l=v(e,{V:f(va,qn,o)}),a=f(wo,a,l),l=a.C,i=1===(c=Ls(i)).$?{a:a,b:p(ga,f(mo,i,c.a),O,!0)}:1===c.a.a.$?{a:a,b:p(ga,u=(u=c.a).b,l,!1)}:(u=(c=c.a).b,{a:c=f(yo,kr(c.a.a),a),b:p(ga,u,c.C,!1)}),l=i.a,a=i.b;return s?p(Gi,e.F,e.p,$i):{a:v(l,{D:f(T,{a:n,b:a},e.D),u:0,H:r}),b:Ea};case 3:u=t.a,c=e.H;return 1===c.$?{a:v(e,{i:p(Sa,Le(c.a),u,e.i)}),b:Ca(u)}:{a:e,b:Ea};case 4:return{a:v(e,{O:t.a}),b:Ea};case 8:return{a:v(e,{N:I(h=t.a)}),b:Ea};case 9:return{a:v(e,{N:O}),b:Ea};case 10:var h=t.a;return p(Gi,e.F,e.p,h);case 6:i=t.a;return 0<e.w?{a:v(e,{w:e.w-1}),b:Ea}:p(Gi,e.F,e.p,f(ir,$i,Ke(f(D,"",i.L))));case 5:return{a:e,b:ba(t.a)};default:return{a:v(e,{u:e.u+1}),b:Ea}}var u,c,o}),nt=c(function(t,e){var n=Gr(e.i),e=f(Eo,t,e),i=e.a,e=e.b;return l(n,Gr(i.i))||6===t.$?{a:i,b:e}:{a:v(i,{w:i.w+1}),b:oa(S([e,(t=>f(ma,t.F,"#"+Gr(t.i)))(i)]))}}),_o={$:9},To=d(function(t,e,n){return{aa:e,L:t,ac:n}}),Ao=c(function(t,e){return f(re,(t=>se.test(t)?"data-"+t:t)(t),he(e))}),xo=c(function(n,t){var e;return t.b?(e=t.b,f(T,t.a,p(oi,c(function(t,e){return f(T,n,f(T,t,e))}),C,e))):C}),Io=_("div"),Po=_t,No=c(function(t,e){return f(ie,t,Po(e))}),Oo=No("id"),Fo=_("main"),Wo=d(function(t,e,n){return"#"+Gr(p(Sa,e,n,t))}),ko=d(function(t,e,n){return{aa:n,L:t(e),ac:{$:3,a:e}}}),Ro=st,Lo=d(function(t,e,n){return 1===n.$?t:e(n.a)}),Do=c(function(t,e){return{a:e.a,b:t(e.b)}}),$o=ne,Vo=No("className"),jo=c(function(t,e){var n=e.b;return{a:t(e.a),b:n}}),Bo=c(function(t,e){return f(ie,t,Vi(e))})("hidden"),Mo=_("img"),Go=_("li"),qo=ee,Uo=c(function(t,e){return f(qo,t,{$:0,a:e})});function Ko(){return ya(Ks)}function Ho(t){switch(t.$){case 0:return tl(t.a);case 1:var e=t.a;return f(Xo,C,el()(e));case 2:e=t.a;return f(Yo,C,el()(e));case 3:e=t.a;return f(Zo,C,el()(e));default:e=t.a;return f(Qo,S([Vo("quote")]),f(T,tl("“"),b(el()(e),S([tl("”")]))))}}var Jo=Ko(),zo=(Ko=function(){return Jo},_("p")),Xo=_("b"),Yo=_("i"),Zo=_("samp"),Qo=_("span"),tl=Zt;function el(){return k(Ho)}function nl(t){return f(No,"href",oe.test(t=t)?"":t)}function il(t){var e=t.L,n=t.aa,t=t.ac;return f(Go,S([Vo("choice")]),S([f(fl,S([nl(e),f(dl,"click",Mn({a:t,b:!0}))]),S([tl(n)]))]))}function rl(t){var e=t.aw,n=t.a1,i=t.a2,t=t.a0;return f(Mo,S([Vo("sprite"),ul("img/"+e),f($o,"left",mn(n)+"%"),f($o,"bottom",mn(100-i)+"%"),f($o,"width",mn(t)+"%")]),C)}var al=el(),sl=(el=function(){return al},c(function(t,e){var n=e.b;return{a:t(e.a),b:t(n)}})),ol=c(function(t,e){var n,i,r;return e.b?(n=e.b,(i=f(ll,t,e=e.a)).$?(r=i.a,f(f(Hi,Wi,jo),T(e),f(ol,r,n))):(r=(e=i.a).b,x({a:S([e.a]),b:f(T,r,n)}))):A(t)}),ll=c(function(t,e){switch(e.$){case 0:var n=e.a,i=Hn(n);switch(f(bi,t,Hn(n))){case 0:return x({a:{$:0,a:f(Yn,t,n)},b:{$:0,a:f(zn,t,n)}});case 1:return x({a:e,b:{$:0,a:""}});default:return A(t-i)}case 1:var r=e.a;return f(f(Hi,Wi,sl),Za,f(ol,t,r));case 2:r=e.a;return f(f(Hi,Wi,sl),Qa,f(ol,t,r));case 3:r=e.a;return f(f(Hi,Wi,sl),ts,f(ol,t,r));default:r=e.a;switch(t){case 0:return x({a:{$:0,a:""},b:e});case 1:return x({a:{$:4,a:C},b:e});default:var a=f(ol,t-1,r);return a.$?A(a.a-1):x({a:{$:4,a:(a=a.a).a},b:{$:4,a:a.b}})}}}),hl=c(function(t,e){t=f(ol,t,e);return t.$?{a:e,b:C}:t.a}),ul=function(t){return f(No,"src",he(t))},cl=c(function(t,e){var n=e.a,i=e.b.aj,r=e.b.ah,e=e.b.at,a=Jo(i),i=1===t.$?e?{a:S([{$:3,a:S([{$:0,a:"<dialog parse error>"}])}]),b:C}:{a:i,b:C}:e?{a:i,b:C}:f(hl,t.a,i),s=i.a,i=al(i.b),s=al(s);return f(zo,S([Gs(S([{a:"dialog",b:!0},{a:"dialog-error",b:e},{a:"dialog-with-quote",b:a}])),r.$?Gs(C):f(Ao,"style","--speaker-color: "+qs(r.a.b)),t.$?Us({$:8,a:n}):Gs(C)]),S([f(Mo,S([ul("ui/history-fill.svg"),Vo("restore")]),C),f(Qo,C,S([f(Qo,C,s),f(Qo,S([f($o,"visibility","hidden")]),i)]))]))}),dl=c(function(t,e){return f(qo,t,{$:1,a:e})}),fl=_("a"),pl=h(function(t,e,n,i){var r=!t,a=f(va,f(o,jr,function(t){return t.ah}),Ze(n)),s=f(Xr,n,e);return f(Io,S([Gs(S([{a:"dialog-box",b:!0},{a:"full",b:r},{a:"system-message",b:2===t}])),Us(wr),f($o,"cursor",i.$||r?"auto":"pointer")]),S([p(Ms,"div",S([Oo("dialog-scrollable")]),(r?En:qn)(S([{a:"dialog-entries",b:p(Ms,"div",S([Oo("dialog-entries")]),f(k,jo(mn),f(yn,yi,En(f(k,cl(r?O:I(e)),(r?qn:ho(1))(n))))))},{a:s?"choices":"hidden-choices",b:1===i.$?(t=i.a,f(Go,S([Vo("choices"),s?Gs(C):f($o,"visibility","hidden")]),f(k,il,t))):f(Io,C,C)}]))),f(Mo,S([f(dl,"click",Mn({a:{$:4,a:!r},b:!0})),Oo("dialoglog-button"),f($o,"cursor","pointer"),ul(r?"ui/arrow-down-double-line.svg":"ui/arrow-up-double-line.svg")]),C),f(Mo,S([Oo("advance-story"),Bo(!s),Vo((()=>{switch(i.$){case 2:return"story-finished";case 1:return"story-choice";default:return"story-continue"}})()),ul("ui/arrow-down-s-fill.svg")]),C),f(Io,S([Oo("speaker-nameplate"),1===a.$?Gs(C):f($o,"backgroundColor",qs(a.a.b))]),S([tl(f(D,"",f(ki,je,a)))]))]))}),Y=z({be:vt,bh:function(t){return{$:6,a:t}},bi:function(t){return t.$?{$:5,a:t.a}:ar},bm:function(t){return lr(S([$r(He),sa(f(Bn,Je,Tr)),Br(t)?Yr:f(yr,40,Er(or))]))},bn:nt,bo:function(n){return{a6:S([f(Io,S([Oo("blurred-bg"),f($o,"background-image",no(S(['url("img/',f(D,"",n.K),'")'])))]),C),f(Fo,S([f(Ao,"style",(e=S([{a:"background-image",b:no(S(['url("img/',f(D,"",n.K),'")']))},{a:"--aspect-ratio-w",b:mn(f(D,{a:4,b:3},n.p.al).a)},{a:"--aspect-ratio-h",b:mn(f(D,{a:4,b:3},n.p.al).b)}]),no(f(xo,"; ",f(k,function(t){return no(S([t.a,": ",t.b]))},e)))))]),S([p(Ms,"div",S([Oo("stage")]),f(f(Hi,k,Do),rl,hn(n.A))),1===(e=n.N).$?(t=(()=>{var t=n.H;switch(t.$){case 1:var e=t.a;return{$:1,a:f(yn,ko(f(Wo,n.i,Le(e))),e)};case 0:return Li;default:return Ir}})(),m(pl,n.O?0:1,n.u,n.D,t)):(t=e.a,m(pl,2,99999,S([{a:n.i,b:p(ga,S([{$:0,a:"Are you sure you'd like to revert to a previous point in the story?  You'll lose all the progress that you've made since then."}]),I({a:"Reload?",b:p(qi,99,112,163)}),!1)}]),{$:1,a:S([p(To,"#"+Gr(t),"Yes, take me back",{$:10,a:t}),p(To,"#"+Gr(n.i),"No, I want to stay",_o)])}))]))]),aZ:(t=f(D,"Visual Novel",(e=n.p).aZ),e=p(Lo,"",Ro(" by "),e.a5),no(S([t,e])))};var t,e}});Z={Main:{init:Y(rr(sr))(0)}},i.Elm?function t(e,n){for(var i in n)i in e?"init"==i?Q(6):t(e[i],n[i]):e[i]=n[i]}(i.Elm,Z):i.Elm=Z})(this),((t,e)=>{"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).inkjs={})})(this,function(s){class n{constructor(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;this.sourceFilename=t,this.pluginNames=e,this.countAllVisits=n,this.errorHandler=i,this.fileHandler=r}}class i{constructor(t,e,n){this.length=t,this.debugMetadata=e,this.text=n}}var B,M,h,u,l,c,o,e,t,G;(t=>{t[t.Author=0]="Author",t[t.Warning=1]="Warning",t[t.Error=2]="Error"})(B=B||{});class q{constructor(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;this.identifier=t,this.isByReference=e,this.isDivertTarget=n}get typeName(){return"Argument"}}function d(t,e){return t instanceof e?t:null}function f(t,e){if(t instanceof e)return t;throw Error(t+" is not of type "+e)}function r(t){return t.hasValidName&&t.name?t:null}function U(t){return void 0===t?null:t}function K(t){return"object"==typeof t&&"function"==typeof t.Equals}function H(t){return null!=t}class p{constructor(){var r=this;this._alreadyHadError=!1,this._alreadyHadWarning=!1,this._debugMetadata=null,this._runtimeObject=null,this.content=[],this.parent=null,this.GetType=()=>this.typeName,this.AddContent=t=>{null===this.content&&(this.content=[]);var e=Array.isArray(t)?t:[t];for(let t of e)t.hasOwnProperty("parent")&&(t.parent=this),this.content.push(t);return Array.isArray(t)?void 0:t},this.InsertContent=(t,e)=>(null===this.content&&(this.content=[]),(e.parent=this).content.splice(t,0,e),e),this.Find=i=>function(){let n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=d(r,i);if(null!==t&&(null===n||!0===n(t)))return t;if(null!==r.content)for(let e of r.content){let t=e.Find&&e.Find(i)(n);if(t)return t}return null},this.FindAll=i=>(e,t)=>{var n=Array.isArray(t)?t:[],t=d(this,i);if(null===t||e&&!0!==e(t)||n.push(t),null===this.content)return[];for(let t of this.content)t.FindAll&&t.FindAll(i)(e,n);return n},this.Warning=function(t){r.Error(t,1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,!0)}}get debugMetadata(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata}set debugMetadata(t){this._debugMetadata=t}get hasOwnDebugMetadata(){return!!this.debugMetadata}get typeName(){return"ParsedObject"}get story(){let t=this;for(;t.parent;)t=t.parent;return t}get runtimeObject(){return this._runtimeObject||(this._runtimeObject=this.GenerateRuntimeObject(),this._runtimeObject&&(this._runtimeObject.debugMetadata=this.debugMetadata)),this._runtimeObject}set runtimeObject(t){this._runtimeObject=t}get runtimePath(){if(this.runtimeObject.path)return this.runtimeObject.path;throw Error()}get containerForCounting(){return this.runtimeObject}get ancestry(){let t=[],e=this.parent;for(;e;)t.push(e),e=e.parent;return t=t.reverse()}ResolveReferences(t){if(null!==this.content)for(var e of this.content)e.ResolveReferences(t)}Error(t){let e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(!((e=null===e?this:e)._alreadyHadError&&!n||e._alreadyHadWarning&&n)){if(!this.parent)throw Error("No parent object to send error to: "+t);this.parent.Error(t,e,n),n?e._alreadyHadWarning=!0:e._alreadyHadError=!0}}}class J extends p{constructor(t){super(),this.warningMessage=t,this.GenerateRuntimeObject=()=>(this.Warning(this.warningMessage),null)}get typeName(){return"AuthorWarning"}}let m=class s{constructor(){if(this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]){let t=arguments[0];this.componentsString=t}else if(arguments[0]instanceof s.Component&&arguments[1]instanceof s){let t=arguments[0],e=arguments[1];this._components.push(t),this._components=this._components.concat(e._components)}else if(arguments[0]instanceof Array){let t=arguments[0],e=!!arguments[1];this._components=this._components.concat(t),this._isRelative=e}}get isRelative(){return this._isRelative}get componentCount(){return this._components.length}get head(){return 0<this._components.length?this._components[0]:null}get tail(){var t;return this._components.length<2?s.self:(t=this._components.slice(1,this._components.length),new s(t))}get length(){return this._components.length}get lastComponent(){var t=this._components.length-1;return t<0?null:this._components[t]}get containsNamedComponent(){for(let t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}static get self(){var t=new s;return t._isRelative=!0,t}GetComponent(t){return this._components[t]}PathByAppendingPath(e){let n=new s,i=0;for(let t=0;t<e._components.length&&e._components[t].isParent;++t)i++;for(let t=0;t<this._components.length-i;++t)n._components.push(this._components[t]);for(let t=i;t<e._components.length;++t)n._components.push(e._components[t]);return n}get componentsString(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative)&&(this._componentsString="."+this._componentsString),this._componentsString}set componentsString(t){if(this._components.length=0,this._componentsString=t,null!=this._componentsString&&""!=this._componentsString){"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));for(let t of this._componentsString.split("."))/^(\-|\+)?([0-9]+|Infinity)$/.test(t)?this._components.push(new s.Component(parseInt(t))):this._components.push(new s.Component(t))}}toString(){return this.componentsString}Equals(n){if(null==n)return!1;if(n._components.length!=this._components.length)return!1;if(n.isRelative!=this.isRelative)return!1;for(let t=0,e=n._components.length;t<e;t++)if(!n._components[t].Equals(this._components[t]))return!1;return!0}PathByAppendingComponent(t){var e=new s;return e._components.push(...this._components),e._components.push(t),e}};m.parentId="^",(e=>{e.Component=class t{constructor(t){this.index=-1,this.name=null,"string"==typeof t?this.name=t:this.index=t}get isIndex(){return 0<=this.index}get isParent(){return this.name==e.parentId}static ToParent(){return new t(e.parentId)}toString(){return this.isIndex?""+this.index:this.name}Equals(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}}})(m=m||{}),(t=>{function i(t,e){if(!t)throw void 0!==e&&console.warn(e),console.trace&&console.trace(),Error("")}t.AssertType=function(t,e,n){i(t instanceof e,n)},t.Assert=i})(M=M||{});class z extends Error{}function g(t){throw new z(t+" is null or undefined")}class v{constructor(){this.parent=null,this._debugMetadata=null,this._path=null}get debugMetadata(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata}set debugMetadata(t){this._debugMetadata=t}get ownDebugMetadata(){return this._debugMetadata}DebugLineNumberOfPath(t){if(null!==t){var e=this.rootContentContainer;if(e){e=e.ContentAtPath(t).obj;if(e){let t=e.debugMetadata;if(null!==t)return t.startLineNumber}}}return null}get path(){if(null==this._path)if(null==this.parent)this._path=new m;else{let t=[],e=this,n=d(e.parent,A);for(;null!==n;){var i=r(e);if(null!=i&&i.hasValidName){if(null===i.name)return g("namedChild.name");t.unshift(new m.Component(i.name))}else t.unshift(new m.Component(n.content.indexOf(e)));n=d((e=n).parent,A)}this._path=new m(t)}return this._path}ResolvePath(e){if(null===e)return g("path");if(e.isRelative){let t=d(this,A);return null===t&&(M.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),t=d(this.parent,A),M.Assert(null!==t,"Expected parent to be a container"),M.Assert(e.GetComponent(0).isParent),e=e.tail),null===t?g("nearestContainer"):t.ContentAtPath(e)}var t=this.rootContentContainer;return null===t?g("contentContainer"):t.ContentAtPath(e)}ConvertPathToRelative(i){let r=this.path,t=Math.min(i.length,r.length),a=-1;for(let n=0;n<t;++n){let t=r.GetComponent(n),e=i.GetComponent(n);if(!t.Equals(e))break;a=n}if(-1==a)return i;var e=r.componentCount-1-a,n=[];for(let t=0;t<e;++t)n.push(m.Component.ToParent());for(let t=a+1;t<i.componentCount;++t)n.push(i.GetComponent(t));return new m(n,!0)}CompactPathString(t){let e=null,n=null;return e=(t.isRelative?(n=t.componentsString,this.path.PathByAppendingPath(t)):(n=this.ConvertPathToRelative(t).componentsString,t)).componentsString,n.length<e.length?n:e}get rootContentContainer(){let t=this;for(;t.parent;)t=t.parent;return d(t,A)}Copy(){throw Error("Not Implemented: Doesn't support copying")}SetChild(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}Equals(t){return t===this}}class b{constructor(t){this.string=t=void 0!==t?""+t:""}get Length(){return this.string.length}Append(t){null!==t&&(this.string+=t)}AppendLine(t){void 0!==t&&this.Append(t),this.string+="\n"}AppendFormat(t){for(var e=arguments.length,n=Array(1<e?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];this.string+=t.replace(/{(\d+)}/g,(t,e)=>void 0!==n[e]?n[e]:t)}toString(){return this.string}Clear(){this.string=""}}class C{constructor(){if(this.originName=null,this.itemName=null,void 0!==arguments[1]){var t=arguments[0],e=arguments[1];this.originName=t,this.itemName=e}else if(arguments[0]){let t=(""+arguments[0]).split(".");this.originName=t[0],this.itemName=t[1]}}static get Null(){return new C(null,null)}get isNull(){return null==this.originName&&null==this.itemName}get fullName(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}toString(){return this.fullName}Equals(t){return t instanceof C&&t.itemName==this.itemName&&t.originName==this.originName}copy(){return new C(this.originName,this.itemName)}serialized(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}static fromSerializedKey(t){var t=JSON.parse(t);return C.isLikeInkListItem(t)?(t=t,new C(t.originName,t.itemName)):C.Null}static isLikeInkListItem(t){return!("object"!=typeof t||!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName")||"string"!=typeof t.originName&&null!==typeof t.originName||"string"!=typeof t.itemName&&null!==typeof t.itemName)}}class S extends Map{constructor(){if(super(arguments[0]instanceof S?arguments[0]:[]),this.origins=null,this._originNames=[],arguments[0]instanceof S){var t=arguments[0],e=t.originNames;null!==e&&(this._originNames=e.slice()),null!==t.origins&&(this.origins=t.origins.slice())}else if("string"==typeof arguments[0]){let t=arguments[0],e=arguments[1];if(this.SetInitialOriginName(t),null===e.listDefinitions)return g("originStory.listDefinitions");var n=e.listDefinitions.TryListGetDefinition(t,null);if(!n.exists)throw Error("InkList origin could not be found in story when constructing new list: "+t);if(null===n.result)return g("def.result");this.origins=[n.result]}else if("object"==typeof arguments[0]&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){let t=arguments[0];this.Add(t.Key,t.Value)}}static FromString(t,e){if(null==t||""==t)return new S;e=null==(e=e.listDefinitions)?void 0:e.FindSingleItemListWithName(t);if(e)return null===e.value?g("listValue.value"):new S(e.value);throw Error("Could not find the InkListItem from the string '"+t+"' to create an InkList because it doesn't exist in the original list definition in ink.")}AddItem(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(t instanceof C){let e=t;if(null==e.originName)return void this.AddItem(e.itemName);if(null===this.origins)return g("this.origins");for(let t of this.origins)if(t.name==e.originName){var n=t.TryGetValueForItem(e,0);if(n.exists)return void this.Add(e,n.result);throw Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}throw Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}if(null!==t){let n=t,i=null;if(null===this.origins)return g("this.origins");for(let t of this.origins){if(null===n)return g("itemName");if(t.ContainsItemWithName(n)){if(null!=i)throw Error("Could not add the item "+n+" to this list because it could come from either "+t.name+" or "+i.name);i=t}}if(null==i){if(null==e)throw Error("Could not add the item "+n+" to this list because it isn't known to any list definitions previously associated with this list.");{let t=S.FromString(n,e).orderedItems[0];this.Add(t.Key,t.Value)}}else{let t=new C(i.name,n),e=i.ValueForItem(t);this.Add(t,e)}}}ContainsItemNamed(t){for(var[e]of this)if(C.fromSerializedKey(e).itemName==t)return!0;return!1}ContainsKey(t){return this.has(t.serialized())}Add(t,e){var n=t.serialized();if(this.has(n))throw Error("The Map already contains an entry for "+t);this.set(n,e)}Remove(t){return this.delete(t.serialized())}get Count(){return this.size}get originOfMaxItem(){if(null==this.origins)return null;let e=this.maxItem.Key.originName,n=null;return this.origins.every(t=>t.name!=e||(n=t,!1)),n}get originNames(){if(0<this.Count){null==this._originNames&&0<this.Count?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);for(var[t]of this){t=C.fromSerializedKey(t);if(null===t.originName)return g("item.originName");this._originNames.push(t.originName)}}return this._originNames}SetInitialOriginName(t){this._originNames=[t]}SetInitialOriginNames(t){this._originNames=null==t?null:t.slice()}get maxItem(){let t={Key:C.Null,Value:0};for(var[e,n]of this){e=C.fromSerializedKey(e);(t.Key.isNull||n>t.Value)&&(t={Key:e,Value:n})}return t}get minItem(){let t={Key:C.Null,Value:0};for(var[e,n]of this){e=C.fromSerializedKey(e);(t.Key.isNull||n<t.Value)&&(t={Key:e,Value:n})}return t}get inverse(){var e=new S;if(null!=this.origins)for(var t of this.origins)for(var[n,i]of t.items){let t=C.fromSerializedKey(n);this.ContainsKey(t)||e.Add(t,i)}return e}get all(){var e=new S;if(null!=this.origins)for(var t of this.origins)for(var[n,i]of t.items){let t=C.fromSerializedKey(n);e.set(t.serialized(),i)}return e}Union(t){var e,n,i=new S(this);for([e,n]of t)i.set(e,n);return i}Intersect(t){var e,n,i=new S;for([e,n]of this)t.has(e)&&i.set(e,n);return i}HasIntersection(t){for(var[e]of this)if(t.has(e))return!0;return!1}Without(t){var e,n=new S(this);for([e]of t)n.delete(e);return n}Contains(t){if("string"==typeof t)return this.ContainsItemNamed(t);var e=t;if(0==e.size||0==this.size)return!1;for(let[t]of e)if(!this.has(t))return!1;return!0}GreaterThan(t){return 0!=this.Count&&(0==t.Count||t.maxItem.Value<this.minItem.Value)}GreaterThanOrEquals(t){return 0!=this.Count&&(0==t.Count||t.minItem.Value<=this.minItem.Value&&t.maxItem.Value<=this.maxItem.Value)}LessThan(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}LessThanOrEquals(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}MaxAsList(){return 0<this.Count?new S(this.maxItem):new S}MinAsList(){return 0<this.Count?new S(this.minItem):new S}ListWithSubRange(t,e){if(0==this.Count)return new S;let n=this.orderedItems,i=0,r=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?i=t:t instanceof S&&0<t.Count&&(i=t.minItem.Value),Number.isInteger(e)?r=e:e instanceof S&&0<e.Count&&(r=e.maxItem.Value);var a=new S;a.SetInitialOriginNames(this.originNames);for(let t of n)t.Value<i||t.Value>r||a.Add(t.Key,t.Value);return a}Equals(t){if(t instanceof S==0)return!1;if(t.Count!=this.Count)return!1;for(var[e]of this)if(!t.has(e))return!1;return!0}get orderedItems(){var t,e,n=[];for([t,e]of this){var i=C.fromSerializedKey(t);n.push({Key:i,Value:e})}return n.sort((t,e)=>null===t.Key.originName?g("x.Key.originName"):null===e.Key.originName?g("y.Key.originName"):t.Value==e.Value?t.Key.originName.localeCompare(e.Key.originName):t.Value<e.Value?-1:e.Value<t.Value?1:0),n}get singleItem(){for(var t of this.orderedItems)return t.Key;return null}toString(){var e=this.orderedItems,n=new b;for(let t=0;t<e.length;t++){0<t&&n.Append(", ");var i=e[t].Key;if(null===i.itemName)return g("item.itemName");n.Append(i.itemName)}return""+n}valueOf(){return NaN}}class y extends Error{constructor(t){super(t),this.useEndLineNumber=!1,this.message=t,this.name="StoryException"}}function a(t,e,n){return null===t||void 0===(t=t.get(e))?{result:n,exists:!1}:{result:t,exists:!0}}class X extends v{static Create(t,e){if(e){if(e===h.Int&&Number.isInteger(+(""+t)))return new E(+(""+t));if(e===h.Float&&!isNaN(t))return new Z(+(""+t))}return"boolean"==typeof t?new Y(!!t):"string"==typeof t?new _(""+t):Number.isInteger(+(""+t))?new E(+(""+t)):isNaN(t)?t instanceof m?new Q(f(t,m)):t instanceof S?new T(f(t,S)):null:new Z(+(""+t))}Copy(){return f(X.Create(this.valueObject),v)}BadCastException(t){return new y("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}class w extends X{constructor(t){super(),this.value=t}get valueObject(){return this.value}toString(){return null===this.value?g("Value.value"):""+this.value}}class Y extends w{constructor(t){super(t||!1)}get isTruthy(){return!!this.value}get valueType(){return h.Bool}Cast(t){if(null===this.value)return g("Value.value");if(t==this.valueType)return this;if(t==h.Int)return new E(this.value?1:0);if(t==h.Float)return new Z(this.value?1:0);if(t==h.String)return new _(this.value?"true":"false");throw this.BadCastException(t)}toString(){return this.value?"true":"false"}}class E extends w{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return h.Int}Cast(t){if(null===this.value)return g("Value.value");if(t==this.valueType)return this;if(t==h.Bool)return new Y(0!==this.value);if(t==h.Float)return new Z(this.value);if(t==h.String)return new _(""+this.value);throw this.BadCastException(t)}}class Z extends w{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return h.Float}Cast(t){if(null===this.value)return g("Value.value");if(t==this.valueType)return this;if(t==h.Bool)return new Y(0!==this.value);if(t==h.Int)return new E(this.value);if(t==h.String)return new _(""+this.value);throw this.BadCastException(t)}}class _ extends w{constructor(t){if(super(t||""),this._isNewline="\n"==this.value,this._isInlineWhitespace=!0,null===this.value)return g("Value.value");0<this.value.length&&this.value.split("").every(t=>" "==t||"\t"==t||(this._isInlineWhitespace=!1))}get valueType(){return h.String}get isTruthy(){return null===this.value?g("Value.value"):0<this.value.length}get isNewline(){return this._isNewline}get isInlineWhitespace(){return this._isInlineWhitespace}get isNonWhitespace(){return!this.isNewline&&!this.isInlineWhitespace}Cast(t){if(t==this.valueType)return this;if(t==h.Int){var e=function(t,e){t=parseInt(t);return Number.isNaN(t)?{result:1<arguments.length&&void 0!==e?e:0,exists:!1}:{result:t,exists:!0}}(this.value);if(e.exists)return new E(e.result)}else if(t==h.Float){let t=function(t,e){t=parseFloat(t);return Number.isNaN(t)?{result:1<arguments.length&&void 0!==e?e:0,exists:!1}:{result:t,exists:!0}}(this.value);if(t.exists)return new Z(t.result)}throw this.BadCastException(t)}}class Q extends w{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:null)}get valueType(){return h.DivertTarget}get targetPath(){return null===this.value?g("Value.value"):this.value}set targetPath(t){this.value=t}get isTruthy(){throw Error("Shouldn't be checking the truthiness of a divert target")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"DivertTargetValue("+this.targetPath+")"}}class tt extends w{constructor(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1;super(t),this._contextIndex=e}get contextIndex(){return this._contextIndex}set contextIndex(t){this._contextIndex=t}get variableName(){return null===this.value?g("Value.value"):this.value}set variableName(t){this.value=t}get valueType(){return h.VariablePointer}get isTruthy(){throw Error("Shouldn't be checking the truthiness of a variable pointer")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"VariablePointerValue("+this.variableName+")"}Copy(){return new tt(this.variableName,this.contextIndex)}}class T extends w{get isTruthy(){return null===this.value?g("this.value"):0<this.value.Count}get valueType(){return h.List}Cast(t){if(null===this.value)return g("Value.value");if(t==h.Int){let t=this.value.maxItem;return t.Key.isNull?new E(0):new E(t.Value)}if(t==h.Float){let t=this.value.maxItem;return t.Key.isNull?new Z(0):new Z(t.Value)}if(t==h.String){let t=this.value.maxItem;return t.Key.isNull?new _(""):new _(""+t.Key)}if(t==this.valueType)return this;throw this.BadCastException(t)}constructor(t,e){super(null),t||e?t instanceof S?this.value=new S(t):t instanceof C&&"number"==typeof e&&(this.value=new S({Key:t,Value:e})):this.value=new S}static RetainListOriginsForAssignment(t,e){t=d(t,T),e=d(e,T);return e&&null===e.value?g("newList.value"):t&&null===t.value?g("oldList.value"):void(t&&e&&0==e.value.Count&&e.value.SetInitialOriginNames(t.value.originNames))}}(t=>{t[t.Bool=-1]="Bool",t[t.Int=0]="Int",t[t.Float=1]="Float",t[t.List=2]="List",t[t.String=3]="String",t[t.DivertTarget=4]="DivertTarget",t[t.VariablePointer=5]="VariablePointer"})(h=h||{});class et{constructor(){this.obj=null,this.approximate=!1}get correctObj(){return this.approximate?null:this.obj}get container(){return this.obj instanceof A?this.obj:null}copy(){var t=new et;return t.obj=this.obj,t.approximate=this.approximate,t}}class A extends v{constructor(){super(...arguments),this.name=null,this._content=[],this.namedContent=new Map,this.visitsShouldBeCounted=!1,this.turnIndexShouldBeCounted=!1,this.countingAtStartOnly=!1,this._pathToFirstLeafContent=null}get hasValidName(){return null!=this.name&&0<this.name.length}get content(){return this._content}set content(t){this.AddContent(t)}get namedOnlyContent(){let n=new Map;for(var[t,e]of this.namedContent){e=f(e,v);n.set(t,e)}for(let e of this.content){let t=r(e);null!=t&&t.hasValidName&&n.delete(t.name)}return n=0==n.size?null:n}set namedOnlyContent(t){var e=this.namedOnlyContent;if(null!=e)for(let[t]of e)this.namedContent.delete(t);if(null!=t)for(let[,e]of t){let t=r(e);null!=t&&this.AddToNamedContentOnly(t)}}get countFlags(){let t=0;return this.visitsShouldBeCounted&&(t|=A.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=A.CountFlags.Turns),this.countingAtStartOnly&&(t|=A.CountFlags.CountStartOnly),t=t==A.CountFlags.CountStartOnly?0:t}set countFlags(t){0<(t&A.CountFlags.Visits)&&(this.visitsShouldBeCounted=!0),0<(t&A.CountFlags.Turns)&&(this.turnIndexShouldBeCounted=!0),0<(t&A.CountFlags.CountStartOnly)&&(this.countingAtStartOnly=!0)}get pathToFirstLeafContent(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}get internalPathToFirstLeafContent(){let t=[],e=this;for(;e instanceof A;)0<e.content.length&&(t.push(new m.Component(0)),e=e.content[0]);return new m(t)}AddContent(e){if(e instanceof Array){var n=e;for(let t of n)this.AddContent(t)}else{let t=e;if(this._content.push(t),t.parent)throw Error("content is already in "+t.parent);(t.parent=this).TryAddNamedContent(t)}}TryAddNamedContent(t){t=r(t);null!=t&&t.hasValidName&&this.AddToNamedContentOnly(t)}AddToNamedContentOnly(t){if(M.AssertType(t,v,"Can only add Runtime.Objects to a Runtime.Container"),f(t,v).parent=this,null===t.name)return g("namedContentObj.name");this.namedContent.set(t.name,t)}ContentAtPath(n){let t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:-1;-1==i&&(i=n.length);var r=new et;r.approximate=!1;let a=this,s=this;for(let e=t;e<i;++e){let t=n.GetComponent(e);if(null==a){r.approximate=!0;break}var o=a.ContentWithPathComponent(t);if(null==o){r.approximate=!0;break}var l=d(o,A);if(e<i-1&&null==l){r.approximate=!0;break}s=o,a=l}return r.obj=s,r}InsertContent(t,e){if(this.content.splice(e,0,t),t.parent)throw Error("content is already in "+t.parent);(t.parent=this).TryAddNamedContent(t)}AddContentsOfContainer(t){this.content.push(...t.content);for(var e of t.content)e.parent=this,this.TryAddNamedContent(e)}ContentWithPathComponent(t){return t.isIndex?0<=t.index&&t.index<this.content.length?this.content[t.index]:null:t.isParent?this.parent:null===t.name?g("component.name"):(t=a(this.namedContent,t.name,null)).exists?f(t.result,v):null}BuildStringOfHierarchy(){let e;if(0==arguments.length)return e=new b,this.BuildStringOfHierarchy(e,0,null),""+e;e=arguments[0];let n=arguments[1],i=arguments[2];function r(){for(let t=0;t<4*n;++t)e.Append(" ")}r(),e.Append("["),this.hasValidName&&e.AppendFormat(" ({0})",this.name),this==i&&e.Append("  <---"),e.AppendLine(),n++;for(let t=0;t<this.content.length;++t){var a=this.content[t];a instanceof A?a.BuildStringOfHierarchy(e,n,i):(r(),a instanceof _?(e.Append('"'),e.Append((""+a).replace("\n","\\n")),e.Append('"')):e.Append(""+a)),t!=this.content.length-1&&e.Append(","),a instanceof A||a!=i||e.Append("  <---"),e.AppendLine()}var s=new Map;for(let[t,e]of this.namedContent)~this.content.indexOf(f(e,v))||s.set(t,e);if(0<s.size){r(),e.AppendLine("-- named: --");for(let[,t]of s)M.AssertType(t,A,"Can only print out named Containers"),t.BuildStringOfHierarchy(e,n,i),e.AppendLine()}n--,r(),e.Append("]")}}(t=>{(t=t.CountFlags||(t.CountFlags={}))[t.Start=0]="Start",t[t.Visits=1]="Visits",t[t.Turns=2]="Turns",t[t.CountStartOnly=4]="CountStartOnly"})(A=A||{});class x extends v{get commandType(){return this._commandType}constructor(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:x.CommandType.NotSet;super(),this._commandType=t}Copy(){return new x(this.commandType)}static EvalStart(){return new x(x.CommandType.EvalStart)}static EvalOutput(){return new x(x.CommandType.EvalOutput)}static EvalEnd(){return new x(x.CommandType.EvalEnd)}static Duplicate(){return new x(x.CommandType.Duplicate)}static PopEvaluatedValue(){return new x(x.CommandType.PopEvaluatedValue)}static PopFunction(){return new x(x.CommandType.PopFunction)}static PopTunnel(){return new x(x.CommandType.PopTunnel)}static BeginString(){return new x(x.CommandType.BeginString)}static EndString(){return new x(x.CommandType.EndString)}static NoOp(){return new x(x.CommandType.NoOp)}static ChoiceCount(){return new x(x.CommandType.ChoiceCount)}static Turns(){return new x(x.CommandType.Turns)}static TurnsSince(){return new x(x.CommandType.TurnsSince)}static ReadCount(){return new x(x.CommandType.ReadCount)}static Random(){return new x(x.CommandType.Random)}static SeedRandom(){return new x(x.CommandType.SeedRandom)}static VisitIndex(){return new x(x.CommandType.VisitIndex)}static SequenceShuffleIndex(){return new x(x.CommandType.SequenceShuffleIndex)}static StartThread(){return new x(x.CommandType.StartThread)}static Done(){return new x(x.CommandType.Done)}static End(){return new x(x.CommandType.End)}static ListFromInt(){return new x(x.CommandType.ListFromInt)}static ListRange(){return new x(x.CommandType.ListRange)}static ListRandom(){return new x(x.CommandType.ListRandom)}static BeginTag(){return new x(x.CommandType.BeginTag)}static EndTag(){return new x(x.CommandType.EndTag)}toString(){return"ControlCommand "+this.commandType}}(t=>{(t=t.CommandType||(t.CommandType={}))[t.NotSet=-1]="NotSet",t[t.EvalStart=0]="EvalStart",t[t.EvalOutput=1]="EvalOutput",t[t.EvalEnd=2]="EvalEnd",t[t.Duplicate=3]="Duplicate",t[t.PopEvaluatedValue=4]="PopEvaluatedValue",t[t.PopFunction=5]="PopFunction",t[t.PopTunnel=6]="PopTunnel",t[t.BeginString=7]="BeginString",t[t.EndString=8]="EndString",t[t.NoOp=9]="NoOp",t[t.ChoiceCount=10]="ChoiceCount",t[t.Turns=11]="Turns",t[t.TurnsSince=12]="TurnsSince",t[t.ReadCount=13]="ReadCount",t[t.Random=14]="Random",t[t.SeedRandom=15]="SeedRandom",t[t.VisitIndex=16]="VisitIndex",t[t.SequenceShuffleIndex=17]="SequenceShuffleIndex",t[t.StartThread=18]="StartThread",t[t.Done=19]="Done",t[t.End=20]="End",t[t.ListFromInt=21]="ListFromInt",t[t.ListRange=22]="ListRange",t[t.ListRandom=23]="ListRandom",t[t.BeginTag=24]="BeginTag",t[t.EndTag=25]="EndTag",t[t.TOTAL_VALUES=26]="TOTAL_VALUES"})(x=x||{});class I extends p{constructor(){super(...arguments),this._prototypeRuntimeConstantExpression=null,this.outputWhenComplete=!1,this.GenerateRuntimeObject=()=>{var t=new A;return t.AddContent(x.EvalStart()),this.GenerateIntoContainer(t),this.outputWhenComplete&&t.AddContent(x.EvalOutput()),t.AddContent(x.EvalEnd()),t},this.GenerateConstantIntoContainer=t=>{null===this._prototypeRuntimeConstantExpression&&(this._prototypeRuntimeConstantExpression=new A,this.GenerateIntoContainer(this._prototypeRuntimeConstantExpression));for(var e of this._prototypeRuntimeConstantExpression.content){e=e.Copy();e&&t.AddContent(e)}},this.toString=()=>"No string value in JavaScript."}get typeName(){return"Expression"}Equals(t){return!1}}class nt extends v{toString(){return"Void"}}class P extends v{static CallWithName(t){return new P(t)}static CallExistsWithName(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}get name(){return null===this._name?g("NativeFunctionCall._name"):this._name}set name(t){this._name=t,this._isPrototype||(null===P._nativeFunctions?g("NativeFunctionCall._nativeFunctions"):this._prototype=P._nativeFunctions.get(this._name)||null)}get numberOfParameters(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters}set numberOfParameters(t){this._numberOfParameters=t}Call(e){if(this._prototype)return this._prototype.Call(e);if(this.numberOfParameters!=e.length)throw Error("Unexpected number of parameters");let n=!1;for(let t of e){if(t instanceof nt)throw new y("Attempting to perform "+this.name+' on a void value. Did you forget to "return" a value from a function you called here?');t instanceof T&&(n=!0)}var t;return 2==e.length&&n?this.CallBinaryListOperation(e):(t=(e=this.CoerceValuesToSingleType(e))[0].valueType)==h.Int||t==h.Float||t==h.String||t==h.DivertTarget||t==h.List?this.CallType(e):null}CallType(i){var n=f(i[0],w),e=n.valueType,r=n,t=i.length;if(2!=t&&1!=t)throw Error("Unexpected number of parameters to NativeFunctionCall: "+i.length);if(null===this._operationFuncs)return g("NativeFunctionCall._operationFuncs");var a=this._operationFuncs.get(e);if(!a){let t=h[e];throw new y("Cannot perform operation "+this.name+" on "+t)}if(2==t){let t=f(i[1],w),e=a;if(null===r.value||null===t.value)return g("NativeFunctionCall.Call BinaryOp values");let n=e(r.value,t.value);return w.Create(n)}{let t=a;if(null===r.value)return g("NativeFunctionCall.Call UnaryOp value");let e=t(r.value);return this.name===P.Int?w.Create(e,h.Int):this.name===P.Float?w.Create(e,h.Float):w.Create(e,n.valueType)}}CallBinaryListOperation(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof T&&t[1]instanceof E)return this.CallListIncrementOperation(t);var e,n=f(t[0],w),i=f(t[1],w);if(!("&&"!=this.name&&"||"!=this.name||n.valueType==h.List&&i.valueType==h.List)){if(null===this._operationFuncs)return g("NativeFunctionCall._operationFuncs");let t=this._operationFuncs.get(h.Int);return null===t?g("NativeFunctionCall.CallBinaryListOperation op"):(e=(t=>{if("boolean"==typeof t)return t;throw Error(t+" is not a boolean")})(t(n.isTruthy?1:0,i.isTruthy?1:0)),new Y(e))}if(n.valueType==h.List&&i.valueType==h.List)return this.CallType([n,i]);throw new y("Can not call use "+this.name+" operation on "+h[n.valueType]+" and "+h[i.valueType])}CallListIncrementOperation(t){var a=f(t[0],T),s=f(t[1],E),o=new S;if(null===a.value)return g("NativeFunctionCall.CallListIncrementOperation listVal.value");for(let[i,r]of a.value){var l=C.fromSerializedKey(i);if(null===this._operationFuncs)return g("NativeFunctionCall._operationFuncs");let t=this._operationFuncs.get(h.Int);if(null===s.value)return g("NativeFunctionCall.CallListIncrementOperation intVal.value");let e=t(r,s.value),n=null;if(null===a.value.origins)return g("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");for(let t of a.value.origins)if(t.name==l.originName){n=t;break}if(null!=n){let t=n.TryGetItemWithValue(e,C.Null);t.exists&&o.Add(t.result,e)}}return new T(o)}CoerceValuesToSingleType(n){let i=h.Int,r=null;for(let e of n){let t=f(e,w);t.valueType>i&&(i=t.valueType),t.valueType==h.List&&(r=d(t,T))}var a=[];if(h[i]==h[h.List])for(let t of n){let i=f(t,w);if(i.valueType==h.List)a.push(i);else{if(i.valueType!=h.Int){let t=h[i.valueType];throw new y("Cannot mix Lists and "+t+" values in this operation")}{let e=parseInt(i.valueObject);if(null===(r=f(r,T)).value)return g("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");var s=r.value.originOfMaxItem;if(null===s)return g("NativeFunctionCall.CoerceValuesToSingleType list");let n=s.TryGetItemWithValue(e,C.Null);if(!n.exists)throw new y("Could not find List item with the value "+e+" in "+s.name);{let t=new T(n.result,e);a.push(t)}}}}else for(let e of n){let t=f(e,w).Cast(i);a.push(t)}return a}constructor(){if(super(),this._name=null,this._numberOfParameters=0,this._prototype=null,this._isPrototype=!1,this._operationFuncs=null,0===arguments.length)P.GenerateNativeFunctionsIfNecessary();else if(1===arguments.length){var t=arguments[0];P.GenerateNativeFunctionsIfNecessary(),this.name=t}else if(2===arguments.length){let t=arguments[0],e=arguments[1];this._isPrototype=!0,this.name=t,this.numberOfParameters=e}}static Identity(t){return t}static GenerateNativeFunctionsIfNecessary(){null==this._nativeFunctions&&(this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,(t,e)=>t+e),this.AddIntBinaryOp(this.Subtract,(t,e)=>t-e),this.AddIntBinaryOp(this.Multiply,(t,e)=>t*e),this.AddIntBinaryOp(this.Divide,(t,e)=>Math.floor(t/e)),this.AddIntBinaryOp(this.Mod,(t,e)=>t%e),this.AddIntUnaryOp(this.Negate,t=>-t),this.AddIntBinaryOp(this.Equal,(t,e)=>t==e),this.AddIntBinaryOp(this.Greater,(t,e)=>e<t),this.AddIntBinaryOp(this.Less,(t,e)=>t<e),this.AddIntBinaryOp(this.GreaterThanOrEquals,(t,e)=>e<=t),this.AddIntBinaryOp(this.LessThanOrEquals,(t,e)=>t<=e),this.AddIntBinaryOp(this.NotEquals,(t,e)=>t!=e),this.AddIntUnaryOp(this.Not,t=>0==t),this.AddIntBinaryOp(this.And,(t,e)=>0!=t&&0!=e),this.AddIntBinaryOp(this.Or,(t,e)=>0!=t||0!=e),this.AddIntBinaryOp(this.Max,(t,e)=>Math.max(t,e)),this.AddIntBinaryOp(this.Min,(t,e)=>Math.min(t,e)),this.AddIntBinaryOp(this.Pow,(t,e)=>Math.pow(t,e)),this.AddIntUnaryOp(this.Floor,P.Identity),this.AddIntUnaryOp(this.Ceiling,P.Identity),this.AddIntUnaryOp(this.Int,P.Identity),this.AddIntUnaryOp(this.Float,t=>t),this.AddFloatBinaryOp(this.Add,(t,e)=>t+e),this.AddFloatBinaryOp(this.Subtract,(t,e)=>t-e),this.AddFloatBinaryOp(this.Multiply,(t,e)=>t*e),this.AddFloatBinaryOp(this.Divide,(t,e)=>t/e),this.AddFloatBinaryOp(this.Mod,(t,e)=>t%e),this.AddFloatUnaryOp(this.Negate,t=>-t),this.AddFloatBinaryOp(this.Equal,(t,e)=>t==e),this.AddFloatBinaryOp(this.Greater,(t,e)=>e<t),this.AddFloatBinaryOp(this.Less,(t,e)=>t<e),this.AddFloatBinaryOp(this.GreaterThanOrEquals,(t,e)=>e<=t),this.AddFloatBinaryOp(this.LessThanOrEquals,(t,e)=>t<=e),this.AddFloatBinaryOp(this.NotEquals,(t,e)=>t!=e),this.AddFloatUnaryOp(this.Not,t=>0==t),this.AddFloatBinaryOp(this.And,(t,e)=>0!=t&&0!=e),this.AddFloatBinaryOp(this.Or,(t,e)=>0!=t||0!=e),this.AddFloatBinaryOp(this.Max,(t,e)=>Math.max(t,e)),this.AddFloatBinaryOp(this.Min,(t,e)=>Math.min(t,e)),this.AddFloatBinaryOp(this.Pow,(t,e)=>Math.pow(t,e)),this.AddFloatUnaryOp(this.Floor,t=>Math.floor(t)),this.AddFloatUnaryOp(this.Ceiling,t=>Math.ceil(t)),this.AddFloatUnaryOp(this.Int,t=>Math.floor(t)),this.AddFloatUnaryOp(this.Float,P.Identity),this.AddStringBinaryOp(this.Add,(t,e)=>t+e),this.AddStringBinaryOp(this.Equal,(t,e)=>t===e),this.AddStringBinaryOp(this.NotEquals,(t,e)=>!(t===e)),this.AddStringBinaryOp(this.Has,(t,e)=>t.includes(e)),this.AddStringBinaryOp(this.Hasnt,(t,e)=>!t.includes(e)),this.AddListBinaryOp(this.Add,(t,e)=>t.Union(e)),this.AddListBinaryOp(this.Subtract,(t,e)=>t.Without(e)),this.AddListBinaryOp(this.Has,(t,e)=>t.Contains(e)),this.AddListBinaryOp(this.Hasnt,(t,e)=>!t.Contains(e)),this.AddListBinaryOp(this.Intersect,(t,e)=>t.Intersect(e)),this.AddListBinaryOp(this.Equal,(t,e)=>t.Equals(e)),this.AddListBinaryOp(this.Greater,(t,e)=>t.GreaterThan(e)),this.AddListBinaryOp(this.Less,(t,e)=>t.LessThan(e)),this.AddListBinaryOp(this.GreaterThanOrEquals,(t,e)=>t.GreaterThanOrEquals(e)),this.AddListBinaryOp(this.LessThanOrEquals,(t,e)=>t.LessThanOrEquals(e)),this.AddListBinaryOp(this.NotEquals,(t,e)=>!t.Equals(e)),this.AddListBinaryOp(this.And,(t,e)=>0<t.Count&&0<e.Count),this.AddListBinaryOp(this.Or,(t,e)=>0<t.Count||0<e.Count),this.AddListUnaryOp(this.Not,t=>0==t.Count?1:0),this.AddListUnaryOp(this.Invert,t=>t.inverse),this.AddListUnaryOp(this.All,t=>t.all),this.AddListUnaryOp(this.ListMin,t=>t.MinAsList()),this.AddListUnaryOp(this.ListMax,t=>t.MaxAsList()),this.AddListUnaryOp(this.Count,t=>t.Count),this.AddListUnaryOp(this.ValueOfList,t=>t.maxItem.Value),this.AddOpToNativeFunc(this.Equal,2,h.DivertTarget,(t,e)=>t.Equals(e)),this.AddOpToNativeFunc(this.NotEquals,2,h.DivertTarget,(t,e)=>!t.Equals(e)))}AddOpFuncForType(t,e){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}static AddOpToNativeFunc(t,e,n,i){if(null===this._nativeFunctions)return g("NativeFunctionCall._nativeFunctions");let r=this._nativeFunctions.get(t);r||(r=new P(t,e),this._nativeFunctions.set(t,r)),r.AddOpFuncForType(n,i)}static AddIntBinaryOp(t,e){this.AddOpToNativeFunc(t,2,h.Int,e)}static AddIntUnaryOp(t,e){this.AddOpToNativeFunc(t,1,h.Int,e)}static AddFloatBinaryOp(t,e){this.AddOpToNativeFunc(t,2,h.Float,e)}static AddFloatUnaryOp(t,e){this.AddOpToNativeFunc(t,1,h.Float,e)}static AddStringBinaryOp(t,e){this.AddOpToNativeFunc(t,2,h.String,e)}static AddListBinaryOp(t,e){this.AddOpToNativeFunc(t,2,h.List,e)}static AddListUnaryOp(t,e){this.AddOpToNativeFunc(t,1,h.List,e)}toString(){return'Native "'+this.name+'"'}}P.Add="+",P.Subtract="-",P.Divide="/",P.Multiply="*",P.Mod="%",P.Negate="_",P.Equal="==",P.Greater=">",P.Less="<",P.GreaterThanOrEquals=">=",P.LessThanOrEquals="<=",P.NotEquals="!=",P.Not="!",P.And="&&",P.Or="||",P.Min="MIN",P.Max="MAX",P.Pow="POW",P.Floor="FLOOR",P.Ceiling="CEILING",P.Int="INT",P.Float="FLOAT",P.Has="?",P.Hasnt="!?",P.Intersect="^",P.ListMin="LIST_MIN",P.ListMax="LIST_MAX",P.All="LIST_ALL",P.Count="LIST_COUNT",P.ValueOfList="LIST_VALUE",P.Invert="LIST_INVERT",P._nativeFunctions=null;class N extends I{constructor(t,e){if(super(),this.isInt=()=>"int"==this.subtype,this.isFloat=()=>"float"==this.subtype,this.isBool=()=>"bool"==this.subtype,this.GenerateIntoContainer=t=>{this.isInt()?t.AddContent(new E(this.value)):this.isFloat()?t.AddContent(new Z(this.value)):this.isBool()&&t.AddContent(new Y(this.value))},this.toString=()=>""+this.value,("number"!=typeof t||Number.isNaN(t))&&"boolean"!=typeof t)throw Error("Unexpected object type in NumberExpression.");this.value=t,this.subtype=e}get typeName(){return"Number"}Equals(t){t=d(t,N);return!!t&&t.subtype==this.subtype&&t.value==this.value}}class it extends I{get nativeNameForOp(){return"-"===this.op?"_":"not"===this.op?"!":this.op}constructor(t,e){super(),this.op=e,this.GenerateIntoContainer=t=>{this.innerExpression.GenerateIntoContainer(t),t.AddContent(P.CallWithName(this.nativeNameForOp))},this.toString=()=>this.nativeNameForOp+this.innerExpression,this.innerExpression=this.AddContent(t)}get typeName(){return"UnaryExpression"}}it.WithInner=(t,e)=>{var n=d(t,N);if(n){if("-"===e){if(n.isInt())return new N(-n.value,"int");if(n.isFloat())return new N(-n.value,"float")}else if("!"==e||"not"==e){if(n.isInt())return new N(0==n.value,"bool");if(n.isFloat())return new N(0==n.value,"bool");if(n.isBool())return new N(!n.value,"bool")}throw Error("Unexpected operation or number type")}return new it(t,e)};class rt extends I{constructor(t,e,n){super(),this.opName=n,this.GenerateIntoContainer=t=>{this.leftExpression.GenerateIntoContainer(t),this.rightExpression.GenerateIntoContainer(t),this.opName=this.NativeNameForOp(this.opName),t.AddContent(P.CallWithName(this.opName))},this.NativeNameForOp=t=>"and"===t?"&&":"or"===t?"||":"mod"===t?"%":"has"===t?"?":"hasnt"===t?"!?":t,this.toString=()=>`(${this.leftExpression} ${this.opName} ${this.rightExpression})`,this.leftExpression=this.AddContent(t),this.rightExpression=this.AddContent(e),this.opName=n}get typeName(){return"BinaryExpression"}ResolveReferences(t){if(super.ResolveReferences(t),"?"===this.NativeNameForOp(this.opName)){let t=d(this.leftExpression,it);null===t||"not"!==t.op&&"!"!==t.op||this.Error(`Using 'not' or '!' here negates '${t.innerExpression}' rather than the result of the '?' or 'has' operator. You need to add parentheses around the (A ? B) expression.`)}}}class O{constructor(t){this.set=new Set,this.Add=t=>this.set.add(t),this.AddRange=(e,n)=>{for(let t=e.charCodeAt(0);t<=n.charCodeAt(0);++t)this.Add(String.fromCharCode(t));return this},this.AddCharacters=e=>{if("string"==typeof e||Array.isArray(e))for(var t of e)this.Add(t);else for(let t of e.set)this.Add(t);return this},t&&this.AddCharacters(t)}}O.FromRange=(t,e)=>(new O).AddRange(t,e);class at{constructor(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];if(this._start=t,this._end=e,this._correspondingCharSet=new O,this._excludes=new Set,this.ToCharacterSet=()=>{if(0===this._correspondingCharSet.set.size)for(let t,e=this.start.charCodeAt(0);e<=this.end.charCodeAt(0);e+=1)t=String.fromCharCode(e),this._excludes.has(t)||this._correspondingCharSet.AddCharacters(t);return this._correspondingCharSet},n instanceof O)this._excludes=n.set;else for(let t of n)this._excludes.add(t)}get start(){return this._start}get end(){return this._end}}at.Define=function(t,e){return new at(t,e,2<arguments.length&&void 0!==arguments[2]?arguments[2]:[])};class st extends v{constructor(){var t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];super(),this._pathOnChoice=null,this.hasCondition=!1,this.hasStartContent=!1,this.hasChoiceOnlyContent=!1,this.isInvisibleDefault=!1,this.onceOnly=!0,this.onceOnly=t}get pathOnChoice(){var t;return null!=this._pathOnChoice&&this._pathOnChoice.isRelative&&(t=this.choiceTarget)&&(this._pathOnChoice=t.path),this._pathOnChoice}set pathOnChoice(t){this._pathOnChoice=t}get choiceTarget(){return null===this._pathOnChoice?g("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}get pathStringOnChoice(){return null===this.pathOnChoice?g("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)}set pathStringOnChoice(t){this.pathOnChoice=new m(t)}get flags(){let t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t}set flags(t){this.hasCondition=0<(1&t),this.hasStartContent=0<(2&t),this.hasChoiceOnlyContent=0<(4&t),this.isInvisibleDefault=0<(8&t),this.onceOnly=0<(16&t)}toString(){return null===this.pathOnChoice?g("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice}}(t=>{t[t.Tunnel=0]="Tunnel",t[t.Function=1]="Function",t[t.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"})(u=u||{});class F{constructor(){this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}Resolve(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index<this.container.content.length?this.container.content[this.index]:null}get isNull(){return null==this.container}get path(){return this.isNull?null:this.index<0?this.container.path:this.container.path.PathByAppendingComponent(new m.Component(this.index))}toString(){return this.container?"Ink Pointer -> "+this.container.path+" -- index "+this.index:"Ink Pointer (null)"}copy(){return new F(this.container,this.index)}static StartOf(t){return new F(t,0)}static get Null(){return new F(null,-1)}}let W=class s extends v{get targetPath(){var t;return null!=this._targetPath&&this._targetPath.isRelative&&(t=this.targetPointer.Resolve())&&(this._targetPath=t.path),this._targetPath}set targetPath(t){this._targetPath=t,this._targetPointer=F.Null}get targetPointer(){if(this._targetPointer.isNull){var t=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return g("this._targetPath");if(null===this._targetPath.lastComponent)return g("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===t)return g("targetObj");this._targetPointer.container=t.parent instanceof A?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=F.StartOf(t instanceof A?t:null)}return this._targetPointer.copy()}get targetPathString(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)}set targetPathString(t){this.targetPath=null==t?null:new m(t)}get hasVariableTarget(){return null!=this.variableDivertName}constructor(t){super(),this._targetPath=null,this._targetPointer=F.Null,this.variableDivertName=null,this.pushesToStack=!1,this.stackPushType=0,this.isExternal=!1,this.externalArgs=0,this.isConditional=!1,this.pushesToStack=!1,void 0!==t&&(this.pushesToStack=!0,this.stackPushType=t)}Equals(t){return t instanceof s&&this.hasVariableTarget==t.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==t.variableDivertName:null===this.targetPath?g("this.targetPath"):this.targetPath.Equals(t.targetPath))}toString(){var t,e;return this.hasVariableTarget?"Divert(variable: "+this.variableDivertName+")":null==this.targetPath?"Divert(null)":(t=new b,e=""+this.targetPath,t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&t.Append(this.stackPushType==u.Function?" function":" tunnel"),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),""+t)}},ot=((t=>{t[t.Knot=0]="Knot",t[t.List=1]="List",t[t.ListItem=2]="ListItem",t[t.Var=3]="Var",t[t.SubFlowAndWeave=4]="SubFlowAndWeave",t[t.Arg=5]="Arg",t[t.Temp=6]="Temp"})(l=l||{}),class extends v{constructor(t,e){super(),this.variableName=t||null,this.isNewDeclaration=!!e,this.isGlobal=!1}toString(){return"VarAssign to "+this.variableName}}),k=class extends p{get runtimeChoice(){if(this._runtimeChoice)return this._runtimeChoice;throw Error()}get name(){var t;return(null==(t=this.identifier)?void 0:t.name)||null}get condition(){return this._condition}set condition(t){(this._condition=t)&&this.AddContent(t)}get runtimeContainer(){return this._innerContentContainer}get innerContentContainer(){return this._innerContentContainer}get containerForCounting(){return this._innerContentContainer}get runtimePath(){if(this.innerContentContainer&&this.innerContentContainer.path)return this.innerContentContainer.path;throw Error()}constructor(t,e,n){super(),this._condition=null,this._innerContentContainer=null,this._outerContainer=null,this._runtimeChoice=null,this._returnToR1=null,this._returnToR2=null,this._r1Label=null,this._r2Label=null,this._divertToStartContentOuter=null,this._divertToStartContentInner=null,this._startContentRuntimeContainer=null,this.isInvisibleDefault=!1,this.hasWeaveStyleInlineBrackets=!1,this.GenerateRuntimeObject=()=>{var t;if(this._outerContainer=new A,this._runtimeChoice=new st(this.onceOnly),this._runtimeChoice.isInvisibleDefault=this.isInvisibleDefault,(this.startContent||this.choiceOnlyContent||this.condition)&&this._outerContainer.AddContent(x.EvalStart()),this.startContent&&(this._returnToR1=new Q,this._outerContainer.AddContent(this._returnToR1),t=new ot("$r",!0),this._outerContainer.AddContent(t),this._outerContainer.AddContent(x.BeginString()),this._divertToStartContentOuter=new W,this._outerContainer.AddContent(this._divertToStartContentOuter),this._startContentRuntimeContainer=this.startContent.GenerateRuntimeObject(),this._startContentRuntimeContainer.name="s",(t=new W).variableDivertName="$r",this._startContentRuntimeContainer.AddContent(t),this._outerContainer.AddToNamedContentOnly(this._startContentRuntimeContainer),this._r1Label=new A,this._r1Label.name="$r1",this._outerContainer.AddContent(this._r1Label),this._outerContainer.AddContent(x.EndString()),this._runtimeChoice.hasStartContent=!0),this.choiceOnlyContent){this._outerContainer.AddContent(x.BeginString());let t=this.choiceOnlyContent.GenerateRuntimeObject();this._outerContainer.AddContentsOfContainer(t),this._outerContainer.AddContent(x.EndString()),this._runtimeChoice.hasChoiceOnlyContent=!0}if(this.condition&&(this.condition.GenerateIntoContainer(this._outerContainer),this._runtimeChoice.hasCondition=!0),(this.startContent||this.choiceOnlyContent||this.condition)&&this._outerContainer.AddContent(x.EvalEnd()),this._outerContainer.AddContent(this._runtimeChoice),this._innerContentContainer=new A,this.startContent){this._returnToR2=new Q,this._innerContentContainer.AddContent(x.EvalStart()),this._innerContentContainer.AddContent(this._returnToR2),this._innerContentContainer.AddContent(x.EvalEnd());let t=new ot("$r",!0);this._innerContentContainer.AddContent(t),this._divertToStartContentInner=new W,this._innerContentContainer.AddContent(this._divertToStartContentInner),this._r2Label=new A,this._r2Label.name="$r2",this._innerContentContainer.AddContent(this._r2Label)}if(this.innerContent){let t=this.innerContent.GenerateRuntimeObject();this._innerContentContainer.AddContentsOfContainer(t)}return this.story.countAllVisits&&(this._innerContentContainer.visitsShouldBeCounted=!0),this._innerContentContainer.countingAtStartOnly=!0,this._outerContainer},this.toString=()=>null!==this.choiceOnlyContent?`* ${this.startContent}[${this.choiceOnlyContent}]...`:`* ${this.startContent}...`,this.startContent=t,this.choiceOnlyContent=e,this.innerContent=n,this.indentationDepth=1,t&&this.AddContent(this.startContent),e&&this.AddContent(this.choiceOnlyContent),n&&this.AddContent(this.innerContent),this.onceOnly=!0}get typeName(){return"Choice"}ResolveReferences(t){var e;if(this._innerContentContainer&&(this.runtimeChoice.pathOnChoice=this._innerContentContainer.path,this.onceOnly)&&(this._innerContentContainer.visitsShouldBeCounted=!0),this._returnToR1){if(!this._r1Label)throw Error();this._returnToR1.targetPath=this._r1Label.path}if(this._returnToR2){if(!this._r2Label)throw Error();this._returnToR2.targetPath=this._r2Label.path}if(this._divertToStartContentOuter){if(!this._startContentRuntimeContainer)throw Error();this._divertToStartContentOuter.targetPath=this._startContentRuntimeContainer.path}if(this._divertToStartContentInner){if(!this._startContentRuntimeContainer)throw Error();this._divertToStartContentInner.targetPath=this._startContentRuntimeContainer.path}super.ResolveReferences(t),this.identifier&&0<((null==(e=this.identifier)?void 0:e.name)||"").length&&t.CheckForNamingCollisions(this,this.identifier,l.SubFlowAndWeave)}};class lt{constructor(){this.characterIndex=0,this.characterInLineIndex=0,this.lineIndex=0,this.reportedErrorInScope=!1,this.uniqueId=0,this.customFlags=0,this.CopyFrom=t=>{lt._uniqueIdCounter++,this.uniqueId=lt._uniqueIdCounter,this.characterIndex=t.characterIndex,this.characterInLineIndex=t.characterInLineIndex,this.lineIndex=t.lineIndex,this.customFlags=t.customFlags,this.reportedErrorInScope=!1},this.SquashFrom=t=>{this.characterIndex=t.characterIndex,this.characterInLineIndex=t.characterInLineIndex,this.lineIndex=t.lineIndex,this.reportedErrorInScope=t.reportedErrorInScope,this.customFlags=t.customFlags}}}lt._uniqueIdCounter=1e3;class ht{get currentElement(){return this._stack[this._numElements-1]}get lineIndex(){return this.currentElement.lineIndex}set lineIndex(t){this.currentElement.lineIndex=t}get characterIndex(){return this.currentElement.characterIndex}set characterIndex(t){this.currentElement.characterIndex=t}get characterInLineIndex(){return this.currentElement.characterInLineIndex}set characterInLineIndex(t){this.currentElement.characterInLineIndex=t}get customFlags(){return this.currentElement.customFlags}set customFlags(t){this.currentElement.customFlags=t}get errorReportedAlreadyInScope(){return this.currentElement.reportedErrorInScope}get stackHeight(){return this._numElements}constructor(){this._stack=[],this._numElements=0,this.StringParserState=()=>{this._stack=Array(200);for(let t=0;t<200;++t)this._stack[t]=new lt;this._numElements=1},this.Push=()=>{if(this._stack.length<=this._numElements&&0<this._numElements)throw Error("Stack overflow in parser state.");var t=this._stack[this._numElements-1],e=this._stack[this._numElements];return this._numElements++,e.CopyFrom(t),e.uniqueId},this.Pop=t=>{if(1==this._numElements)throw Error("Attempting to remove final stack element is illegal! Mismatched Begin/Succceed/Fail?");if(this.currentElement.uniqueId!=t)throw Error("Mismatched rule IDs while Poping - do you have mismatched Begin/Succeed/Fail?");--this._numElements},this.Peek=t=>{if(this.currentElement.uniqueId!=t)throw Error("Mismatched rule IDs while Peeking - do you have mismatched Begin/Succeed/Fail?");return this._stack[this._numElements-1]},this.PeekPenultimate=()=>this._numElements<2?null:this._stack[this._numElements-2],this.Squash=()=>{if(this._numElements<2)throw Error("Attempting to remove final stack element is illegal! Mismatched Begin/Succceed/Fail?");this._stack[this._numElements-2].SquashFrom(this._stack[this._numElements-1]),--this._numElements},this.NoteErrorReported=()=>{for(var t of this._stack)t.reportedErrorInScope=!0};for(let t=0;t<200;t++)this._stack[t]=new lt;this._numElements=1}}let ut=Symbol("ParseSuccessStruct");class ct{constructor(t){var h=this,e=(this.ParseRule=null,this.errorHandler=null,this.hadError=!1,this.BeginRule=()=>this.state.Push(),this.FailRule=t=>(this.state.Pop(t),null),this.CancelRule=t=>{this.state.Pop(t)},this.SucceedRule=function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,t=h.state.Peek(t),n=h.state.PeekPenultimate();h.RuleDidSucceed&&h.RuleDidSucceed(e,n,t),h.state.Squash();let i=e;return i=null===i?ct.ParseSuccess:i},this.Expect=function(t){let e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=h.ParseObject(t);return i=null===i&&(null===e&&(e=t.name),t=h.LineRemainder(),h.Error(`Expected ${e} but saw `+(null===t||0===t.length?"end of line":`'${t}'`)),null!==n)?n():i},this.Error=function(t){h.ErrorOnLine(t,h.lineIndex+1,1<arguments.length&&void 0!==arguments[1]&&arguments[1])},this.ErrorWithParsedObject=function(t,e){h.ErrorOnLine(t,e.debugMetadata?e.debugMetadata.startLineNumber:-1,2<arguments.length&&void 0!==arguments[2]&&arguments[2])},this.ErrorOnLine=(t,e,n)=>{if(!this.state.errorReportedAlreadyInScope){if(!this.errorHandler)throw Error((n?"Warning":"Error")+` on line ${e}: `+t);this.errorHandler(t,this.index,e-1,n),this.state.NoteErrorReported()}n||(this.hadError=!0)},this.Warning=t=>this.Error(t,!0),this.LineRemainder=()=>this.Peek(()=>this.ParseUntilCharactersFromString("\n\r")),this.SetFlag=(t,e)=>{e?this.state.customFlags|=t:this.state.customFlags&=~t},this.GetFlag=t=>!!(this.state.customFlags&t),this.ParseObject=t=>{var e=this.BeginRule(),n=this.state.stackHeight,t=t();if(n!==this.state.stackHeight)throw Error("Mismatched Begin/Fail/Succeed rules");return null===t?this.FailRule(e):(this.SucceedRule(e,t),t)},this.Parse=t=>{var e=this.BeginRule(),t=t();return null===t?(this.FailRule(e),null):(this.SucceedRule(e,t),t)},this.OneOf=t=>{for(var e of t){let t=this.ParseObject(e);if(null!==t)return t}return null},this.OneOrMore=t=>{for(var e,n=[];null!==(e=this.ParseObject(t))&&n.push(e),null!==e;);return 0<n.length?n:null},this.Optional=e=>()=>{var t=this.ParseObject(e);return null===t?ct.ParseSuccess:t},this.Exclude=t=>()=>this.ParseObject(t)&&ct.ParseSuccess,this.OptionalExclude=t=>()=>(this.ParseObject(t),ct.ParseSuccess),this.String=t=>()=>this.ParseString(t),this.TryAddResultToList=function(t,n){let e=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];if(t!==ct.ParseSuccess){if(e&&Array.isArray(t)){let e=t;if(null!==e){for(let t of e)n.push(t);return}}n.push(t)}},this.Interleave=function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=!(3<arguments.length&&void 0!==arguments[3])||arguments[3],r=h.BeginRule(),a=[],s=h.ParseObject(t);if(null===s)return h.FailRule(r);h.TryAddResultToList(s,a,i);let o=null,l=null;do{if(null!==n&&null!==h.Peek(n))break;if(null===(o=h.ParseObject(e)))break;if(h.TryAddResultToList(o,a,i),(l=null)!==o){if(null===(l=h.ParseObject(t)))break;h.TryAddResultToList(l,a,i)}}while((null!==o||null!==l)&&(o!==ct.ParseSuccess||l!=ct.ParseSuccess)&&0<h.remainingLength);return 0===a.length?h.FailRule(r):h.SucceedRule(r,a)},this.ParseString=e=>{if(this.remainingLength<e.length)return null;var t=this.BeginRule();let n=this.index,i=this.characterInLineIndex,r=this.lineIndex,a=!0;for(let t=0;t<e.length;t+=1){var s=e[t];if(this._chars[n]!==s){a=!1;break}"\n"===s&&(r++,i=-1),n++,i++}return this.index=n,this.characterInLineIndex=i,this.lineIndex=r,a?this.SucceedRule(t,e):this.FailRule(t)},this.ParseSingleCharacter=()=>{var t;return 0<this.remainingLength?("\n"===(t=this._chars[this.index])&&(this.lineIndex+=1,this.characterInLineIndex=-1),this.index+=1,this.characterInLineIndex+=1,t):"0"},this.ParseUntilCharactersFromString=function(t){return h.ParseCharactersFromString(t,!1,1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1)},this.ParseUntilCharactersFromCharSet=function(t){return h.ParseCharactersFromCharSet(t,!1,1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1)},this.ParseCharactersFromString=function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:-1,t=new O(t);return"number"==typeof e?h.ParseCharactersFromCharSet(t,!0,e):h.ParseCharactersFromCharSet(t,e,n)},this.ParseCharactersFromCharSet=function(t){let e=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:-1;-1===n&&(n=Number.MAX_SAFE_INTEGER);var i=h.index;let r=h.index,a=h.characterInLineIndex,s=h.lineIndex,o=0;for(;r<h._chars.length&&t.set.has(h._chars[r])===e&&o<n;)"\n"===h._chars[r]&&(s+=1,a=-1),r+=1,a+=1,o+=1;return h.index=r,h.characterInLineIndex=a,h.lineIndex=s,i<h.index?h._chars.slice(i,h.index).join(""):null},this.Peek=t=>{var e=this.BeginRule(),t=t();return this.CancelRule(e),t},this.ParseInt=()=>{var t=this.index,e=this.characterInLineIndex,n=null!==this.ParseString("-"),i=(this.ParseCharactersFromString(" \t"),this.ParseCharactersFromCharSet(ct.numbersCharacterSet));return null===i?(this.index=t,this.characterInLineIndex=e,null):Number.isNaN(+(""+i))?(this.Error("Failed to read integer value: "+i+". Perhaps it's out of the range of acceptable numbers ink supports? ("+Number.MIN_SAFE_INTEGER+" to "+Number.MAX_SAFE_INTEGER+")"),null):(t=+(""+i),n?-t:t)},this.ParseFloat=()=>{let t=this.index,e=this.characterInLineIndex,n=this.ParseInt();if(null===n||null===this.ParseString("."))return this.index=t,this.characterInLineIndex=e,null;{let t=this.ParseCharactersFromCharSet(ct.numbersCharacterSet);return+(n+"."+t)}},this.ParseNewline=()=>{var t=this.BeginRule();return this.ParseString("\r"),null===this.ParseString("\n")?this.FailRule(t):this.SucceedRule(t,"\n")},this.PreProcessInputString(t));this.state=new ht,this._chars=t?e.split(""):[],this.inputString=e}get currentCharacter(){return 0<=this.index&&0<this.remainingLength?this._chars[this.index]:"0"}PreProcessInputString(t){return t}get endOfInput(){return this._chars.length<=this.index}get remainingString(){return this._chars.slice(this.index,this.index+this.remainingLength).join("")}get remainingLength(){return this._chars.length-this.index}get lineIndex(){return this.state.lineIndex}set lineIndex(t){this.state.lineIndex=t}set characterInLineIndex(t){this.state.characterInLineIndex=t}get characterInLineIndex(){return this.state.characterInLineIndex}get index(){return this.state.characterIndex}set index(t){this.state.characterIndex=t}ParseUntil(e){let n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;var i=this.BeginRule(),r=new O;null!==n&&(r.set=new Set([...r.set.values(),...n.set.values()])),null!==t&&(r.set=new Set([...r.set.values(),...t.set.values()]));let a="";for(;;){let t=this.ParseUntilCharactersFromCharSet(r);if(t&&(a+=t),null!==this.Peek(e))break;{if(this.endOfInput)break;let t=this.currentCharacter;if(null===n||!n.set.has(t))break;a+=t,"\n"===t&&(this.lineIndex+=1,this.characterInLineIndex=-1),this.index+=1,this.characterInLineIndex+=1}}return 0<a.length?this.SucceedRule(i,""+a):this.FailRule(i)}}ct.ParseSuccess=ut,ct.numbersCharacterSet=new O("0123456789");class dt extends ct{constructor(){super(...arguments),this._commentOrNewlineStartCharacter=new O("/\r\n"),this._commentBlockEndCharacter=new O("*"),this._newlineCharacters=new O("\n\r"),this.Process=()=>{var t=this.Interleave(this.Optional(this.CommentsAndNewlines),this.Optional(this.MainInk));return null!==t?t.join(""):""},this.MainInk=()=>this.ParseUntil(this.CommentsAndNewlines,this._commentOrNewlineStartCharacter,null),this.CommentsAndNewlines=()=>{var t=this.Interleave(this.Optional(this.ParseNewline),this.Optional(this.ParseSingleComment));return null!==t?t.join(""):null},this.ParseSingleComment=()=>this.OneOf([this.EndOfLineComment,this.BlockComment]),this.EndOfLineComment=()=>null===this.ParseString("//")?null:(this.ParseUntilCharactersFromCharSet(this._newlineCharacters),""),this.BlockComment=()=>{var t,e;return null!==this.ParseString("/*")&&(t=this.lineIndex,e=this.ParseUntil(this.String("*/"),this._commentBlockEndCharacter,null),this.endOfInput||this.ParseString("*/"),null!=e)?"\n".repeat(this.lineIndex-t):null}}PreProcessInputString(t){return t}}class ft extends p{constructor(t,e){super(),this.initialCondition=t,this.branches=e,this._reJoinTarget=null,this.GenerateRuntimeObject=()=>{var t,e=new A;this.initialCondition&&e.AddContent(this.initialCondition.runtimeObject);for(t of this.branches){var n=t.runtimeObject;e.AddContent(n)}return null===this.initialCondition||null===this.branches[0].ownExpression||this.branches[this.branches.length-1].isElse||e.AddContent(x.PopEvaluatedValue()),this._reJoinTarget=x.NoOp(),e.AddContent(this._reJoinTarget),e},this.initialCondition&&this.AddContent(this.initialCondition),null!==this.branches&&this.AddContent(this.branches)}get typeName(){return"Conditional"}ResolveReferences(t){var e=this._reJoinTarget.path;for(let t of this.branches){if(!t.returnDivert)throw Error();t.returnDivert.targetPath=e}super.ResolveReferences(t)}}class R extends p{constructor(t){super(),this.text=t,this.GenerateRuntimeObject=()=>new _(this.text),this.toString=()=>this.text}get typeName(){return"Text"}}class pt extends p{get constantName(){var t;return null==(t=this.constantIdentifier)?void 0:t.name}get expression(){if(this._expression)return this._expression;throw Error()}constructor(t,e){super(),this._expression=null,this.GenerateRuntimeObject=()=>null,this.constantIdentifier=t,e&&(this._expression=this.AddContent(e))}get typeName(){return"CONST"}ResolveReferences(t){super.ResolveReferences(t),t.CheckForNamingCollisions(this,this.constantIdentifier,l.Var)}}(t=>{t[t.Story=0]="Story",t[t.Knot=1]="Knot",t[t.Stitch=2]="Stitch",t[t.WeavePoint=3]="WeavePoint"})(c=c||{});class mt extends p{get name(){var t;return(null==(t=this.identifier)?void 0:t.name)||null}get runtimeContainer(){return this.runtimeObject}constructor(t,e){super(),this.indentationDepth=e,this.GenerateRuntimeObject=()=>{var t=new A;if(t.name=this.name,this.story.countAllVisits&&(t.visitsShouldBeCounted=!0),t.countingAtStartOnly=!0,this.content)for(var e of this.content)t.AddContent(e.runtimeObject);return t},this.toString=()=>{var t;return"- "+(null!=(t=this.identifier)&&t.name?"("+(null==(t=this.identifier)?void 0:t.name)+")":"gather")},t&&(this.identifier=t)}get typeName(){return"Gather"}ResolveReferences(t){super.ResolveReferences(t),this.identifier&&0<(this.identifier.name||"").length&&t.CheckForNamingCollisions(this,this.identifier,l.SubFlowAndWeave)}}class gt{get baseTargetLevel(){return this.baseLevelIsAmbiguous?c.Story:this._baseTargetLevel}get baseLevelIsAmbiguous(){return!this._baseTargetLevel}get firstComponent(){return null!=this.components&&this.components.length?this.components[0].name:null}get numberOfComponents(){return this.components?this.components.length:0}get dotSeparatedComponents(){return null==this._dotSeparatedComponents&&(this._dotSeparatedComponents=(this.components||[]).map(t=>t.name).filter(H).join(".")),this._dotSeparatedComponents}constructor(t,e){this._dotSeparatedComponents=null,this.toString=()=>null===this.components||0===this.components.length?this.baseTargetLevel===c.WeavePoint?"-> <next gather point>":"<invalid Path>":"-> "+this.dotSeparatedComponents,this.ResolveFromContext=t=>null==this.components||0==this.components.length||null===(t=this.ResolveBaseTarget(t))?null:1<this.components.length?this.ResolveTailComponents(t):t,this.ResolveBaseTarget=t=>{var e=this.firstComponent;let n=t;for(;n;){var i=n===t,i=this.GetChildFromContext(n,e,null,i);if(i)return i;n=n.parent}return null},this.ResolveTailComponents=t=>{let e=t;if(!this.components)return null;for(let t=1;t<this.components.length;++t){var n=this.components[t].name,i=d(e,L),i=null!==i?i.flowLevel+1:c.WeavePoint;if(null===(e=this.GetChildFromContext(e,n,i)))break}return e},this.GetChildFromContext=function(t,e,n){var i=3<arguments.length&&void 0!==arguments[3]&&arguments[3],r=null===n,a=d(t,Ft);if(e&&null!==a&&(r||n===c.WeavePoint))return a.WeavePointNamed(e);r=d(t,L);if(e&&null!==r){let t=i||r.flowLevel===c.Knot;return r.ContentWithNameAtLevel(e,n,t)}return null},Object.values(c).includes(t)?(this._baseTargetLevel=t,this.components=e||[]):Array.isArray(t)?(this._baseTargetLevel=null,this.components=t||[]):(this._baseTargetLevel=null,this.components=[t])}get typeName(){return"Path"}}class vt extends p{constructor(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;super(),this.returnedExpression=null,this.GenerateRuntimeObject=()=>{var t=new A;return this.returnedExpression?t.AddContent(this.returnedExpression.runtimeObject):(t.AddContent(x.EvalStart()),t.AddContent(new nt),t.AddContent(x.EvalEnd())),t.AddContent(x.PopFunction()),t},t&&(this.returnedExpression=this.AddContent(t))}get typeName(){return"ReturnType"}}function bt(t){let e=t.parent;for(;e;){if(e.hasOwnProperty("iamFlowbase")&&e.iamFlowbase())return e;e=e.parent}return null}class Ct{constructor(t){this.debugMetadata=null,this.toString=()=>this.name||"undefined identifer",this.name=t}get typeName(){return"Identifier"}static Done(){return new Ct("DONE")}}class L extends p{get hasParameters(){return null!==this.args&&0<this.args.length}get subFlowsByName(){return this._subFlowsByName}get typeName(){return this.isFunction?"Function":""+this.flowLevel}get name(){var t;return(null==(t=this.identifier)?void 0:t.name)||null}constructor(t){var r;let e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=3<arguments.length&&void 0!==arguments[3]&&arguments[3],a=4<arguments.length&&void 0!==arguments[4]&&arguments[4];super(),(r=this).isFunction=i,this._rootWeave=null,this._subFlowsByName=new Map,this._startingSubFlowDivert=null,this._startingSubFlowRuntime=null,this._firstChildFlow=null,this.variableDeclarations=new Map,this.identifier=null,this.args=null,this.iamFlowbase=()=>!0,this.SplitWeaveAndSubFlowContent=(t,e)=>{var n,i=[],r=[];this._subFlowsByName=new Map;for(let e of t){let t=d(e,L);t?(null===this._firstChildFlow&&(this._firstChildFlow=t),r.push(e),null!=(n=t.identifier)&&n.name&&this._subFlowsByName.set(null==(n=t.identifier)?void 0:n.name,t)):i.push(e)}e&&i.push(new mt(null,1),new $(new gt(Ct.Done())));t=[];return 0<i.length&&(this._rootWeave=new Ft(i,0),t.push(this._rootWeave)),0<r.length&&t.push(...r),t},this.ResolveVariableWithName=(e,t)=>{var n,i={},r=null===t?this:bt(t);if(r){if(null!==r.args)for(let t of r.args)if((null==(n=t.identifier)?void 0:n.name)===e)return i.found=!0,i.isArgument=!0,i.ownerFlow=r,i;if(r!==this.story&&r.variableDeclarations.has(e))return i.found=!0,i.ownerFlow=r,i.isTemporary=!0,i}return this.story.variableDeclarations.has(e)?(i.found=!0,i.ownerFlow=this.story,i.isGlobal=!0):i.found=!1,i},this.AddNewVariableDeclaration=e=>{var n=e.variableName;if(this.variableDeclarations.has(n)){var i=this.variableDeclarations.get(n);let t=i.debugMetadata?` (${i.debugMetadata})`:"";void this.Error(`found declaration variable '${n}' that was already declared`+t,e,!1)}else this.variableDeclarations.set(e.variableName,e)},this.ResolveWeavePointNaming=()=>{this._rootWeave&&this._rootWeave.ResolveWeavePointNaming();for(var[,t]of this._subFlowsByName)t.hasOwnProperty("ResolveWeavePointNaming")&&t.ResolveWeavePointNaming()},this.GenerateRuntimeObject=()=>{var t;let e=null;this.isFunction?this.CheckForDisallowedFunctionFlowControl():this.flowLevel!==c.Knot&&this.flowLevel!==c.Stitch||null!==(e=this.Find(vt)())&&this.Error(`Return statements can only be used in knots that are declared as functions: == function ${this.identifier} ==`,e);var i=new A;i.name=null==(t=this.identifier)?void 0:t.name,this.story.countAllVisits&&(i.visitsShouldBeCounted=!0),this.GenerateArgumentVariableAssignments(i);let r=0;for(;null!==this.content&&r<this.content.length;){let n=this.content[r];if(n instanceof L){let e=n,t=e.runtimeObject;0!==r||e.hasParameters||this.flowLevel!==c.Knot||(this._startingSubFlowDivert=new W,i.AddContent(this._startingSubFlowDivert),this._startingSubFlowRuntime=t);var a=t,s=i.namedContent.get(a.name)||null;if(s){let t=this.GetType()+` already contains flow named '${a.name}' (at ${s.debugMetadata})`;this.Error(t,e)}i.AddToNamedContentOnly(a)}else n&&i.AddContent(n.runtimeObject);r+=1}return this.flowLevel===c.Story||this.isFunction||null===this._rootWeave||null!==e||this._rootWeave.ValidateTermination(this.WarningInTermination),i},this.GenerateArgumentVariableAssignments=e=>{if(null!==this.args&&0!==this.args.length)for(let t=this.args.length-1;0<=t;--t){var n=(null==(n=this.args[t].identifier)?void 0:n.name)||null,n=new ot(n,!0);e.AddContent(n)}},this.ContentWithNameAtLevel=function(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,i=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if((n===r.flowLevel||null===n)&&e===(null==(t=r.identifier)?void 0:t.name))return r;if(n===c.WeavePoint||null===n){let t=null;if(r._rootWeave&&(t=r._rootWeave.WeavePointNamed(e)))return t;if(n===c.WeavePoint)return i?r.DeepSearchForAnyLevelContent(e):null}return null!==n&&n<r.flowLevel?null:!(t=r._subFlowsByName.get(e)||null)||null!==n&&n!==t.flowLevel?i?r.DeepSearchForAnyLevelContent(e):null:t},this.DeepSearchForAnyLevelContent=e=>{let t=this.ContentWithNameAtLevel(e,c.WeavePoint,!1);if(t)return t;for(let[,t]of this._subFlowsByName){var n=t.ContentWithNameAtLevel(e,null,!0);if(n)return n}return null},this.CheckForDisallowedFunctionFlowControl=()=>{this.flowLevel!==c.Knot&&this.Error("Functions cannot be stitches - i.e. they should be defined as '== function myFunc ==' rather than internal to another knot.");for(let[t,e]of this._subFlowsByName)this.Error(`Functions may not contain stitches, but saw '${t}' within the function '${this.identifier}'`,e);if(!this._rootWeave)throw Error();let e=this._rootWeave.FindAll($)();for(let t of e)t.isFunctionCall||t.parent instanceof _t||this.Error(`Functions may not contain diverts, but saw '${t}'`,t);let n=this._rootWeave.FindAll(k)();for(let t of n)this.Error(`Functions may not contain choices, but saw '${t}'`,t)},this.WarningInTermination=t=>{let e="Apparent loose end exists where the flow runs out. Do you need a '-> DONE' statement, choice or divert?";t.parent===this._rootWeave&&this._firstChildFlow&&(e+=` Note that if you intend to enter '${this._firstChildFlow.identifier}' next, you need to divert to it explicitly.`);var n=d(t,$);n&&n.isTunnel&&(e+=` When final tunnel to '${n.target} ->' returns it won't have anywhere to go.`),this.Warning(e,t)},this.toString=()=>this.typeName+` '${this.identifier}'`,this.identifier=t,this.args=n,null===e&&(e=[]),this.PreProcessTopLevelObjects(e),e=this.SplitWeaveAndSubFlowContent(e,"Story"==this.GetType()&&!a),this.AddContent(e)}PreProcessTopLevelObjects(t){}ResolveReferences(e){var n;if(this._startingSubFlowDivert){if(!this._startingSubFlowRuntime)throw Error();this._startingSubFlowDivert.targetPath=this._startingSubFlowRuntime.path}if(super.ResolveReferences(e),null!==this.args){for(let t of this.args)e.CheckForNamingCollisions(this,t.identifier,l.Arg,"argument");for(let e=0;e<this.args.length;e+=1)for(let t=e+1;t<this.args.length;t+=1)(null==(n=this.args[e].identifier)?void 0:n.name)==(null==(n=this.args[t].identifier)?void 0:n.name)&&this.Error(`Multiple arguments with the same name: '${this.args[e].identifier}'`)}if(this.flowLevel!==c.Story){let t=this.flowLevel===c.Knot?l.Knot:l.SubFlowAndWeave;e.CheckForNamingCollisions(this,this.identifier,t)}}}class D extends p{get runtimeContainer(){return this.runtimeObject}constructor(t){super(),this.dontFlatten=!1,this.TrimTrailingWhitespace=()=>{for(let t=this.content.length-1;0<=t;--t){var e=d(this.content[t],R);if(null===e)break;if(e.text=e.text.replace(/[ \t]/g,""),0!==e.text.length)break;this.content.splice(t,1)}},this.GenerateRuntimeObject=()=>{var t=new A;if(null!==this.content)for(var e of this.content){e=e.runtimeObject;e&&t.AddContent(e)}return this.dontFlatten&&this.story.DontFlattenContainer(t),t},this.toString=()=>`ContentList(${this.content.join(", ")})`,t&&this.AddContent(t);for(var e=arguments.length,n=Array(1<e?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];n&&this.AddContent(n)}get typeName(){return"ContentList"}}let St=class extends v{get containerForCount(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}get pathStringForCount(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)}set pathStringForCount(t){this.pathForCount=null===t?null:new m(t)}constructor(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;super(),this.pathForCount=null,this.name=t}toString(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}};class yt extends I{get name(){return this.path.join(".")}get path(){return this.pathIdentifiers.map(t=>t.name).filter(H)}get identifier(){var t;return this.pathIdentifiers&&0!=this.pathIdentifiers.length?(t=this.path.join("."),new Ct(t)):null}get runtimeVarRef(){return this._runtimeVarRef}constructor(t){super(),this.pathIdentifiers=t,this._runtimeVarRef=null,this.isConstantReference=!1,this.isListItemReference=!1,this.GenerateIntoContainer=t=>{var e=this.story.constants.get(this.name);if(e)e.GenerateConstantIntoContainer(t),this.isConstantReference=!0;else{if(this._runtimeVarRef=new St(this.name),1===this.path.length||2===this.path.length){let t="",e="";t=1===this.path.length?this.path[0]:(e=this.path[0],this.path[1]),this.story.ResolveListItem(e,t,this)&&(this.isListItemReference=!0)}t.AddContent(this._runtimeVarRef)}},this.toString=()=>`{${this.path.join(".")}}`}get typeName(){return"ref"}ResolveReferences(t){if(super.ResolveReferences(t),!this.isConstantReference&&!this.isListItemReference){var e=new gt(this.pathIdentifiers),n=e.ResolveFromContext(this);if(n){if(!n.containerForCounting)throw Error();if(n.containerForCounting.visitsShouldBeCounted=!0,null!==this._runtimeVarRef){this._runtimeVarRef.pathForCount=n.runtimePath,this._runtimeVarRef.name=null;let t=d(n,L);t&&t.isFunction&&(this.parent instanceof Ft||this.parent instanceof D||this.parent instanceof L)&&this.Warning(`'${t.identifier}' being used as read count rather than being called as function. Perhaps you intended to write ${t.identifier}()`)}}else if(1<this.path.length){let t="Could not find target for read count: "+e;this.path.length>2||(t+=", or couldn't find list item with the name "+this.path.join(",")),void this.Error(t)}else t.ResolveVariableWithName(this.name,this).found||this.Error("Unresolved variable: "+this.name,this)}}}class wt extends I{get proxyDivert(){return this._proxyDivert}get name(){return this._proxyDivert.target.firstComponent||""}get args(){return this._proxyDivert.args}get runtimeDivert(){return this._proxyDivert.runtimeDivert}get isChoiceCount(){return"CHOICE_COUNT"===this.name}get isTurns(){return"TURNS"===this.name}get isTurnsSince(){return"TURNS_SINCE"===this.name}get isRandom(){return"RANDOM"===this.name}get isSeedRandom(){return"SEED_RANDOM"===this.name}get isListRange(){return"LIST_RANGE"===this.name}get isListRandom(){return"LIST_RANDOM"===this.name}get isReadCount(){return"READ_COUNT"===this.name}constructor(t,e){super(),this._divertTargetToCount=null,this._variableReferenceToCount=null,this.shouldPopReturnedValue=!1,this.GenerateIntoContainer=n=>{let t=this.story.ResolveList(this.name),e=!1;if(this.isChoiceCount)0<this.args.length&&this.Error("The CHOICE_COUNT() function shouldn't take any arguments"),n.AddContent(x.ChoiceCount());else if(this.isTurns)0<this.args.length&&this.Error("The TURNS() function shouldn't take any arguments"),n.AddContent(x.Turns());else if(this.isTurnsSince||this.isReadCount){let t=d(this.args[0],_t),e=d(this.args[0],yt);if(1!==this.args.length||null===t&&null===e)return void this.Error(`The ${this.name}() function should take one argument: a divert target to the target knot, stitch, gather or choice you want to check. e.g. TURNS_SINCE(-> myKnot)`);t?(this._divertTargetToCount=t,this.AddContent(this._divertTargetToCount),this._divertTargetToCount.GenerateIntoContainer(n)):e&&(this._variableReferenceToCount=e,this.AddContent(this._variableReferenceToCount),this._variableReferenceToCount.GenerateIntoContainer(n)),n.AddContent(this.isTurnsSince?x.TurnsSince():x.ReadCount())}else if(this.isRandom){2!==this.args.length&&this.Error("RANDOM should take 2 parameters: a minimum and a maximum integer");for(let e=0;e<this.args.length;e+=1){let t=d(this.args[e],N);if(t&&!t.isInt()){let t=0===e?"minimum":"maximum";this.Error(`RANDOM's ${t} parameter should be an integer`)}this.args[e].GenerateIntoContainer(n)}n.AddContent(x.Random())}else if(this.isSeedRandom){1!==this.args.length&&this.Error("SEED_RANDOM should take 1 parameter - an integer seed");let t=d(this.args[0],N);t&&!t.isInt()&&this.Error("SEED_RANDOM's parameter should be an integer seed"),this.args[0].GenerateIntoContainer(n),n.AddContent(x.SeedRandom())}else if(this.isListRange){3!==this.args.length&&this.Error("LIST_RANGE should take 3 parameters - a list, a min and a max");for(let t=0;t<this.args.length;t+=1)this.args[t].GenerateIntoContainer(n);n.AddContent(x.ListRange())}else if(this.isListRandom)1!==this.args.length&&this.Error("LIST_RANDOM should take 1 parameter - a list"),this.args[0].GenerateIntoContainer(n),n.AddContent(x.ListRandom());else if(P.CallExistsWithName(this.name)){let e=P.CallWithName(this.name);if(e.numberOfParameters!==this.args.length){let t=`${wt.name} should take ${e.numberOfParameters} parameter`;1<e.numberOfParameters&&(t+="s"),this.Error(t)}for(let t=0;t<this.args.length;t+=1)this.args[t].GenerateIntoContainer(n);n.AddContent(P.CallWithName(this.name))}else if(null!==t)if(1<this.args.length&&this.Error("Can currently only construct a list from one integer (or an empty list from a given list definition)"),1===this.args.length)n.AddContent(new _(this.name)),this.args[0].GenerateIntoContainer(n),n.AddContent(x.ListFromInt());else{let t=new S;t.SetInitialOriginName(this.name),n.AddContent(new T(t))}else n.AddContent(this._proxyDivert.runtimeObject),e=!0;e||this.content.splice(this.content.indexOf(this._proxyDivert),1),this.shouldPopReturnedValue&&n.AddContent(x.PopEvaluatedValue())},this.toString=()=>{var t=this.args.join(", ");return this.name+`(${t})`},this._proxyDivert=new $(new gt(t),e),this._proxyDivert.isFunctionCall=!0,this.AddContent(this._proxyDivert)}get typeName(){return"FunctionCall"}ResolveReferences(t){if(super.ResolveReferences(t),!this.content.includes(this._proxyDivert)&&null!==this.args)for(var e of this.args)e.ResolveReferences(t);if(this._divertTargetToCount){let t=this._divertTargetToCount.divert,e=null!=t.runtimeDivert.variableDivertName;if(e)this.Error(`When getting the TURNS_SINCE() of a variable target, remove the '->' - i.e. it should just be TURNS_SINCE(${t.runtimeDivert.variableDivertName})`);else{var n=t.targetContent;if(null===n)e||this.Error(`Failed to find target for TURNS_SINCE: '${t.target}'`);else{if(!n.containerForCounting)throw Error();n.containerForCounting.turnIndexShouldBeCounted=!0}}}else if(this._variableReferenceToCount){let t=this._variableReferenceToCount.runtimeVarRef;if(!t)throw Error();null!==t.pathForCount&&this.Error(`Should be '${wt.name}'(-> '${this._variableReferenceToCount.name}). Usage without the '->' only makes sense for variable targets.`)}}}wt.IsBuiltIn=t=>!!P.CallExistsWithName(t)||"CHOICE_COUNT"===t||"TURNS_SINCE"===t||"TURNS"===t||"RANDOM"===t||"SEED_RANDOM"===t||"LIST_VALUE"===t||"LIST_RANDOM"===t||"READ_COUNT"===t;class Et extends I{get subExpressions(){return this.content}constructor(t){super(),this.GenerateIntoContainer=t=>{let e=!0;for(var n of this.subExpressions)n.GenerateIntoContainer(t),e||t.AddContent(P.CallWithName("&&")),e=!1},this.AddContent(t)}get typeName(){return"MultipleConditionExpression"}}class _t extends I{get runtimeDivert(){if(this._runtimeDivert)return this._runtimeDivert;throw Error()}get runtimeDivertTargetValue(){if(this._runtimeDivertTargetValue)return this._runtimeDivertTargetValue;throw Error()}constructor(t){super(),this._runtimeDivert=null,this._runtimeDivertTargetValue=null,this.GenerateIntoContainer=t=>{this.divert.GenerateRuntimeObject(),this._runtimeDivert=this.divert.runtimeDivert,this._runtimeDivertTargetValue=new Q,t.AddContent(this.runtimeDivertTargetValue)},this.Equals=t=>{t=d(t,_t);return!!(t&&this.divert.target&&t.divert.target)&&this.divert.target.dotSeparatedComponents===t.divert.target.dotSeparatedComponents},this.divert=this.AddContent(t)}get typeName(){return"DivertTarget"}ResolveReferences(t){if(super.ResolveReferences(t),this.divert.isDone||this.divert.isEnd)this.Error("Can't use -> DONE or -> END as variable divert targets",this);else{let t=this;for(;t&&t instanceof I;){let e=!1,n=!1;var i=t.parent;if(i instanceof rt){let t=i;("=="===t.opName||"!="===t.opName)&&(t.leftExpression instanceof _t||t.leftExpression instanceof yt)&&(t.rightExpression instanceof _t||t.rightExpression instanceof yt)||(e=!0),n=!0}else if(i instanceof wt){let t=i;t.isTurnsSince||t.isReadCount||(e=!0),n=!0}else(i instanceof I||i instanceof Et||i instanceof k&&i.condition===t||i instanceof ft||i instanceof Wt)&&(e=!0,n=!0);if(e&&this.Error(`Can't use a divert target like that. Did you intend to call '${this.divert.target}' as a function: likeThis(), or check the read count: likeThis, with no arrows?`,this),n)break;t=i}if(this.runtimeDivert.hasVariableTarget){if(!this.divert.target)throw Error();this.Error(`Since '${this.divert.target.dotSeparatedComponents}' is a variable, it shouldn't be preceded by '->' here.`)}this.runtimeDivert.targetPath&&(this.runtimeDivertTargetValue.targetPath=this.runtimeDivert.targetPath);var r=this.divert.targetContent;if(null!==r){let e=r.containerForCounting;if(null!==e){let t=d(this.parent,wt);t&&t.isTurnsSince||(e.visitsShouldBeCounted=!0),e.turnIndexShouldBeCounted=!0}let n=d(r,L);if(null!=n&&null!==n.args)for(let t of n.args)t.isByReference&&this.Error(`Can't store a divert target to a knot or function that has by-reference arguments ('${n.identifier}' has 'ref ${t.identifier}').`)}}}}class $ extends p{get runtimeDivert(){if(this._runtimeDivert)return this._runtimeDivert;throw Error()}set runtimeDivert(t){this._runtimeDivert=t}get isEnd(){return!(!this.target||"END"!==this.target.dotSeparatedComponents)}get isDone(){return!(!this.target||"DONE"!==this.target.dotSeparatedComponents)}constructor(t,e){super(),this.args=[],this.target=null,this.targetContent=null,this._runtimeDivert=null,this.isFunctionCall=!1,this.isEmpty=!1,this.isTunnel=!1,this.isThread=!1,this.GenerateRuntimeObject=()=>{if(this.isEnd)return x.End();if(this.isDone)return x.Done();this.runtimeDivert=new W,this.ResolveTargetContent(),this.CheckArgumentValidity();let t=null!==this.args&&0<this.args.length;if(t||this.isFunctionCall||this.isTunnel||this.isThread){var i=new A;if(t){this.isFunctionCall||i.AddContent(x.EvalStart());let e=null;this.targetContent&&(e=this.targetContent.args);for(let t=0;t<this.args.length;++t){var r=this.args[t];let n=null;if((n=e&&t<e.length?e[t]:n)&&n.isByReference){let t=d(r,yt);if(!t){this.Error(`Expected variable name to pass by reference to 'ref ${n.identifier}' but saw `+r);break}let e=new gt(t.pathIdentifiers);if(e.ResolveFromContext(this)){this.Error(`can't pass a read count by reference. '${e.dotSeparatedComponents}' is a knot/stitch/label, but '${this.target.dotSeparatedComponents}' requires the name of a VAR to be passed.`);break}var a=new tt(t.name);i.AddContent(a)}else r.GenerateIntoContainer(i)}this.isFunctionCall||i.AddContent(x.EvalEnd())}return this.isThread?i.AddContent(x.StartThread()):(this.isFunctionCall||this.isTunnel)&&(this.runtimeDivert.pushesToStack=!0,this.runtimeDivert.stackPushType=this.isFunctionCall?u.Function:u.Tunnel),i.AddContent(this.runtimeDivert),i}return this.runtimeDivert},this.PathAsVariableName=()=>this.target?this.target.firstComponent:null,this.ResolveTargetContent=()=>{if(!this.isEmpty&&!this.isEnd&&null===this.targetContent){let e=this.PathAsVariableName();if(null!==e){var t=d(bt(this),L);if(t){var n=t.ResolveVariableWithName(e,this);if(n.found){if(n.isArgument&&n.ownerFlow&&n.ownerFlow.args){let t=n.ownerFlow.args.find(t=>(null==(t=t.identifier)?void 0:t.name)==e);t&&!t.isDivertTarget&&this.Error(`Since '${t.identifier}' is used as a variable divert target (on ${this.debugMetadata}), it should be marked as: -> `+t.identifier,n.ownerFlow)}return void(this.runtimeDivert.variableDivertName=e)}}}if(!this.target)throw Error();this.targetContent=this.target.ResolveFromContext(this)}},this.CheckArgumentValidity=()=>{if(!this.isEmpty){let e=null!==this.args&&0<this.args.length?this.args.length:0;if(null!==this.targetContent){let i=d(this.targetContent,L);if(0!==e||null!==i&&i.hasParameters)if(null===i&&0<e)this.Error("target needs to be a knot or stitch in order to pass arguments");else if(null!==i&&(null===i.args||!i.args&&0<e))this.Error(`target (${i.name}) doesn't take parameters`);else if(this.parent instanceof _t)0<e&&this.Error("can't store arguments in a divert target variable");else{let t=i.args.length;var n;if(t!==e)n=0===e?"but there weren't any passed to it":e<t?"but only got "+e:"but got "+e,this.Error(`to '${i.identifier}' requires ${t} arguments, `+n);else{for(let e=0;e<t;++e){let t=i.args[e],n=this.args[e];if(t.isDivertTarget){let e=d(n,yt);if(n instanceof _t||null!==e){if(e){let t=new gt(e.pathIdentifiers);t.ResolveFromContext(e)&&this.Error(`Passing read count of '${t.dotSeparatedComponents}' instead of a divert target. You probably meant '${t}'`)}}else this.Error(`Target '${i.identifier}' expects a divert target for the parameter named -> ${t.identifier} but saw `+n,n)}}null===i&&this.Error("Can't call as a function or with arguments unless it's a knot or stitch")}}}}},this.CheckExternalArgumentValidity=t=>{var e=this.target?this.target.firstComponent:null,t=t.externals.get(e);if(!t)throw Error("external not found");t=t.argumentNames.length;let n=this.args?this.args.length:0;n!==t&&this.Error(`incorrect number of arguments sent to external function '${e}'. Expected ${t} but got `+n)},this.toString=()=>{let t="";return null===this.target?"-> <empty divert>":(t+=""+this.target,this.isTunnel&&(t+=" ->"),this.isFunctionCall&&(t+=" ()"),t)},t&&(this.target=t),e&&(this.args=e,this.AddContent(e))}get typeName(){return"Divert"}ResolveReferences(n){if(!(this.isEmpty||this.isEnd||this.isDone)){if(!this.runtimeDivert)throw Error();this.targetContent&&(this.runtimeDivert.targetPath=this.targetContent.runtimePath),super.ResolveReferences(n);var i=d(this.targetContent,L),i=(i&&(!i.isFunction&&this.isFunctionCall?super.Error(i.identifier+` hasn't been marked as a function, but it's being called as one. Do you need to declare the knot as '== function ${i.identifier} =='?`):!i.isFunction||this.isFunctionCall||this.parent instanceof _t||super.Error(i.identifier+" can't be diverted to. It can only be called as a function since it's been marked as such: '"+i.identifier+"(...)'")),null!==this.targetContent);let t=!1,e=!1;if(!this.target)throw Error();if(1===this.target.numberOfComponents){if(!this.target.firstComponent)throw Error();if(t=wt.IsBuiltIn(this.target.firstComponent),e=n.IsExternal(this.target.firstComponent),t||e)return this.isFunctionCall||super.Error(this.target.firstComponent+` must be called as a function: ~ ${this.target.firstComponent}()`),void(e&&(this.runtimeDivert.isExternal=!0,null!==this.args&&(this.runtimeDivert.externalArgs=this.args.length),this.runtimeDivert.pushesToStack=!1,this.runtimeDivert.targetPath=new m(this.target.firstComponent),this.CheckExternalArgumentValidity(n)))}null!=this.runtimeDivert.variableDivertName||i||t||e||this.Error(`target not found: '${this.target}'`)}}Error(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];e!==this&&e?super.Error(t,e):super.Error(this.isFunctionCall?"Function call "+t:"Divert "+t,e,n)}}class Tt{constructor(t,e){this.divert=t,this.targetRuntimeObj=e}}class At{constructor(t,e){this.divert=t,this.targetContent=e}}(t=>{t[t.Stopping=1]="Stopping",t[t.Cycle=2]="Cycle",t[t.Shuffle=4]="Shuffle",t[t.Once=8]="Once"})(o=o||{});class xt extends p{constructor(t,e){super(),this.sequenceType=e,this._sequenceDivertsToResolve=[],this.GenerateRuntimeObject=()=>{var r=new A;r.visitsShouldBeCounted=!0,r.countingAtStartOnly=!0,this._sequenceDivertsToResolve=[],r.AddContent(x.EvalStart()),r.AddContent(x.VisitIndex());let e=0<(this.sequenceType&o.Once),t=0<(this.sequenceType&o.Cycle),i=0<(this.sequenceType&o.Stopping),n=0<(this.sequenceType&o.Shuffle),a=this.sequenceElements.length;if(e&&(a+=1),i||e?(r.AddContent(new E(a-1)),r.AddContent(P.CallWithName("MIN"))):t&&(r.AddContent(new E(this.sequenceElements.length)),r.AddContent(P.CallWithName("%"))),n){let n=x.NoOp();if(e||i){let t=i?this.sequenceElements.length-1:this.sequenceElements.length,e=(r.AddContent(x.Duplicate()),r.AddContent(new E(t)),r.AddContent(P.CallWithName("==")),new W);e.isConditional=!0,r.AddContent(e),this.AddDivertToResolve(e,n)}let t=this.sequenceElements.length;i&&--t,r.AddContent(new E(t)),r.AddContent(x.SequenceShuffleIndex()),(e||i)&&r.AddContent(n)}r.AddContent(x.EvalEnd());var s=x.NoOp();for(let i=0;i<a;i+=1){r.AddContent(x.EvalStart()),r.AddContent(x.Duplicate()),r.AddContent(new E(i)),r.AddContent(P.CallWithName("==")),r.AddContent(x.EvalEnd());let t=new W,e,n=(t.isConditional=!0,r.AddContent(t),(e=i<this.sequenceElements.length?this.sequenceElements[i].runtimeObject:new A).name="s"+i,e.InsertContent(x.PopEvaluatedValue(),0),new W);e.AddContent(n),r.AddToNamedContentOnly(e),this.AddDivertToResolve(t,e),this.AddDivertToResolve(n,s)}return r.AddContent(s),r},this.AddDivertToResolve=(t,e)=>{this._sequenceDivertsToResolve.push(new At(t,e))},this.sequenceType=e,this.sequenceElements=[];for(let e of t){let t=e.content;var n=null===t||0===t.length?e:new Ft(t);this.sequenceElements.push(n),this.AddContent(n)}}get typeName(){return"Sequence"}ResolveReferences(t){super.ResolveReferences(t);for(let t of this._sequenceDivertsToResolve)t.divert.targetPath=t.targetContent.path}}class It extends p{constructor(){super(...arguments),this._overrideDivertTarget=null,this._divertAfter=null,this.GenerateRuntimeObject=()=>{var i=new A;if(i.AddContent(x.EvalStart()),this.divertAfter){var t=this.divertAfter.GenerateRuntimeObject(),r=t;if(r){let t=this.divertAfter.args;if(null!==t&&0<t.length){let e=-1,n=-1;for(let t=0;t<r.content.length;t+=1){var a=r.content[t];a&&(-1==e&&a.commandType===x.CommandType.EvalStart?e=t:a.commandType===x.CommandType.EvalEnd&&(n=t))}for(let t=e+1;t<n;t+=1)r.content[t].parent=null,i.AddContent(r.content[t])}}var e=d(t,W);if(null!=e&&e.hasVariableTarget){let t=new St(e.variableDivertName);i.AddContent(t)}else this._overrideDivertTarget=new Q,i.AddContent(this._overrideDivertTarget)}else i.AddContent(new nt);return i.AddContent(x.EvalEnd()),i.AddContent(x.PopTunnel()),i},this.toString=()=>" -> "+this._divertAfter}get divertAfter(){return this._divertAfter}set divertAfter(t){this._divertAfter=t,this._divertAfter&&this.AddContent(this._divertAfter)}get typeName(){return"TunnelOnwards"}ResolveReferences(t){super.ResolveReferences(t),this.divertAfter&&this.divertAfter.targetContent&&(this._overrideDivertTarget.targetPath=this.divertAfter.targetContent.runtimePath)}}let Pt=class{constructor(t,e){this._name=t||"",this._items=null,this._itemNameToValues=e||new Map}get name(){return this._name}get items(){if(null==this._items){this._items=new Map;for(var[t,e]of this._itemNameToValues){t=new C(this.name,t);this._items.set(t.serialized(),e)}}return this._items}ValueForItem(t){return t.itemName&&void 0!==(t=this._itemNameToValues.get(t.itemName))?t:0}ContainsItem(t){return!!t.itemName&&t.originName==this.name&&this._itemNameToValues.has(t.itemName)}ContainsItemWithName(t){return this._itemNameToValues.has(t)}TryGetItemWithValue(n,t){for(let[t,e]of this._itemNameToValues)if(e==n)return{result:new C(this.name,t),exists:!0};return{result:C.Null,exists:!1}}TryGetValueForItem(t,e){return t.itemName&&(t=this._itemNameToValues.get(t.itemName))?{result:t,exists:!0}:{result:0,exists:!1}}};class Nt extends p{get typeName(){return"ListDefinition"}get runtimeListDefinition(){var t,e=new Map;for(let t of this.itemDefinitions)e.has(t.name)?this.Error(`List '${this.identifier}' contains duplicate items called '${t.name}'`):e.set(t.name,t.seriesValue);return new Pt((null==(t=this.identifier)?void 0:t.name)||"",e)}constructor(t){super(),this.itemDefinitions=t,this.identifier=null,this.variableAssignment=null,this._elementsByName=null,this.ItemNamed=t=>{if(null===this._elementsByName){this._elementsByName=new Map;for(let t of this.itemDefinitions)this._elementsByName.set(t.name,t)}return this._elementsByName.get(t)||null},this.GenerateRuntimeObject=()=>{var t,e,n=new S;for(let t of this.itemDefinitions)t.inInitialList&&(e=new C((null==(e=this.identifier)?void 0:e.name)||null,t.name||null),n.Add(e,t.seriesValue));return n.SetInitialOriginName((null==(t=this.identifier)?void 0:t.name)||""),new T(n)};let e=1;for(let t of this.itemDefinitions)null!==t.explicitValue&&(e=t.explicitValue),t.seriesValue=e,e+=1;this.AddContent(t)}ResolveReferences(t){super.ResolveReferences(t),t.CheckForNamingCollisions(this,this.identifier,l.List)}}class Ot extends p{get variableName(){return this.variableIdentifier.name}get typeName(){return this.isNewTemporaryDeclaration?"temp":this.isGlobalDeclaration?null!==this.listDefinition?"LIST":"VAR":"variable assignment"}get isDeclaration(){return this.isGlobalDeclaration||this.isNewTemporaryDeclaration}constructor(t){var{assignedExpression:t,isGlobalDeclaration:e,isTemporaryNewDeclaration:n,listDef:i,variableIdentifier:r}=t;super(),this._runtimeAssignment=null,this.expression=null,this.listDefinition=null,this.GenerateRuntimeObject=()=>{let t=null;var e;return this.isGlobalDeclaration?t=this.story:this.isNewTemporaryDeclaration&&(t=bt(this)),t&&t.AddNewVariableDeclaration(this),this.isGlobalDeclaration?null:(e=new A,this.expression?e.AddContent(this.expression.runtimeObject):this.listDefinition&&e.AddContent(this.listDefinition.runtimeObject),this._runtimeAssignment=new ot(this.variableName,this.isNewTemporaryDeclaration),e.AddContent(this._runtimeAssignment),e)},this.toString=()=>`${this.isGlobalDeclaration?"VAR":this.isNewTemporaryDeclaration?"~ temp":""} `+this.variableName,this.variableIdentifier=r,this.isGlobalDeclaration=!!e,this.isNewTemporaryDeclaration=!!n,i instanceof Nt?(this.listDefinition=this.AddContent(i),(this.listDefinition.variableAssignment=this).isGlobalDeclaration=!0):t&&(this.expression=this.AddContent(t))}ResolveReferences(t){if(super.ResolveReferences(t),this.isDeclaration&&null===this.listDefinition&&t.CheckForNamingCollisions(this,this.variableIdentifier,this.isGlobalDeclaration?l.Var:l.Temp),this.isGlobalDeclaration){let t=d(this.expression,yt);!t||t.isConstantReference||t.isListItemReference||this.Error("global variable assignments cannot refer to other variables, only literal values, constants and list items")}this.isNewTemporaryDeclaration||((t=t.ResolveVariableWithName(this.variableName,this)).found||this.Error(this.variableName in this.story.constants?`Can't re-assign to a constant (do you need to use VAR when declaring '${this.variableName}'?)`:`Variable could not be found to assign to: '${this.variableName}'`,this),this._runtimeAssignment&&(this._runtimeAssignment.isGlobal=t.isGlobal))}}class Ft extends p{get rootContainer(){return this._rootContainer||(this._rootContainer=this.GenerateRuntimeObject()),this._rootContainer}get namedWeavePoints(){return this._namedWeavePoints}get lastParsedSignificantObject(){if(0===this.content.length)return null;let e=null;for(let t=this.content.length-1;0<=t;--t){var n=d(e=this.content[t],R);if(!(n&&"\n"===n.text||this.IsGlobalDeclaration(e)))break}var t=d(e,Ft);return e=t?t.lastParsedSignificantObject:e}constructor(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1;super(),this.previousWeavePoint=null,this.addContentToPreviousWeavePoint=!1,this.hasSeenChoiceInSection=!1,this.currentContainer=null,this._unnamedGatherCount=0,this._choiceCount=0,this._rootContainer=null,this._namedWeavePoints=new Map,this.looseEnds=[],this.gatherPointsToResolve=[],this.ResolveWeavePointNaming=()=>{var t,e,i;let n=[...this.FindAll(mt)(t=>!(null==t.name)),...this.FindAll(k)(t=>!(null==t.name))];this._namedWeavePoints=new Map;for(i of n){let n=this.namedWeavePoints.get((null==(e=i.identifier)?void 0:e.name)||"");if(n){let t=n instanceof mt?"gather":"choice",e=n;this.Error(`A ${t} with the same label name '${i.name}' already exists in this context on line `+(e.debugMetadata?e.debugMetadata.startLineNumber:"NO DEBUG METADATA AVAILABLE"),i)}null!=(t=i.identifier)&&t.name&&this.namedWeavePoints.set(null==(e=i.identifier)?void 0:e.name,i)}},this.ConstructWeaveHierarchyFromIndentation=()=>{let e=0;for(;e<this.content.length;){var t=this.content[e];if(t instanceof k||t instanceof mt){var n=t.indentationDepth-1;if(this.baseIndentIndex<n){let t=e;for(;e<this.content.length;){let t=d(this.content[e],k)||d(this.content[e],mt);if(null!==t&&t.indentationDepth-1<=this.baseIndentIndex)break;e+=1}var i=e-t,r=this.content.slice(t,t+i),i=(this.content.splice(t,i),new Ft(r,n));this.InsertContent(t,i),e=t}}e+=1}},this.DetermineBaseIndentationFromContent=t=>{for(var e of t)if(e instanceof k||e instanceof mt)return e.indentationDepth-1;return 0},this.GenerateRuntimeObject=()=>{this._rootContainer=new A,this.currentContainer=this._rootContainer,this.looseEnds=[],this.gatherPointsToResolve=[];for(var t of this.content){var e;t instanceof k||t instanceof mt?this.AddRuntimeForWeavePoint(t):t instanceof Ft?(e=t,this.AddRuntimeForNestedWeave(e),this.gatherPointsToResolve.splice(0,0,...e.gatherPointsToResolve)):this.AddGeneralRuntimeContent(t.runtimeObject)}return this.PassLooseEndsToAncestors(),this._rootContainer},this.AddRuntimeForGather=e=>{let t=!this.hasSeenChoiceInSection;this.hasSeenChoiceInSection=!1;var n=e.runtimeContainer;if(e.name||(n.name="g-"+this._unnamedGatherCount,this._unnamedGatherCount+=1),t){if(!this.currentContainer)throw Error();this.currentContainer.AddContent(n)}else this.rootContainer.AddToNamedContentOnly(n);for(let t of this.looseEnds){var i=t;if(!(i instanceof mt&&i.indentationDepth==e.indentationDepth)){let e=null;if(i instanceof $)e=i.runtimeObject;else{e=new W;let t=i;if(!t.runtimeContainer)throw Error();t.runtimeContainer.AddContent(e)}this.gatherPointsToResolve.push(new Tt(e,n))}}this.looseEnds=[],this.currentContainer=n},this.AddRuntimeForWeavePoint=t=>{if(t instanceof mt)this.AddRuntimeForGather(t);else if(t instanceof k){if(!this.currentContainer)throw Error();this.previousWeavePoint instanceof mt&&this.looseEnds.splice(this.looseEnds.indexOf(this.previousWeavePoint),1);var e=t;if(this.currentContainer.AddContent(e.runtimeObject),!e.innerContentContainer)throw Error();e.innerContentContainer.name="c-"+this._choiceCount,this.currentContainer.AddToNamedContentOnly(e.innerContentContainer),this._choiceCount+=1,this.hasSeenChoiceInSection=!0}this.addContentToPreviousWeavePoint=!1,this.WeavePointHasLooseEnd(t)&&(this.looseEnds.push(t),d(t,k))&&(this.addContentToPreviousWeavePoint=!0),this.previousWeavePoint=t},this.AddRuntimeForNestedWeave=t=>{this.AddGeneralRuntimeContent(t.rootContainer),null!==this.previousWeavePoint&&(this.looseEnds.splice(this.looseEnds.indexOf(this.previousWeavePoint),1),this.addContentToPreviousWeavePoint=!1)},this.AddGeneralRuntimeContent=t=>{if(null!==t)if(this.addContentToPreviousWeavePoint){if(!this.previousWeavePoint||!this.previousWeavePoint.runtimeContainer)throw Error();this.previousWeavePoint.runtimeContainer.AddContent(t)}else{if(!this.currentContainer)throw Error();this.currentContainer.AddContent(t)}},this.PassLooseEndsToAncestors=()=>{if(0!==this.looseEnds.length){let i=null,r=null,a=!1;for(let t=this.parent;null!==t;t=t.parent){var e=d(t,Ft);e&&(a||null!==i||(i=e),a)&&null===r&&(r=e),(t instanceof xt||t instanceof ft)&&(a=!0)}if(null!==i||null!==r)for(let t=this.looseEnds.length-1;0<=t;--t){let e=this.looseEnds[t],n=!1;if(a){if(e instanceof k&&null!==i)i.ReceiveLooseEnd(e),n=!0;else if(!(e instanceof k)){let t=i||r;null!==t&&(t.ReceiveLooseEnd(e),n=!0)}}else null!=i&&i.hasOwnProperty("ReceiveLooseEnd")&&i.ReceiveLooseEnd(e),n=!0;n&&this.looseEnds.splice(t,1)}}},this.ReceiveLooseEnd=t=>{this.looseEnds.push(t)},this.WeavePointNamed=t=>this.namedWeavePoints&&this.namedWeavePoints.get(t)||null,this.IsGlobalDeclaration=t=>{var e=d(t,Ot);return!!(e&&e.isGlobalDeclaration&&e.isDeclaration)||!!d(t,pt)},this.ContentThatFollowsWeavePoint=t=>{let n=[],i=t;if(null!==i.content)for(let t of i.content)this.IsGlobalDeclaration(t)||n.push(t);var r=d(i.parent,Ft);if(null===r)throw Error("Expected weave point parent to be weave?");for(let e=1+r.content.indexOf(i);e<r.content.length;e+=1){let t=r.content[e];if(!this.IsGlobalDeclaration(t)){if(t instanceof k||t instanceof mt)break;if(t instanceof Ft)break;n.push(t)}}return n},this.ValidateTermination=t=>{if(!(this.lastParsedSignificantObject instanceof J))if(null!==this.looseEnds&&0<this.looseEnds.length)for(var e of this.looseEnds){var n=this.ContentThatFollowsWeavePoint(e);this.ValidateFlowOfObjectsTerminates(n,e,t)}else{for(let t of this.content)if(t instanceof k||t instanceof $)return;this.ValidateFlowOfObjectsTerminates(this.content,this,t)}},this.BadNestedTerminationHandler=e=>{let n=null;for(let t=e.parent;null!==t;t=t.parent)if(t instanceof xt||t instanceof ft){n=d(t,ft);break}let t="Choices nested in conditionals or sequences need to explicitly divert afterwards.";null!==n&&1===n.FindAll(k)().length&&(t="Choices with conditions should be written: '* {condition} choice'. Otherwise, "+t.toLowerCase()),this.Error(t,e)},this.ValidateFlowOfObjectsTerminates=(e,t,n)=>{let i=!1,r=t;for(let t of e){if(null!==t.Find($)(t=>!(t.isThread||t.isTunnel||t.isFunctionCall||t.parent instanceof _t))&&(i=!0),null!=t.Find(It)()){i=!0;break}r=t}i||r instanceof J||n(r)},this.WeavePointHasLooseEnd=e=>{if(null!==e.content)for(let t=e.content.length-1;0<=t;--t){var n=d(e.content[t],$);if(n&&!(n.isThread||n.isTunnel||n.isFunctionCall))return!1}return!0},this.CheckForWeavePointNamingCollisions=()=>{if(this.namedWeavePoints){let t=[];for(var e of this.ancestry){e=d(e,L);if(!e)break;t.push(e)}for(let[n,i]of this.namedWeavePoints)for(var r of t){let e=r.ContentWithNameAtLevel(n);if(e&&e!==i){let t=`${i.GetType()} '${n}' has the same label name as a ${e.GetType()} (on ${e.debugMetadata})`;this.Error(t,i)}}}},this.baseIndentIndex=-1==e?this.DetermineBaseIndentationFromContent(t):e,this.AddContent(t),this.ConstructWeaveHierarchyFromIndentation()}get typeName(){return"Weave"}ResolveReferences(t){if(super.ResolveReferences(t),null!==this.looseEnds&&0<this.looseEnds.length){let e=!1;for(let t=this.parent;null!==t;t=t.parent)if(t instanceof xt||t instanceof ft){e=!0;break}e&&this.ValidateTermination(this.BadNestedTerminationHandler)}for(let t of this.gatherPointsToResolve)t.divert.targetPath=t.targetRuntimeObj.path;this.CheckForWeavePointNamingCollisions()}}class Wt extends p{get ownExpression(){return this._ownExpression}set ownExpression(t){this._ownExpression=t,this._ownExpression&&this.AddContent(this._ownExpression)}constructor(t){super(),this._contentContainer=null,this._conditionalDivert=null,this._ownExpression=null,this._innerWeave=null,this.isTrueBranch=!1,this.matchingEquality=!1,this.isElse=!1,this.isInline=!1,this.returnDivert=null,this.GenerateRuntimeObject=()=>{if(this._innerWeave)for(let e of this._innerWeave.content){let t=d(e,R);t&&t.text.startsWith("else:")&&this.Warning("Saw the text 'else:' which is being treated as content. Did you mean '- else:'?",t)}let e=new A,t=this.matchingEquality&&!this.isElse;if(t&&e.AddContent(x.Duplicate()),this._conditionalDivert=new W,this._conditionalDivert.isConditional=!this.isElse,!this.isTrueBranch&&!this.isElse){let t=null!==this.ownExpression;t&&e.AddContent(x.EvalStart()),this.ownExpression&&this.ownExpression.GenerateIntoContainer(e),this.matchingEquality&&e.AddContent(P.CallWithName("==")),t&&e.AddContent(x.EvalEnd())}return e.AddContent(this._conditionalDivert),this._contentContainer=this.GenerateRuntimeForContent(),this._contentContainer.name="b",this.isInline||this._contentContainer.InsertContent(new _("\n"),0),(t||this.isElse&&this.matchingEquality)&&this._contentContainer.InsertContent(x.PopEvaluatedValue(),0),e.AddToNamedContentOnly(this._contentContainer),this.returnDivert=new W,this._contentContainer.AddContent(this.returnDivert),e},this.GenerateRuntimeForContent=()=>null===this._innerWeave?new A:this._innerWeave.rootContainer,t&&(this._innerWeave=new Ft(t),this.AddContent(this._innerWeave))}get typeName(){return"ConditionalSingleBranch"}ResolveReferences(t){if(!this._conditionalDivert||!this._contentContainer)throw Error();this._conditionalDivert.targetPath=this._contentContainer.path,super.ResolveReferences(t)}}(t=>{t[t.ParsingString=1]="ParsingString",t[t.TagActive=2]="TagActive"})(e=e||{});class kt{constructor(){this.startLineNumber=0,this.endLineNumber=0,this.startCharacterNumber=0,this.endCharacterNumber=0,this.fileName=null,this.sourceName=null}Merge(t){var e=new kt;return e.fileName=this.fileName,e.sourceName=this.sourceName,this.startLineNumber<t.startLineNumber?(e.startLineNumber=this.startLineNumber,e.startCharacterNumber=this.startCharacterNumber):t.startLineNumber<this.startLineNumber?(e.startLineNumber=t.startLineNumber,e.startCharacterNumber=t.startCharacterNumber):(e.startLineNumber=this.startLineNumber,e.startCharacterNumber=Math.min(this.startCharacterNumber,t.startCharacterNumber)),t.endLineNumber<this.endLineNumber?(e.endLineNumber=this.endLineNumber,e.endCharacterNumber=this.endCharacterNumber):this.endLineNumber<t.endLineNumber?(e.endLineNumber=t.endLineNumber,e.endCharacterNumber=t.endCharacterNumber):(e.endLineNumber=this.endLineNumber,e.endCharacterNumber=Math.max(this.endCharacterNumber,t.endCharacterNumber)),e}toString(){return null!==this.fileName?`line ${this.startLineNumber} of ${this.fileName}"`:"line "+this.startLineNumber}}class Rt extends p{get name(){var t;return(null==(t=this.identifier)?void 0:t.name)||null}constructor(t,e){super(),this.identifier=t,this.argumentNames=e,this.GenerateRuntimeObject=()=>(this.story.AddExternal(this),null)}get typeName(){return"EXTERNAL"}toString(){var t;return"EXTERNAL "+(null==(t=this.identifier)?void 0:t.name)}}class Lt{constructor(t,e,n){this.name=t,this.args=e,this.isFunction=n}}class Dt extends p{constructor(t){super(),this._objToWrap=t,this.GenerateRuntimeObject=()=>this._objToWrap}}let $t=class extends Dt{constructor(t){super(t)}get typeName(){return"Glue"}};class Vt extends v{toString(){return"Glue"}}class jt extends I{constructor(t,e,n){super(),this.varIdentifier=t,this._runtimeAssignment=null,this.expression=null,this.GenerateIntoContainer=t=>{var e;t.AddContent(new St((null==(e=this.varIdentifier)?void 0:e.name)||null)),this.expression?this.expression.GenerateIntoContainer(t):t.AddContent(new E(1)),t.AddContent(P.CallWithName(this.isInc?"+":"-")),this._runtimeAssignment=new ot((null==(e=this.varIdentifier)?void 0:e.name)||null,!1),t.AddContent(this._runtimeAssignment)},this.toString=()=>{var t;return this.expression?(null==(t=this.varIdentifier)?void 0:t.name)+(this.isInc?" += ":" -= ")+this.expression:(null==(t=this.varIdentifier)?void 0:t.name)+(this.isInc?"++":"--")},e instanceof I?(this.expression=e,this.AddContent(this.expression),this.isInc=!!n):this.isInc=e}get typeName(){return"IncDecExpression"}ResolveReferences(t){super.ResolveReferences(t);t=t.ResolveVariableWithName((null==(t=this.varIdentifier)?void 0:t.name)||"",this);if(t.found||this.Error(`variable for ${this.incrementDecrementWord} could not be found: '${this.varIdentifier}' after searching: {this.descriptionOfScope}`),!this._runtimeAssignment)throw Error();this._runtimeAssignment.isGlobal=t.isGlobal,this.parent instanceof Ft||this.parent instanceof L||this.parent instanceof D||this.Error(`Can't use ${this.incrementDecrementWord} as sub-expression`)}get incrementDecrementWord(){return this.isInc?"increment":"decrement"}}class Bt extends p{constructor(t){super(),this.includedStory=t,this.GenerateRuntimeObject=()=>null}get typeName(){return"IncludedFile"}}class Mt{constructor(t,e,n){this.type=t,this.precedence=e,this.requireWhitespace=n,this.toString=()=>this.type}}class Gt extends L{get flowLevel(){return c.Knot}constructor(t,e,n,i){super(t,e,n,i)}get typeName(){return this.isFunction?"Function":"Knot"}ResolveReferences(t){super.ResolveReferences(t);let e=this.story;for(let n in this.subFlowsByName){var i=e.ContentWithNameAtLevel(n,c.Knot,!1);if(i){let t=this.subFlowsByName.get(n),e=`Stitch '${t?t.name:"NO STITCH FOUND"}' has the same name as a knot (on ${i.debugMetadata})`;this.Error(e,t)}}}}class qt extends I{constructor(t){super(),this.itemIdentifierList=t,this.GenerateIntoContainer=t=>{var i,r=new S;if(null!=this.itemIdentifierList)for(let n of this.itemIdentifierList){var a=(null==(a=null==n?void 0:n.name)?void 0:a.split("."))||[];let e=null,t="";t=1<a.length?(e=a[0],a[1]):a[0];var s=this.story.ResolveListItem(e,t,this);if(null===s)null===e?this.Error(`Could not find list definition that contains item '${n}'`):this.Error("Could not find list item "+n);else{if(null==s.parent)return void this.Error("Could not find list definition for item "+n);e=e||(null==(i=s.parent.identifier)?void 0:i.name)||null;let t=new C(e,s.name||null);r.has(t.serialized())?this.Warning(`Duplicate of item '${n}' in list.`):r.Add(t,s.seriesValue)}}t.AddContent(new T(r))}}get typeName(){return"List"}}class Ut extends p{get fullName(){var t=this.parent;if(null===t)throw Error("Can't get full name without a parent list.");return`${null==(t=t.identifier)?void 0:t.name}.`+this.name}get typeName(){return"ListElement"}get name(){var t;return(null==(t=this.indentifier)?void 0:t.name)||null}constructor(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;super(),this.indentifier=t,this.inInitialList=e,this.explicitValue=n,this.seriesValue=0,this.parent=null,this.GenerateRuntimeObject=()=>{throw Error("Not implemented.")},this.toString=()=>this.fullName}ResolveReferences(t){super.ResolveReferences(t),t.CheckForNamingCollisions(this,this.indentifier,l.ListItem)}}s.StatementLevel=void 0,(t=s.StatementLevel||(s.StatementLevel={}))[t.InnerBlock=0]="InnerBlock",t[t.Stitch=1]="Stitch",t[t.Knot=2]="Knot",t[t.Top=3]="Top";class Kt extends L{get flowLevel(){return c.Stitch}constructor(t,e,n,i){super(t,e,n,i),this.baseToString=this.toString,this.toString=()=>(null!==this.parent?this.parent+" > ":"")+this.baseToString()}get typeName(){return"Stitch"}}let Ht=class extends v{constructor(t){super(),this.text=""+t||""}toString(){return"# "+this.text}};class Jt extends v{constructor(){super(...arguments),this.text="",this.index=0,this.threadAtGeneration=null,this.sourcePath="",this.targetPath=null,this.isInvisibleDefault=!1,this.tags=null,this.originalThreadIndex=0}get pathStringOnChoice(){return null===this.targetPath?g("Choice.targetPath"):""+this.targetPath}set pathStringOnChoice(t){this.targetPath=new m(t)}Clone(){var t=new Jt;return t.text=this.text,t.sourcePath=this.sourcePath,t.index=this.index,t.targetPath=this.targetPath,t.originalThreadIndex=this.originalThreadIndex,t.isInvisibleDefault=this.isInvisibleDefault,null!==this.threadAtGeneration&&(t.threadAtGeneration=this.threadAtGeneration.Copy()),t}}class zt{constructor(t){this._lists=new Map,this._allUnambiguousListValueCache=new Map;for(var e of t){this._lists.set(e.name,e);for(let[n,i]of e.items){let t=C.fromSerializedKey(n),e=new T(t,i);if(!t.itemName)throw Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(t.itemName,e),this._allUnambiguousListValueCache.set(t.fullName,e)}}}get lists(){var t,e=[];for([,t]of this._lists)e.push(t);return e}TryListGetDefinition(t,e){return null!==t&&(t=this._lists.get(t))?{result:t,exists:!0}:{result:e,exists:!1}}FindSingleItemListWithName(t){return null===t?g("name"):void 0!==(t=this._allUnambiguousListValueCache.get(t))?t:null}}class V{static JArrayToRuntimeObjList(i){let t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],e=i.length;t&&e--;var r=[];for(let n=0;n<e;n++){let t=i[n],e=this.JTokenToRuntimeObject(t);if(null===e)return g("runtimeObj");r.push(e)}return r}static WriteDictionaryRuntimeObjs(t,e){t.WriteObjectStart();for(var[n,i]of e)t.WritePropertyStart(n),this.WriteRuntimeObject(t,i),t.WritePropertyEnd();t.WriteObjectEnd()}static WriteListRuntimeObjs(t,e){t.WriteArrayStart();for(var n of e)this.WriteRuntimeObject(t,n);t.WriteArrayEnd()}static WriteIntDictionary(t,e){t.WriteObjectStart();for(var[n,i]of e)t.WriteIntProperty(n,i);t.WriteObjectEnd()}static WriteRuntimeObject(n,t){var e=d(t,A);if(e)this.WriteRuntimeContainer(n,e);else{var i=d(t,W);if(i){let t,e="->";i.isExternal?e="x()":i.pushesToStack&&(i.stackPushType==u.Function?e="f()":i.stackPushType==u.Tunnel&&(e="->t->")),t=i.hasVariableTarget?i.variableDivertName:i.targetPathString,n.WriteObjectStart(),n.WriteProperty(e,t),i.hasVariableTarget&&n.WriteProperty("var",!0),i.isConditional&&n.WriteProperty("c",!0),0<i.externalArgs&&n.WriteIntProperty("exArgs",i.externalArgs),void n.WriteObjectEnd()}else{e=d(t,st);if(e)n.WriteObjectStart(),n.WriteProperty("*",e.pathStringOnChoice),n.WriteIntProperty("flg",e.flags),n.WriteObjectEnd();else{i=d(t,Y);if(i)n.WriteBool(i.value);else{e=d(t,E);if(e)n.WriteInt(e.value);else{i=d(t,Z);if(i)n.WriteFloat(i.value);else{e=d(t,_);if(e)e.isNewline?n.Write("\n",!1):(n.WriteStringStart(),n.WriteStringInner("^"),n.WriteStringInner(e.value),n.WriteStringEnd());else{i=d(t,T);if(i)this.WriteInkList(n,i);else{e=d(t,Q);if(e)return n.WriteObjectStart(),null===e.value?g("divTargetVal.value"):(n.WriteProperty("^->",e.value.componentsString),void n.WriteObjectEnd());i=d(t,tt);if(i)n.WriteObjectStart(),n.WriteProperty("^var",i.value),n.WriteIntProperty("ci",i.contextIndex),n.WriteObjectEnd();else if(d(t,Vt))n.Write("<>");else{e=d(t,x);if(e)n.Write(V._controlCommandNames[e.commandType]);else{i=d(t,P);if(i){let t=i.name;"^"==t&&(t="L^"),void n.Write(t)}else{e=d(t,St);if(e){n.WriteObjectStart();let t=e.pathStringForCount;null!=t?n.WriteProperty("CNT?",t):n.WriteProperty("VAR?",e.name),void n.WriteObjectEnd()}else{i=d(t,ot);if(i){n.WriteObjectStart();let t=i.isGlobal?"VAR=":"temp=";n.WriteProperty(t,i.variableName),i.isNewDeclaration||n.WriteProperty("re",!0),void n.WriteObjectEnd()}else if(d(t,nt))n.Write("void");else{e=d(t,Ht);if(e)n.WriteObjectStart(),n.WriteProperty("#",e.text),n.WriteObjectEnd();else{i=d(t,Jt);if(!i)throw Error("Failed to convert runtime object to Json token: "+t);this.WriteChoice(n,i)}}}}}}}}}}}}}}}static JObjectToDictionaryRuntimeObjs(t){var e,n=new Map;for(e in t)if(t.hasOwnProperty(e)){var i=this.JTokenToRuntimeObject(t[e]);if(null===i)return g("inkObject");n.set(e,i)}return n}static JObjectToIntDictionary(t){var e,n=new Map;for(e in t)t.hasOwnProperty(e)&&n.set(e,parseInt(t[e]));return n}static JTokenToRuntimeObject(l){if("number"==typeof l&&!isNaN(l)||"boolean"==typeof l)return w.Create(l);if("string"==typeof l){let e=""+l,t=e[0];if("^"==t)return new _(e.substring(1));if("\n"==t&&1==e.length)return new _("\n");if("<>"==e)return new Vt;for(let t=0;t<V._controlCommandNames.length;++t)if(e==V._controlCommandNames[t])return new x(t);if("L^"==e&&(e="^"),P.CallExistsWithName(e))return P.CallWithName(e);if("->->"==e)return x.PopTunnel();if("~ret"==e)return x.PopFunction();if("void"==e)return new nt}if("object"==typeof l&&!Array.isArray(l)){let i,s=l;if(s["^->"])return i=s["^->"],new Q(new m(""+i));if(s["^var"]){i=s["^var"];let t=new tt(""+i);return"ci"in s&&(i=s.ci,t.contextIndex=parseInt(i)),t}let t=!1,n=!1,r=u.Function,a=!1;if((i=s["->"])?t=!0:(i=s["f()"])?(t=!0,n=!0,r=u.Function):(i=s["->t->"])?(t=!0,n=!0,r=u.Tunnel):(i=s["x()"])&&(t=!0,a=!0,n=!1,r=u.Function),t){let t=new W,e=(t.pushesToStack=n,t.stackPushType=r,t.isExternal=a,""+i);return(i=s.var)?t.variableDivertName=e:t.targetPathString=e,t.isConditional=!!s.c,a&&(i=s.exArgs)&&(t.externalArgs=parseInt(i)),t}if(i=s["*"]){let t=new st;return t.pathStringOnChoice=""+i,(i=s.flg)&&(t.flags=parseInt(i)),t}if(i=s["VAR?"])return new St(""+i);if(i=s["CNT?"]){let t=new St;return t.pathStringForCount=""+i,t}let e=!1,o=!1;if((i=s["VAR="])?(e=!0,o=!0):(i=s["temp="])&&(e=!0,o=!1),e){let t=""+i,e=!s.re,n=new ot(t,e);return n.isGlobal=o,n}if(void 0!==s["#"])return i=s["#"],new Ht(""+i);if(i=s.list){let r=i,a=new S;if(i=s.origins){let t=i;a.SetInitialOriginNames(t)}for(let i in r)if(r.hasOwnProperty(i)){let t=r[i],e=new C(i),n=parseInt(t);a.Add(e,n)}return new T(a)}if(null!=s.originalChoicePath)return this.JObjectToChoice(s)}if(Array.isArray(l))return this.JArrayToContainer(l);if(null==l)return null;throw Error("Failed to convert token to runtime object: "+this.toJson(l,["parent"]))}static toJson(t,n,e){return JSON.stringify(t,(e,t)=>null!=n&&n.some(t=>t===e)?void 0:t,e)}static WriteRuntimeContainer(r,e){var t=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(r.WriteArrayStart(),null===e)return g("container");for(let t of e.content)this.WriteRuntimeObject(r,t);var a=e.namedOnlyContent,n=e.countFlags,t=null!=e.name&&!t,i=null!=a||0<n||t;if(i&&r.WriteObjectStart(),null!=a)for(let[n,i]of a){let t=n,e=d(i,A);r.WritePropertyStart(t),this.WriteRuntimeContainer(r,e,!0),r.WritePropertyEnd()}0<n&&r.WriteIntProperty("#f",n),t&&r.WriteProperty("#n",e.name),i?r.WriteObjectEnd():r.WriteNull(),r.WriteArrayEnd()}static JArrayToContainer(t){var e=new A,i=(e.content=this.JArrayToRuntimeObjList(t,!0),t[t.length-1]);if(null!=i){let n=new Map;for(var r in i)if("#f"==r)e.countFlags=parseInt(i[r]);else if("#n"==r)e.name=""+i[r];else{let t=this.JTokenToRuntimeObject(i[r]),e=d(t,A);e&&(e.name=r),n.set(r,t)}e.namedOnlyContent=n}return e}static JObjectToChoice(t){var e=new Jt;return e.text=""+t.text,e.index=parseInt(t.index),e.sourcePath=""+t.originalChoicePath,e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=""+t.targetPath,e.tags=this.JArrayToTags(t),e}static JArrayToTags(t){return t.tags||null}static WriteChoice(t,e){t.WriteObjectStart(),t.WriteProperty("text",e.text),t.WriteIntProperty("index",e.index),t.WriteProperty("originalChoicePath",e.sourcePath),t.WriteIntProperty("originalThreadIndex",e.originalThreadIndex),t.WriteProperty("targetPath",e.pathStringOnChoice),this.WriteChoiceTags(t,e),t.WriteObjectEnd()}static WriteChoiceTags(t,e){if(e.tags&&0<e.tags.length){t.WritePropertyStart("tags"),t.WriteArrayStart();for(var n of e.tags)t.Write(n);t.WriteArrayEnd(),t.WritePropertyEnd()}}static WriteInkList(r,t){var e=t.value;if(null===e)return g("rawList");r.WriteObjectStart(),r.WritePropertyStart("list"),r.WriteObjectStart();for(let[n,i]of e){let t=C.fromSerializedKey(n),e=i;if(null===t.itemName)return g("item.itemName");r.WritePropertyNameStart(),r.WritePropertyNameInner(t.originName||"?"),r.WritePropertyNameInner("."),r.WritePropertyNameInner(t.itemName),r.WritePropertyNameEnd(),r.Write(e),r.WritePropertyEnd()}if(r.WriteObjectEnd(),r.WritePropertyEnd(),0==e.Count&&null!=e.originNames&&0<e.originNames.length){r.WritePropertyStart("origins"),r.WriteArrayStart();for(let t of e.originNames)r.Write(t);r.WriteArrayEnd(),r.WritePropertyEnd()}r.WriteObjectEnd()}static ListDefinitionsToJToken(t){var r,e={};for(r of t.lists){let i={};for(let[e,n]of r.items){let t=C.fromSerializedKey(e);if(null===t.itemName)return g("item.itemName");i[t.itemName]=n}e[r.name]=i}return e}static JTokenToListDefinitions(t){var n=t,e=[];for(let t in n)if(n.hasOwnProperty(t)){var i=""+t,r=n[t],a=new Map;for(let e in r)if(n.hasOwnProperty(t)){let t=r[e];a.set(e,parseInt(t))}i=new Pt(i,a);e.push(i)}return new zt(e)}}V._controlCommandNames=(()=>{var e=[];e[x.CommandType.EvalStart]="ev",e[x.CommandType.EvalOutput]="out",e[x.CommandType.EvalEnd]="/ev",e[x.CommandType.Duplicate]="du",e[x.CommandType.PopEvaluatedValue]="pop",e[x.CommandType.PopFunction]="~ret",e[x.CommandType.PopTunnel]="->->",e[x.CommandType.BeginString]="str",e[x.CommandType.EndString]="/str",e[x.CommandType.NoOp]="nop",e[x.CommandType.ChoiceCount]="choiceCnt",e[x.CommandType.Turns]="turn",e[x.CommandType.TurnsSince]="turns",e[x.CommandType.ReadCount]="readc",e[x.CommandType.Random]="rnd",e[x.CommandType.SeedRandom]="srnd",e[x.CommandType.VisitIndex]="visit",e[x.CommandType.SequenceShuffleIndex]="seq",e[x.CommandType.StartThread]="thread",e[x.CommandType.Done]="done",e[x.CommandType.End]="end",e[x.CommandType.ListFromInt]="listInt",e[x.CommandType.ListRange]="range",e[x.CommandType.ListRandom]="lrnd",e[x.CommandType.BeginTag]="#",e[x.CommandType.EndTag]="/#";for(let t=0;t<x.CommandType.TOTAL_VALUES;++t)if(null==e[t])throw Error("Control command not accounted for in serialisation");return e})();class Xt{get elements(){return this.callStack}get depth(){return this.elements.length}get currentElement(){var t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}get currentElementIndex(){return this.callStack.length-1}get currentThread(){return this._threads[this._threads.length-1]}set currentThread(t){M.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}get canPop(){return 1<this.callStack.length}constructor(){if(this._threadCounter=0,this._startOfRoot=F.Null,arguments[0]instanceof re){var t=arguments[0];this._startOfRoot=F.StartOf(t.rootContentContainer),this.Reset()}else{let t=arguments[0];this._threads=[];for(var e of t._threads)this._threads.push(e.Copy());this._threadCounter=t._threadCounter,this._startOfRoot=t._startOfRoot.copy()}}Reset(){this._threads=[],this._threads.push(new Xt.Thread),this._threads[0].callstack.push(new Xt.Element(u.Tunnel,this._startOfRoot))}SetJsonToken(t,i){this._threads.length=0;var e=t.threads;for(let n of e){let t=n,e=new Xt.Thread(t,i);this._threads.push(e)}this._threadCounter=parseInt(t.threadCounter),this._startOfRoot=F.StartOf(i.rootContentContainer)}WriteJson(t){t.WriteObject(t=>{t.WritePropertyStart("threads"),t.WriteArrayStart();for(var e of this._threads)e.WriteJson(t);t.WriteArrayEnd(),t.WritePropertyEnd(),t.WritePropertyStart("threadCounter"),t.WriteInt(this._threadCounter),t.WritePropertyEnd()})}PushThread(){var t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}ForkThread(){var t=this.currentThread.Copy();return this._threadCounter++,t.threadIndex=this._threadCounter,t}PopThread(){if(!this.canPopThread)throw Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}get canPopThread(){return 1<this._threads.length&&!this.elementIsEvaluateFromGame}get elementIsEvaluateFromGame(){return this.currentElement.type==u.FunctionEvaluationFromGame}Push(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,t=new Xt.Element(t,this.currentElement.currentPointer,!1);t.evaluationStackHeightWhenPushed=e,t.functionStartInOutputStream=n,this.callStack.push(t)}CanPop(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;return!!this.canPop&&(null==t||this.currentElement.type==t)}Pop(){if(!this.CanPop(0<arguments.length&&void 0!==arguments[0]?arguments[0]:null))throw Error("Mismatched push/pop in Callstack");this.callStack.pop()}GetTemporaryVariableWithName(t){let e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1;-1==e&&(e=this.currentElementIndex+1);t=a(this.callStack[e-1].temporaryVariables,t,null);return t.exists?t.result:null}SetTemporaryVariable(t,e,n){let i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:-1;-1==i&&(i=this.currentElementIndex+1);var r=this.callStack[i-1];if(!n&&!r.temporaryVariables.get(t))throw Error("Could not find temporary variable to set: "+t);n=a(r.temporaryVariables,t,null);n.exists&&T.RetainListOriginsForAssignment(n.result,e),r.temporaryVariables.set(t,e)}ContextForVariableNamed(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}ThreadWithIndex(e){var t=this._threads.filter(t=>{if(t.threadIndex==e)return t});return 0<t.length?t[0]:null}get callStack(){return this.currentThread.callstack}get callStackTrace(){var n=new b;for(let t=0;t<this._threads.length;t++){var i=this._threads[t],e=t==this._threads.length-1;n.AppendFormat("=== THREAD {0}/{1} {2}===\n",t+1,this._threads.length,e?"(current) ":"");for(let e=0;e<i.callstack.length;e++){i.callstack[e].type==u.Function?n.Append("  [FUNCTION] "):n.Append("  [TUNNEL] ");let t=i.callstack[e].currentPointer;if(!t.isNull){if(n.Append("<SOMEWHERE IN "),null===t.container)return g("pointer.container");n.Append(""+t.container.path),n.AppendLine(">")}}}return""+n}}(t=>{class h{constructor(t,e){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=e.copy(),this.inExpressionEvaluation=n,this.temporaryVariables=new Map,this.type=t}Copy(){var t=new h(this.type,this.currentPointer,this.inExpressionEvaluation);return t.temporaryVariables=new Map(this.temporaryVariables),t.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,t.functionStartInOutputStream=this.functionStartInOutputStream,t}}t.Element=h,t.Thread=class n{constructor(){if(this.threadIndex=0,this.previousPointer=F.Null,this.callstack=[],arguments[0]&&arguments[1]){var t=arguments[0],s=arguments[1],e=(this.threadIndex=parseInt(t.threadIndex),t.callstack);for(let a of e){let e,n=a,t=parseInt(n.type),i=F.Null,r=n.cPath;if(void 0!==r){e=""+r;let t=s.ContentAtPath(new m(e));if(i.container=t.container,i.index=parseInt(n.idx),null==t.obj)throw Error("When loading state, internal story location couldn't be found: "+e+". Has the story changed since this save data was created?");t.approximate&&s.Warning(null!==i.container?"When loading state, exact internal story location couldn't be found: '"+e+"', so it was approximated to '"+i.container.path+"' to recover. Has the story changed since this save data was created?":"When loading state, exact internal story location couldn't be found: '"+e+"' and it may not be recoverable. Has the story changed since this save data was created?")}var o=!!n.exp,o=new h(t,i,o),l=n.temp;void 0!==l?o.temporaryVariables=V.JObjectToDictionaryRuntimeObjs(l):o.temporaryVariables.clear(),this.callstack.push(o)}if(void 0!==(e=t.previousContentObject)){let t=new m(""+e);this.previousPointer=s.PointerAtPath(t)}}}Copy(){var t,e=new n;e.threadIndex=this.threadIndex;for(t of this.callstack)e.callstack.push(t.Copy());return e.previousPointer=this.previousPointer.copy(),e}WriteJson(e){e.WriteObjectStart(),e.WritePropertyStart("callstack"),e.WriteArrayStart();for(var t of this.callstack){if(e.WriteObjectStart(),!t.currentPointer.isNull){if(null===t.currentPointer.container)return g("el.currentPointer.container");e.WriteProperty("cPath",t.currentPointer.container.path.componentsString),e.WriteIntProperty("idx",t.currentPointer.index)}e.WriteProperty("exp",t.inExpressionEvaluation),e.WriteIntProperty("type",t.type),0<t.temporaryVariables.size&&(e.WritePropertyStart("temp"),V.WriteDictionaryRuntimeObjs(e,t.temporaryVariables),e.WritePropertyEnd()),e.WriteObjectEnd()}if(e.WriteArrayEnd(),e.WritePropertyEnd(),e.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){let t=this.previousPointer.Resolve();if(null===t)return g("this.previousPointer.Resolve()");e.WriteProperty("previousContentObject",""+t.path)}e.WriteObjectEnd()}}})(Xt=Xt||{});class Yt extends class{}{variableChangedEvent(t,e){for(var n of this.variableChangedEventCallbacks)n(t,e)}StartVariableObservation(){this._batchObservingVariableChanges=!0,this._changedVariablesForBatchObs=new Set}CompleteVariableObservation(){this._batchObservingVariableChanges=!1;var e=new Map;if(null!=this._changedVariablesForBatchObs)for(let t of this._changedVariablesForBatchObs){var n=this._globalVariables.get(t);this.variableChangedEvent(t,n)}if(null!=this.patch)for(let t of this.patch.changedVariables){var i=this.patch.TryGetGlobal(t,null);i.exists&&e.set(t,i)}return this._changedVariablesForBatchObs=null,e}NotifyObservers(t){for(var[e,n]of t)this.variableChangedEvent(e,n)}get callStack(){return this._callStack}set callStack(t){this._callStack=t}$(e,t){if(void 0===t){let t=null;return null!==this.patch&&(t=this.patch.TryGetGlobal(e,null)).exists?t.result.valueObject:void 0!==(t=void 0===(t=this._globalVariables.get(e))?this._defaultGlobalVariables.get(e):t)?t.valueObject:null}if(void 0===this._defaultGlobalVariables.get(e))throw new y("Cannot assign to a variable ("+e+") that hasn't been declared in the story");var n=w.Create(t);if(null==n)throw Error(null==t?"Cannot pass null to VariableState":"Invalid value passed to VariableState: "+t);this.SetGlobal(e,n)}constructor(t,e){super(),this.variableChangedEventCallbacks=[],this.patch=null,this._defaultGlobalVariables=new Map,this._changedVariablesForBatchObs=new Set,this._batchObservingVariableChanges=!1,this._globalVariables=new Map,this._callStack=t,this._listDefsOrigin=e;try{return new Proxy(this,{get:(t,e)=>e in t?t[e]:t.$(e),set:(t,e,n)=>(e in t?t[e]=n:t.$(e,n),!0)})}catch(t){}}ApplyPatch(){if(null===this.patch)return g("this.patch");for(var[t,e]of this.patch.globals)this._globalVariables.set(t,e);if(null!==this._changedVariablesForBatchObs)for(let t of this.patch.changedVariables)this._changedVariablesForBatchObs.add(t);this.patch=null}SetJsonToken(t){this._globalVariables.clear();for(var[e,n]of this._defaultGlobalVariables){var i=t[e];if(void 0!==i){let t=V.JTokenToRuntimeObject(i);if(null===t)return g("tokenInkObject");this._globalVariables.set(e,t)}else this._globalVariables.set(e,n)}}WriteJson(t){t.WriteObjectStart();for(var[e,n]of this._globalVariables){if(Yt.dontSaveDefaultValues&&this._defaultGlobalVariables.has(e)){let t=this._defaultGlobalVariables.get(e);if(this.RuntimeObjectsEqual(n,t))continue}t.WritePropertyStart(e),V.WriteRuntimeObject(t,n),t.WritePropertyEnd()}t.WriteObjectEnd()}RuntimeObjectsEqual(t,e){if(null===t)return g("obj1");if(null===e)return g("obj2");if(t.constructor!==e.constructor)return!1;var n=d(t,Y);if(null!==n)return n.value===f(e,Y).value;n=d(t,E);if(null!==n)return n.value===f(e,E).value;n=d(t,Z);if(null!==n)return n.value===f(e,Z).value;n=d(t,w),e=d(e,w);if(null!==n&&null!==e)return K(n.valueObject)&&K(e.valueObject)?n.valueObject.Equals(e.valueObject):n.valueObject===e.valueObject;throw Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+t.constructor.name)}GetVariableWithName(t){let e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1,n=this.GetRawVariableWithName(t,e),i=d(n,tt);return n=null!==i?this.ValueAtVariablePointer(i):n}TryGetDefaultVariableValue(t){t=a(this._defaultGlobalVariables,t,null);return t.exists?t.result:null}GlobalVariableExistsWithName(t){return this._globalVariables.has(t)||null!==this._defaultGlobalVariables&&this._defaultGlobalVariables.has(t)}GetRawVariableWithName(n,t){if(0==t||-1==t){let t=null;if(null!==this.patch&&(t=this.patch.TryGetGlobal(n,null)).exists)return t.result;if((t=a(this._globalVariables,n,null)).exists)return t.result;if(null!==this._defaultGlobalVariables&&(t=a(this._defaultGlobalVariables,n,null)).exists)return t.result;if(null===this._listDefsOrigin)return g("VariablesState._listDefsOrigin");let e=this._listDefsOrigin.FindSingleItemListWithName(n);if(e)return e}return this._callStack.GetTemporaryVariableWithName(n,t)}ValueAtVariablePointer(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}Assign(t,e){let n=t.variableName;if(null===n)return g("name");let i=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:this.GlobalVariableExistsWithName(n),t.isNewDeclaration){let t=d(e,tt);null!==t&&(e=this.ResolveVariablePointer(t))}else{let t;for(;null!=(t=d(this.GetRawVariableWithName(n,i),tt))&&(n=t.variableName,i=t.contextIndex,r=0==i),null!=t;);}r?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}SnapshotDefaultGlobals(){this._defaultGlobalVariables=new Map(this._globalVariables)}RetainListOriginsForAssignment(t,e){t=f(t,T),e=f(e,T);t.value&&e.value&&0==e.value.Count&&e.value.SetInitialOriginNames(t.value.originNames)}SetGlobal(t,e){let n=null;if(null===this.patch&&(n=a(this._globalVariables,t,null)),null!==this.patch&&((n=this.patch.TryGetGlobal(t,null)).exists||(n=a(this._globalVariables,t,null))),T.RetainListOriginsForAssignment(n.result,e),null===t)return g("variableName");if(null!==this.patch?this.patch.SetGlobal(t,e):this._globalVariables.set(t,e),null!==this.variableChangedEvent&&null!==n&&e!==n.result)if(this._batchObservingVariableChanges){if(null===this._changedVariablesForBatchObs)return g("this._changedVariablesForBatchObs");null!==this.patch?this.patch.AddChangedVariable(t):null!==this._changedVariablesForBatchObs&&this._changedVariablesForBatchObs.add(t)}else this.variableChangedEvent(t,e)}ResolveVariablePointer(t){let e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));var n=d(this.GetRawVariableWithName(t.variableName,e),tt);return null!=n?n:new tt(t.variableName,e)}GetContextIndexOfVariableNamed(t){return this.GlobalVariableExistsWithName(t)?0:this._callStack.currentElementIndex}ObserveVariableChange(t){this.variableChangedEventCallbacks.push(t)}}Yt.dontSaveDefaultValues=!0;class Zt{constructor(t){this.seed=t%2147483647,0<this.seed||(this.seed+=2147483646)}next(){return this.seed=48271*this.seed%2147483647}nextFloat(){return(this.next()-1)/2147483646}}class Qt{get globals(){return this._globals}get changedVariables(){return this._changedVariables}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}constructor(){var t;this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,1===arguments.length&&null!==arguments[0]?(this._globals=new Map((t=arguments[0])._globals),this._changedVariables=new Set(t._changedVariables),this._visitCounts=new Map(t._visitCounts),this._turnIndices=new Map(t._turnIndices)):(this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map)}TryGetGlobal(t,e){return null!==t&&this._globals.has(t)?{result:this._globals.get(t),exists:!0}:{result:e,exists:!1}}SetGlobal(t,e){this._globals.set(t,e)}AddChangedVariable(t){return this._changedVariables.add(t)}TryGetVisitCount(t,e){return this._visitCounts.has(t)?{result:this._visitCounts.get(t),exists:!0}:{result:e,exists:!1}}SetVisitCount(t,e){this._visitCounts.set(t,e)}SetTurnIndex(t,e){this._turnIndices.set(t,e)}TryGetTurnIndex(t,e){return this._turnIndices.has(t)?{result:this._turnIndices.get(t),exists:!0}:{result:e,exists:!1}}}class te{static TextToDictionary(t){return new te.Reader(t).ToDictionary()}static TextToArray(t){return new te.Reader(t).ToArray()}}(n=>{n.Reader=class{constructor(t){this._rootObject=JSON.parse(t)}ToDictionary(){return this._rootObject}ToArray(){return this._rootObject}};class t{constructor(){this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}WriteObject(t){this.WriteObjectStart(),t(this),this.WriteObjectEnd()}WriteObjectStart(){this.StartNewObject(!0);var e={};if(this.state===n.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let t=this._propertyNameStack.pop();this.currentCollection[t]=e}else this.state===n.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e)):(this.Assert(this.state===n.Writer.State.None),this._jsonObject=e);this._collectionStack.push(e),this._stateStack.push(new n.Writer.StateElement(n.Writer.State.Object))}WriteObjectEnd(){this.Assert(this.state===n.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}WriteProperty(t,e){if(this.WritePropertyStart(t),e instanceof Function)e(this);else{let t=e;this.Write(t)}this.WritePropertyEnd()}WriteIntProperty(t,e){this.WritePropertyStart(t),this.WriteInt(e),this.WritePropertyEnd()}WriteFloatProperty(t,e){this.WritePropertyStart(t),this.WriteFloat(e),this.WritePropertyEnd()}WritePropertyStart(t){this.Assert(this.state===n.Writer.State.Object),this._propertyNameStack.push(t),this.IncrementChildCount(),this._stateStack.push(new n.Writer.StateElement(n.Writer.State.Property))}WritePropertyEnd(){this.Assert(this.state===n.Writer.State.Property),this.Assert(1===this.childCount),this._stateStack.pop()}WritePropertyNameStart(){this.Assert(this.state===n.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new n.Writer.StateElement(n.Writer.State.Property)),this._stateStack.push(new n.Writer.StateElement(n.Writer.State.PropertyName))}WritePropertyNameEnd(){this.Assert(this.state===n.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}WritePropertyNameInner(t){this.Assert(this.state===n.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._currentPropertyName+=t}WriteArrayStart(){this.StartNewObject(!0);var e=[];if(this.state===n.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let t=this._propertyNameStack.pop();this.currentCollection[t]=e}else this.state===n.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e)):(this.Assert(this.state===n.Writer.State.None),this._jsonObject=e);this._collectionStack.push(e),this._stateStack.push(new n.Writer.StateElement(n.Writer.State.Array))}WriteArrayEnd(){this.Assert(this.state===n.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}Write(t){null!==t?(this.StartNewObject(!1),this._addToCurrentObject(t)):console.error("Warning: trying to write a null value")}WriteBool(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(t))}WriteInt(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(t)))}WriteFloat(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(t==1/0?34e37:t==-1/0?-34e37:isNaN(t)?0:t))}WriteNull(){this.StartNewObject(!1),this._addToCurrentObject(null)}WriteStringStart(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new n.Writer.StateElement(n.Writer.State.String))}WriteStringEnd(){this.Assert(this.state==n.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}WriteStringInner(t){this.Assert(this.state===n.Writer.State.String),null!==t?this._currentString+=t:console.error("Warning: trying to write a null string")}toString(){return null===this._jsonObject?"":JSON.stringify(this._jsonObject)}StartNewObject(t){this.Assert(t?this.state===n.Writer.State.None||this.state===n.Writer.State.Property||this.state===n.Writer.State.Array:this.state===n.Writer.State.Property||this.state===n.Writer.State.Array),this.state===n.Writer.State.Property&&this.Assert(0===this.childCount),this.state!==n.Writer.State.Array&&this.state!==n.Writer.State.Property||this.IncrementChildCount()}get state(){return 0<this._stateStack.length?this._stateStack[this._stateStack.length-1].type:n.Writer.State.None}get childCount(){return 0<this._stateStack.length?this._stateStack[this._stateStack.length-1].childCount:0}get currentCollection(){return 0<this._collectionStack.length?this._collectionStack[this._collectionStack.length-1]:null}get currentPropertyName(){return 0<this._propertyNameStack.length?this._propertyNameStack[this._propertyNameStack.length-1]:null}IncrementChildCount(){this.Assert(0<this._stateStack.length);var t=this._stateStack.pop();t.childCount++,this._stateStack.push(t)}Assert(t){if(!t)throw Error("Assert failed while writing JSON")}_addToCurrentObject(t){this.Assert(null!==this.currentCollection),this.state===n.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(t)):this.state===n.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(null!==this.currentPropertyName),this.currentCollection[this.currentPropertyName]=t,this._propertyNameStack.pop())}}n.Writer=t,(t=>{var e;(e=t.State||(t.State={}))[e.None=0]="None",e[e.Object=1]="Object",e[e.Array=2]="Array",e[e.Property=3]="Property",e[e.PropertyName=4]="PropertyName",e[e.String=5]="String",t.StateElement=class{constructor(t){this.type=n.Writer.State.None,this.childCount=0,this.type=t}}})(t=n.Writer||(n.Writer={}))})(te=te||{});class ee{constructor(){var t=arguments[0],e=arguments[1];if(this.name=t,this.callStack=new Xt(e),arguments[2]){let t=arguments[2];this.callStack.SetJsonToken(t.callstack,e),this.outputStream=V.JArrayToRuntimeObjList(t.outputStream),this.currentChoices=V.JArrayToRuntimeObjList(t.currentChoices);var n=t.choiceThreads;void 0!==n&&this.LoadFlowChoiceThreads(n,e)}else this.outputStream=[],this.currentChoices=[]}WriteJson(t){t.WriteObjectStart(),t.WriteProperty("callstack",t=>this.callStack.WriteJson(t)),t.WriteProperty("outputStream",t=>V.WriteListRuntimeObjs(t,this.outputStream));let e=!1;for(var n of this.currentChoices){if(null===n.threadAtGeneration)return g("c.threadAtGeneration");n.originalThreadIndex=n.threadAtGeneration.threadIndex,null===this.callStack.ThreadWithIndex(n.originalThreadIndex)&&(e||(e=!0,t.WritePropertyStart("choiceThreads"),t.WriteObjectStart()),t.WritePropertyStart(n.originalThreadIndex),n.threadAtGeneration.WriteJson(t),t.WritePropertyEnd())}e&&(t.WriteObjectEnd(),t.WritePropertyEnd()),t.WriteProperty("currentChoices",t=>{t.WriteArrayStart();for(var e of this.currentChoices)V.WriteChoice(t,e);t.WriteArrayEnd()}),t.WriteObjectEnd()}LoadFlowChoiceThreads(e,n){for(var i of this.currentChoices){var t=this.callStack.ThreadWithIndex(i.originalThreadIndex);if(null!==t)i.threadAtGeneration=t.Copy();else{let t=e[""+i.originalThreadIndex];i.threadAtGeneration=new Xt.Thread(t,n)}}}}class ne{ToJson(){var t=new te.Writer;return this.WriteJson(t),""+t}toJson(){return this.ToJson(0<arguments.length&&void 0!==arguments[0]&&arguments[0])}LoadJson(t){t=te.TextToDictionary(t);this.LoadJsonObj(t),null!==this.onDidLoadState&&this.onDidLoadState()}VisitCountAtPathString(t){let e;if(null!==this._patch){var n=this.story.ContentAtPath(new m(t)).container;if(null===n)throw Error("Content at path not found: "+t);if((e=this._patch.TryGetVisitCount(n,0)).exists)return e.result}return(e=a(this._visitCounts,t,null)).exists?e.result:0}VisitCountForContainer(e){if(null===e)return g("container");if(!e.visitsShouldBeCounted)return this.story.Error("Read count for target ("+e.name+" - on "+e.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(null!==this._patch){let t=this._patch.TryGetVisitCount(e,0);if(t.exists)return t.result}e=a(this._visitCounts,""+e.path,null);return e.exists?e.result:0}IncrementVisitCountForContainer(e){if(null!==this._patch){let t=this.VisitCountForContainer(e);t++,void this._patch.SetVisitCount(e,t)}else{var e=""+e.path,t=a(this._visitCounts,e,null);this._visitCounts.set(e,t.exists?t.result+1:1)}}RecordTurnIndexVisitToContainer(t){null!==this._patch?this._patch.SetTurnIndex(t,this.currentTurnIndex):this._turnIndices.set(""+t.path,this.currentTurnIndex)}TurnsSinceForContainer(e){if(e.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+e.name+" - on "+e.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),null!==this._patch){let t=this._patch.TryGetTurnIndex(e,0);if(t.exists)return this.currentTurnIndex-t.result}e=a(this._turnIndices,""+e.path,0);return e.exists?this.currentTurnIndex-e.result:-1}get callstackDepth(){return this.callStack.depth}get outputStream(){return this._currentFlow.outputStream}get currentChoices(){return this.canContinue?[]:this._currentFlow.currentChoices}get generatedChoices(){return this._currentFlow.currentChoices}get currentErrors(){return this._currentErrors}get currentWarnings(){return this._currentWarnings}get variablesState(){return this._variablesState}set variablesState(t){this._variablesState=t}get callStack(){return this._currentFlow.callStack}get evaluationStack(){return this._evaluationStack}get currentTurnIndex(){return this._currentTurnIndex}set currentTurnIndex(t){this._currentTurnIndex=t}get currentPathString(){var t=this.currentPointer;return t.isNull?null:null===t.path?g("pointer.path"):""+t.path}get previousPathString(){var t=this.previousPointer;return t.isNull?null:null===t.path?g("previousPointer.path"):""+t.path}get currentPointer(){return this.callStack.currentElement.currentPointer.copy()}set currentPointer(t){this.callStack.currentElement.currentPointer=t.copy()}get previousPointer(){return this.callStack.currentThread.previousPointer.copy()}set previousPointer(t){this.callStack.currentThread.previousPointer=t.copy()}get canContinue(){return!this.currentPointer.isNull&&!this.hasError}get hasError(){return null!=this.currentErrors&&0<this.currentErrors.length}get hasWarning(){return null!=this.currentWarnings&&0<this.currentWarnings.length}get currentText(){if(this._outputStreamTextDirty){let t=new b,e=!1;for(var n of this.outputStream){var i=d(n,_);if(e||null===i){let t=d(n,x);null!==t&&(t.commandType==x.CommandType.BeginTag?e=!0:t.commandType==x.CommandType.EndTag&&(e=!1))}else t.Append(i.value)}this._currentText=this.CleanOutputWhitespace(""+t),this._outputStreamTextDirty=!1}return this._currentText}CleanOutputWhitespace(e){let n=new b,i=-1,r=0;for(let t=0;t<e.length;t++){var a=e[0|t]||"",s=" "==a||"\t"==a;s&&-1==i&&(i=t),s||("\n"!=a&&0<i&&i!=r&&n.Append(" "),i=-1),"\n"==a&&(r=t+1),s||n.Append(a)}return""+n}get currentTags(){if(this._outputStreamTagsDirty){let t=!(this._currentTags=[]),e=new b;for(var n of this.outputStream){var i=d(n,x);if(null!=i){if(i.commandType==x.CommandType.BeginTag){if(t&&0<e.Length){let t=this.CleanOutputWhitespace(""+e);this._currentTags.push(t),e.Clear()}t=!0}else if(i.commandType==x.CommandType.EndTag){if(0<e.Length){let t=this.CleanOutputWhitespace(""+e);this._currentTags.push(t),e.Clear()}t=!1}}else if(t){let t=d(n,_);null!==t&&e.Append(t.value)}else{let t=d(n,Ht);null!=t&&null!=t.text&&0<t.text.length&&this._currentTags.push(t.text)}}if(0<e.Length){let t=this.CleanOutputWhitespace(""+e);this._currentTags.push(t),e.Clear()}this._outputStreamTagsDirty=!1}return this._currentTags}get currentFlowName(){return this._currentFlow.name}get currentFlowIsDefaultFlow(){return this._currentFlow.name==this.kDefaultFlowName}get aliveFlowNames(){if(this._aliveFlowNamesDirty){if(this._aliveFlowNames=[],null!=this._namedFlows)for(var t of this._namedFlows.keys())t!=this.kDefaultFlowName&&this._aliveFlowNames.push(t);this._aliveFlowNamesDirty=!1}return this._aliveFlowNames}get inExpressionEvaluation(){return this.callStack.currentElement.inExpressionEvaluation}set inExpressionEvaluation(t){this.callStack.currentElement.inExpressionEvaluation=t}constructor(t){this.kInkSaveStateVersion=10,this.kMinCompatibleLoadVersion=8,this.onDidLoadState=null,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=F.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this._aliveFlowNames=null,this._namedFlows=null,this.kDefaultFlowName="DEFAULT_FLOW",this._aliveFlowNamesDirty=!0,this.story=t,this._currentFlow=new ee(this.kDefaultFlowName,t),this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this._evaluationStack=[],this._variablesState=new Yt(this.callStack,t.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;t=(new Date).getTime();this.storySeed=new Zt(t).next()%100,this.previousRandom=0,this.GoToStart()}GoToStart(){this.callStack.currentElement.currentPointer=F.StartOf(this.story.mainContentContainer)}SwitchFlow_Internal(n){if(null===n)throw Error("Must pass a non-null string to Story.SwitchFlow");if(null===this._namedFlows&&(this._namedFlows=new Map,this._namedFlows.set(this.kDefaultFlowName,this._currentFlow)),n!==this._currentFlow.name){let t,e=a(this._namedFlows,n,null);e.exists?t=e.result:(t=new ee(n,this.story),this._namedFlows.set(n,t),this._aliveFlowNamesDirty=!0),this._currentFlow=t,this.variablesState.callStack=this._currentFlow.callStack,this.OutputStreamDirty()}}SwitchToDefaultFlow_Internal(){null!==this._namedFlows&&this.SwitchFlow_Internal(this.kDefaultFlowName)}RemoveFlow_Internal(t){if(null===t)throw Error("Must pass a non-null string to Story.DestroyFlow");if(t===this.kDefaultFlowName)throw Error("Cannot destroy default flow");if(this._currentFlow.name===t&&this.SwitchToDefaultFlow_Internal(),null===this._namedFlows)return g("this._namedFlows");this._namedFlows.delete(t),this._aliveFlowNamesDirty=!0}CopyAndStartPatching(t){var n=new ne(this.story);if(n._patch=new Qt(this._patch),n._currentFlow.name=this._currentFlow.name,n._currentFlow.callStack=new Xt(this._currentFlow.callStack),n._currentFlow.outputStream.push(...this._currentFlow.outputStream),n.OutputStreamDirty(),t)for(let t of this._currentFlow.currentChoices)n._currentFlow.currentChoices.push(t.Clone());else n._currentFlow.currentChoices.push(...this._currentFlow.currentChoices);if(null!==this._namedFlows){n._namedFlows=new Map;for(let[t,e]of this._namedFlows)n._namedFlows.set(t,e),n._aliveFlowNamesDirty=!0;n._namedFlows.set(this._currentFlow.name,n._currentFlow)}return this.hasError&&(n._currentErrors=[],n._currentErrors.push(...this.currentErrors||[])),this.hasWarning&&(n._currentWarnings=[],n._currentWarnings.push(...this.currentWarnings||[])),n.variablesState=this.variablesState,n.variablesState.callStack=n.callStack,n.variablesState.patch=n._patch,n.evaluationStack.push(...this.evaluationStack),this.divertedPointer.isNull||(n.divertedPointer=this.divertedPointer.copy()),n.previousPointer=this.previousPointer.copy(),n._visitCounts=this._visitCounts,n._turnIndices=this._turnIndices,n.currentTurnIndex=this.currentTurnIndex,n.storySeed=this.storySeed,n.previousRandom=this.previousRandom,n.didSafeExit=this.didSafeExit,n}RestoreAfterPatch(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}ApplyAnyPatch(){if(null!==this._patch){this.variablesState.ApplyPatch();for(var[t,e]of this._patch.visitCounts)this.ApplyCountChanges(t,e,!0);for(let[t,e]of this._patch.turnIndices)this.ApplyCountChanges(t,e,!1);this._patch=null}}ApplyCountChanges(t,e,n){(n?this._visitCounts:this._turnIndices).set(""+t.path,e)}WriteJson(n){if(n.WriteObjectStart(),n.WritePropertyStart("flows"),n.WriteObjectStart(),null!==this._namedFlows)for(let[t,e]of this._namedFlows)n.WriteProperty(t,t=>e.WriteJson(t));else n.WriteProperty(this._currentFlow.name,t=>this._currentFlow.WriteJson(t));if(n.WriteObjectEnd(),n.WritePropertyEnd(),n.WriteProperty("currentFlowName",this._currentFlow.name),n.WriteProperty("variablesState",t=>this.variablesState.WriteJson(t)),n.WriteProperty("evalStack",t=>V.WriteListRuntimeObjs(t,this.evaluationStack)),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return g("divertedPointer");n.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}n.WriteProperty("visitCounts",t=>V.WriteIntDictionary(t,this._visitCounts)),n.WriteProperty("turnIndices",t=>V.WriteIntDictionary(t,this._turnIndices)),n.WriteIntProperty("turnIdx",this.currentTurnIndex),n.WriteIntProperty("storySeed",this.storySeed),n.WriteIntProperty("previousRandom",this.previousRandom),n.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),n.WriteIntProperty("inkFormatVersion",re.inkVersionCurrent),n.WriteObjectEnd()}LoadJsonObj(t){var e=t,t=e.inkSaveVersion;if(null==t)throw Error("ink save format incorrect, can't load.");if(parseInt(t)<this.kMinCompatibleLoadVersion)throw Error("Ink save format isn't compatible with the current version (saw '"+t+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");var n=e.flows;if(null!=n){let a=n,t=(1===Object.keys(a).length?this._namedFlows=null:null===this._namedFlows?this._namedFlows=new Map:this._namedFlows.clear(),Object.entries(a));for(let[i,r]of t){let t=i,e=r,n=new ee(t,this.story,e);if(1===Object.keys(a).length)this._currentFlow=new ee(t,this.story,e);else{if(null===this._namedFlows)return g("this._namedFlows");this._namedFlows.set(t,n)}}if(null!=this._namedFlows&&1<this._namedFlows.size){let t=e.currentFlowName;this._currentFlow=this._namedFlows.get(t)}}else{this._namedFlows=null,this._currentFlow.name=this.kDefaultFlowName,this._currentFlow.callStack.SetJsonToken(e.callstackThreads,this.story),this._currentFlow.outputStream=V.JArrayToRuntimeObjList(e.outputStream),this._currentFlow.currentChoices=V.JArrayToRuntimeObjList(e.currentChoices);let t=e.choiceThreads;this._currentFlow.LoadFlowChoiceThreads(t,this.story)}this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this.variablesState.SetJsonToken(e.variablesState),this.variablesState.callStack=this._currentFlow.callStack,this._evaluationStack=V.JArrayToRuntimeObjList(e.evalStack);n=e.currentDivertTarget;if(null!=n){let t=new m(""+n);this.divertedPointer=this.story.PointerAtPath(t)}this._visitCounts=V.JObjectToIntDictionary(e.visitCounts),this._turnIndices=V.JObjectToIntDictionary(e.turnIndices),this.currentTurnIndex=parseInt(e.turnIdx),this.storySeed=parseInt(e.storySeed),this.previousRandom=parseInt(e.previousRandom)}ResetErrors(){this._currentErrors=null,this._currentWarnings=null}ResetOutput(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;this.outputStream.length=0,null!==t&&this.outputStream.push(...t),this.OutputStreamDirty()}PushToOutputStream(t){var n=d(t,_);if(null!==n){let e=this.TrySplittingHeadTailWhitespace(n);if(null!==e){for(let t of e)this.PushToOutputStreamIndividual(t);return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}PopFromOutputStream(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}TrySplittingHeadTailWhitespace(t){var n=t.value;if(null===n)return g("single.value");let i=-1,r=-1;for(let e=0;e<n.length;e++){let t=n[e];if("\n"!=t){if(" "==t||"\t"==t)continue;break}-1==i&&(i=e),r=e}let a=-1,s=-1;for(let e=n.length-1;0<=e;e--){let t=n[e];if("\n"!=t){if(" "==t||"\t"==t)continue;break}-1==a&&(a=e),s=e}if(-1==i&&-1==a)return null;let o=[],e=0,l=n.length;if(-1!=i){if(0<i){let t=new _(n.substring(0,i));o.push(t)}o.push(new _("\n")),e=r+1}if((l=-1!=a?s:l)>e){let t=n.substring(e,l);o.push(new _(t))}if(-1!=a&&s>r&&(o.push(new _("\n")),a<n.length-1)){let t=n.length-a-1,e=new _(n.substring(a+1,a+1+t));o.push(e)}return o}PushToOutputStreamIndividual(t){let e=d(t,Vt),n=d(t,_),a=!0;if(e)this.TrimNewlinesFromOutputStream(),a=!0;else if(n){let i=-1,t=this.callStack.currentElement,r=(t.type==u.Function&&(i=t.functionStartInOutputStream),-1);for(let n=this.outputStream.length-1;0<=n;n--){let t=this.outputStream[n],e=t instanceof x?t:null;if(null!=(t instanceof Vt?t:null)){r=n;break}if(null!=e&&e.commandType==x.CommandType.BeginString){n<i||(i=-1);break}}let e;if(-1!=(e=-1!=r&&-1!=i?Math.min(i,r):-1!=r?r:i)){if(n.isNewline)a=!1;else if(n.isNonWhitespace&&(-1<r&&this.RemoveExistingGlue(),-1<i)){let n=this.callStack.elements;for(let e=n.length-1;0<=e;e--){let t=n[e];if(t.type!=u.Function)break;t.functionStartInOutputStream=-1}}}else!n.isNewline||!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(a=!1)}if(a){if(null===t)return g("obj");this.outputStream.push(t),this.OutputStreamDirty()}}TrimNewlinesFromOutputStream(){let t=-1,e=this.outputStream.length-1;for(;0<=e;){var n=this.outputStream[e],i=d(n,x),n=d(n,_);if(null!=i||null!=n&&n.isNonWhitespace)break;null!=n&&n.isNewline&&(t=e),e--}if(0<=t)for(e=t;e<this.outputStream.length;)d(this.outputStream[e],_)?this.outputStream.splice(e,1):e++;this.OutputStreamDirty()}RemoveExistingGlue(){for(let t=this.outputStream.length-1;0<=t;t--){var e=this.outputStream[t];if(e instanceof Vt)this.outputStream.splice(t,1);else if(e instanceof x)break}this.OutputStreamDirty()}get outputStreamEndsInNewline(){if(0<this.outputStream.length)for(let t=this.outputStream.length-1;0<=t&&!(this.outputStream[t]instanceof x);t--){var e=this.outputStream[t];if(e instanceof _){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}get outputStreamContainsContent(){for(var t of this.outputStream)if(t instanceof _)return!0;return!1}get inStringEvaluation(){for(let t=this.outputStream.length-1;0<=t;t--){var e=d(this.outputStream[t],x);if(e instanceof x&&e.commandType==x.CommandType.BeginString)return!0}return!1}PushEvaluationStack(t){var n=d(t,T);if(n){let e=n.value;if(null===e)return g("rawList");if(null!=e.originNames){e.origins||(e.origins=[]),e.origins.length=0;for(let t of e.originNames){if(null===this.story.listDefinitions)return g("StoryState.story.listDefinitions");var i=this.story.listDefinitions.TryListGetDefinition(t,null);if(null===i.result)return g("StoryState def.result");~e.origins.indexOf(i.result)||e.origins.push(i.result)}}}if(null===t)return g("obj");this.evaluationStack.push(t)}PopEvaluationStack(t){if(void 0===t)return U(this.evaluationStack.pop());if(this.evaluationStack.length<t)throw Error("trying to pop too many objects");return U(this.evaluationStack.splice(this.evaluationStack.length-t,t))}PeekEvaluationStack(){return this.evaluationStack[this.evaluationStack.length-1]}ForceEnd(){this.callStack.Reset(),this._currentFlow.currentChoices.length=0,this.currentPointer=F.Null,this.previousPointer=F.Null,this.didSafeExit=!0}TrimWhitespaceFromFunctionEnd(){M.Assert(this.callStack.currentElement.type==u.Function);let t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(let i=this.outputStream.length-1;i>=t;i--){let t=this.outputStream[i],e=d(t,_),n=d(t,x);if(null!=e){if(n)break;if(!e.isNewline&&!e.isInlineWhitespace)break;this.outputStream.splice(i,1),this.OutputStreamDirty()}}}PopCallStack(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;this.callStack.currentElement.type==u.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}SetChosenPath(t,e){this._currentFlow.currentChoices.length=0;t=this.story.PointerAtPath(t);t.isNull||-1!=t.index||(t.index=0),this.currentPointer=t,e&&this.currentTurnIndex++}StartFunctionEvaluationFromGame(t,e){this.callStack.Push(u.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=F.StartOf(t),this.PassArgumentsToEvaluationStack(e)}PassArgumentsToEvaluationStack(e){if(null!==e)for(let t=0;t<e.length;t++){if(!("number"==typeof e[t]||"string"==typeof e[t]||"boolean"==typeof e[t]||e[t]instanceof S))throw Error("ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters must benumber, string, bool or InkList. Argument was "+(null===U(e[t])?"null":e[t].constructor.name));this.PushEvaluationStack(w.Create(e[t]))}}TryExitFunctionEvaluationFromGame(){return this.callStack.currentElement.type==u.FunctionEvaluationFromGame&&(this.currentPointer=F.Null,this.didSafeExit=!0)}CompleteFunctionEvaluationFromGame(){if(this.callStack.currentElement.type!=u.FunctionEvaluationFromGame)throw Error("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);let t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;for(;t<this.evaluationStack.length;){let t=this.PopEvaluationStack();null===e&&(e=t)}if(this.PopCallStack(u.FunctionEvaluationFromGame),e){if(e instanceof nt)return null;let t=f(e,w);return t.valueType==h.DivertTarget?""+t.valueObject:t.valueObject}return null}AddError(t,e){(e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors)).push(t)}OutputStreamDirty(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}}class ie{constructor(){this.startTime=void 0}get ElapsedMilliseconds(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}Start(){this.startTime=(new Date).getTime()}Stop(){this.startTime=void 0}}(t=>{t[t.Author=0]="Author",t[t.Warning=1]="Warning",t[t.Error=2]="Error"})(G=G||{}),Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&-9007199254740992<t&&t<9007199254740992&&Math.floor(t)===t});let re=class s extends v{get currentChoices(){var t,e=[];if(null===this._state)return g("this._state");for(t of this._state.currentChoices)t.isInvisibleDefault||(t.index=e.length,e.push(t));return e}get currentText(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}get currentTags(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}get currentErrors(){return this.state.currentErrors}get currentWarnings(){return this.state.currentWarnings}get currentFlowName(){return this.state.currentFlowName}get currentFlowIsDefaultFlow(){return this.state.currentFlowIsDefaultFlow}get aliveFlowNames(){return this.state.aliveFlowNames}get hasError(){return this.state.hasError}get hasWarning(){return this.state.hasWarning}get variablesState(){return this.state.variablesState}get listDefinitions(){return this._listDefinitions}get state(){return this._state}StartProfiling(){}EndProfiling(){}constructor(){var t;super(),this.inkVersionMinimumCompatible=18,this.onError=null,this.onDidContinue=null,this.onMakeChoice=null,this.onEvaluateFunction=null,this.onCompleteEvaluateFunction=null,this.onChoosePathString=null,this._prevContainers=[],this.allowExternalFunctionFallbacks=!1,this._listDefinitions=null,this._variableObservers=null,this._hasValidatedExternals=!1,this._temporaryEvaluationContainer=null,this._asyncContinueActive=!1,this._stateSnapshotAtLastNewline=null,this._sawLookaheadUnsafeFunctionAfterNewline=!1,this._recursiveContinueCount=0,this._asyncSaving=!1;let e=this._profiler=null,n=null;if(arguments[0]instanceof A)t=arguments[0],void 0!==arguments[1]&&(e=arguments[1]),this._mainContentContainer=t;else if("string"==typeof arguments[0]){let t=arguments[0];n=te.TextToDictionary(t)}else n=arguments[0];if(null!=e&&(this._listDefinitions=new zt(e)),this._externals=new Map,null!==n){let t=n,e=t.inkVersion;if(null==e)throw Error("ink version number not found. Are you sure it's a valid .ink.json file?");var i=parseInt(e);if(i>s.inkVersionCurrent)throw Error("Version of ink used to build story was newer than the current version of the engine");if(i<this.inkVersionMinimumCompatible)throw Error("Version of ink used to build story is too old to be loaded by this version of the engine");i!=s.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");var r,i=t.root;if(null==i)throw Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(r=t.listDefs)&&(this._listDefinitions=V.JTokenToListDefinitions(r)),this._mainContentContainer=f(V.JTokenToRuntimeObject(i),A),this.ResetState()}}ToJson(r){let t=!1;if(r||(t=!0,r=new te.Writer),r.WriteObjectStart(),r.WriteIntProperty("inkVersion",s.inkVersionCurrent),r.WriteProperty("root",t=>V.WriteRuntimeContainer(t,this._mainContentContainer)),null!=this._listDefinitions){r.WritePropertyStart("listDefs"),r.WriteObjectStart();for(let t of this._listDefinitions.lists){r.WritePropertyStart(t.name),r.WriteObjectStart();for(let[n,i]of t.items){let t=C.fromSerializedKey(n),e=i;r.WriteIntProperty(t.itemName,e)}r.WriteObjectEnd(),r.WritePropertyEnd()}r.WriteObjectEnd(),r.WritePropertyEnd()}if(r.WriteObjectEnd(),t)return""+r}ResetState(){this.IfAsyncWeCant("ResetState"),this._state=new ne(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}ResetErrors(){if(null===this._state)return g("this._state");this._state.ResetErrors()}ResetCallstack(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return g("this._state");this._state.ForceEnd()}ResetGlobals(){var t;this._mainContentContainer.namedContent.get("global decl")&&(t=this.state.currentPointer.copy(),this.ChoosePath(new m("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t),this.state.variablesState.SnapshotDefaultGlobals()}SwitchFlow(t){if(this.IfAsyncWeCant("switch flow"),this._asyncSaving)throw Error("Story is already in background saving mode, can't switch flow to "+t);this.state.SwitchFlow_Internal(t)}RemoveFlow(t){this.state.RemoveFlow_Internal(t)}SwitchToDefaultFlow(){this.state.SwitchToDefaultFlow_Internal()}Continue(){return this.ContinueAsync(0),this.currentText}get canContinue(){return this.state.canContinue}get asyncContinueComplete(){return!this._asyncContinueActive}ContinueAsync(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}ContinueInternal(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,e=(null!=this._profiler&&this._profiler.PreContinue(),0<t);if(this._recursiveContinueCount++,this._asyncContinueActive)this._asyncContinueActive&&!e&&(this._asyncContinueActive=!1);else{if(this._asyncContinueActive=e,!this.canContinue)throw Error("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&this._state.variablesState.StartVariableObservation()}var n=new ie;n.Start();let i=!1;this._sawLookaheadUnsafeFunctionAfterNewline=!1;do{try{i=this.ContinueSingleStep()}catch(t){if(!(t instanceof y))throw t;this.AddError(t.message,void 0,t.useEndLineNumber);break}}while(!i&&((!this._asyncContinueActive||t>=n.ElapsedMilliseconds)&&this.canContinue));n.Stop();let r=null;if(!i&&this.canContinue||(null!==this._stateSnapshotAtLastNewline&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length)||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(u.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(u.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.AddError(this.state.callStack.canPop?"unexpectedly reached end of content for unknown reason. Please debug compiler!":"ran out of content. Do you need a '-> DONE' or '-> END'?")),this.state.didSafeExit=!1,this._sawLookaheadUnsafeFunctionAfterNewline=!1,1==this._recursiveContinueCount&&(r=this._state.variablesState.CompleteVariableObservation()),this._asyncContinueActive=!1,null!==this.onDidContinue&&this.onDidContinue()),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue(),this.state.hasError||this.state.hasWarning){if(null===this.onError){let t=new b;throw t.Append("Ink had "),this.state.hasError&&(t.Append(""+this.state.currentErrors.length),t.Append(1==this.state.currentErrors.length?" error":"errors"),this.state.hasWarning)&&t.Append(" and "),this.state.hasWarning&&(t.Append(""+this.state.currentWarnings.length),t.Append(1==this.state.currentWarnings.length?" warning":"warnings"),this.state.hasWarning)&&t.Append(" and "),t.Append(". It is strongly suggested that you assign an error handler to story.onError. The first issue was: "),t.Append((this.state.hasError?this.state.currentErrors:this.state.currentWarnings)[0]),new y(""+t)}if(this.state.hasError)for(let t of this.state.currentErrors)this.onError(t,G.Error);if(this.state.hasWarning)for(let t of this.state.currentWarnings)this.onError(t,G.Warning);this.ResetErrors()}null!=r&&0<Object.keys(r).length&&this._state.variablesState.NotifyObservers(r)}ContinueSingleStep(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!==this._stateSnapshotAtLastNewline){if(null===this._stateSnapshotAtLastNewline.currentTags)return g("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return g("this.state.currentTags");var t=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==s.OutputStateChange.ExtendedBeyondNewline||this._sawLookaheadUnsafeFunctionAfterNewline)return this.RestoreStateSnapshot(),!0;t==s.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateSnapshotAtLastNewline&&this.StateSnapshot():this.DiscardSnapshot())}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}CalculateNewlineOutputStateChange(t,n,e,i){if(null===t)return g("prevText");if(null===n)return g("currText");var r=t.length<=n.length&&0<t.length&&"\n"==(n[0|t.length-1]||"");if(e!=i||t.length!=n.length||!r){if(!r)return s.OutputStateChange.NewlineRemoved;if(e<i)return s.OutputStateChange.ExtendedBeyondNewline;for(let e=t.length;e<n.length;e++){let t=n[0|e]||"";if(" "!=t&&"\t"!=t)return s.OutputStateChange.ExtendedBeyondNewline}}return s.OutputStateChange.NoChange}ContinueMaximally(){this.IfAsyncWeCant("ContinueMaximally");for(var t=new b;this.canContinue;)t.Append(this.Continue());return""+t}ContentAtPath(t){return this.mainContentContainer.ContentAtPath(t)}KnotContainerWithName(t){t=this.mainContentContainer.namedContent.get(t);return t instanceof A?t:null}PointerAtPath(t){if(0==t.length)return F.Null;let e=new F,n=t.length,i=null;return null===t.lastComponent?g("path.lastComponent"):(t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),null==i.obj||i.obj==this.mainContentContainer&&0<n?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e)}StateSnapshot(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching(!1)}RestoreStateSnapshot(){null===this._stateSnapshotAtLastNewline&&g("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}DiscardSnapshot(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}CopyStateForBackgroundThreadSave(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");var t=this._state;return this._state=this._state.CopyAndStartPatching(!0),this._asyncSaving=!0,t}BackgroundSaveComplete(){null===this._stateSnapshotAtLastNewline&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}Step(){let i=!0,r=this.state.currentPointer.copy();if(!r.isNull){let t=d(r.Resolve(),A);for(;t&&(this.VisitContainer(t,!0),0!=t.content.length);)r=F.StartOf(t),t=d(r.Resolve(),A);this.state.currentPointer=r.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);let n=r.Resolve(),e=this.PerformLogicAndFlowControl(n);if(!this.state.currentPointer.isNull){e&&(i=!1);var a=d(n,st);if(a){let t=this.ProcessChoice(a);t&&this.state.generatedChoices.push(t),n=null,i=!1}if(i=n instanceof A?!1:i){let e=d(n,tt);if(e&&-1==e.contextIndex){let t=this.state.callStack.ContextForVariableNamed(e.variableName);n=new tt(e.variableName,t)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(n):this.state.PushToOutputStream(n)}this.NextContent();a=d(n,x);a&&a.commandType==x.CommandType.StartThread&&this.state.callStack.PushThread()}}}VisitContainer(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(t))}VisitChangedContainersDueToDivert(){var e=this.state.previousPointer.copy(),t=this.state.currentPointer.copy();if(!t.isNull&&-1!=t.index){if(this._prevContainers.length=0,!e.isNull){let t=d(e.Resolve(),A)||d(e.container,A);for(;t;)this._prevContainers.push(t),t=d(t.parent,A)}let i=t.Resolve();if(null!=i){let e=d(i.parent,A),n=!0;for(;e&&(!~this._prevContainers.indexOf(e)||e.countingAtStartOnly);){let t=0<e.content.length&&i==e.content[0]&&n;t||(n=!1),this.VisitContainer(e,t),e=d((i=e).parent,A)}}}}PopChoiceStringAndTags(e){for(var t=f(this.state.PopEvaluationStack(),_);0<this.state.evaluationStack.length&&null!=d(this.state.PeekEvaluationStack(),Ht);){let t=d(this.state.PopEvaluationStack(),Ht);t&&e.push(t.text)}return t.value}ProcessChoice(t){let e=!0;if(t.hasCondition){let t=this.state.PopEvaluationStack();this.IsTruthy(t)||(e=!1)}let n="",i="",r=[];var a;return t.hasChoiceOnlyContent&&(i=this.PopChoiceStringAndTags(r)||""),t.hasStartContent&&(n=this.PopChoiceStringAndTags(r)||""),(e=(!t.onceOnly||this.state.VisitCountForContainer(t.choiceTarget)<=0)&&e)?((a=new Jt).targetPath=t.pathOnChoice,a.sourcePath=""+t.path,a.isInvisibleDefault=t.isInvisibleDefault,a.threadAtGeneration=this.state.callStack.ForkThread(),a.tags=r.reverse(),a.text=(n+i).replace(/^[ \t]+|[ \t]+$/g,""),a):null}IsTruthy(t){if(t instanceof w){var e=t;if(e instanceof Q){let t=e;return this.Error("Shouldn't use a divert target (to "+t.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}PerformLogicAndFlowControl(a){if(null!=a){if(a instanceof W){var t=a;if(t.isConditional){let t=this.state.PopEvaluationStack();if(!this.IsTruthy(t))return!0}if(t.hasVariableTarget){let n=t.variableDivertName,i=this.state.variablesState.GetVariableWithName(n);if(null==i)this.Error("Tried to divert using a target from a variable that could not be found ("+n+")");else if(!(i instanceof Q)){let t=d(i,E),e="Tried to divert to a target from a variable, but the variable ("+n+") didn't contain a divert target, it ";t instanceof E&&0==t.value?e+="was empty/null (the value 0).":e+="contained '"+i+"'.",this.Error(e)}var e=f(i,Q);this.state.divertedPointer=this.PointerAtPath(e.targetPath)}else{if(t.isExternal)return this.CallExternalFunction(t.targetPathString,t.externalArgs),!0;this.state.divertedPointer=t.targetPointer.copy()}return t.pushesToStack&&this.state.callStack.Push(t.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!t.isExternal&&this.Error(t&&t.debugMetadata&&null!=t.debugMetadata.sourceName?"Divert target doesn't exist: "+t.debugMetadata.sourceName:"Divert resolution failed: "+t),!0}if(a instanceof x){let r=a;switch(r.commandType){case x.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case x.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case x.CommandType.EvalOutput:if(0<this.state.evaluationStack.length){let e=this.state.PopEvaluationStack();if(!(e instanceof nt)){let t=new _(""+e);this.state.PushToOutputStream(t)}}break;case x.CommandType.NoOp:break;case x.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case x.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case x.CommandType.PopFunction:case x.CommandType.PopTunnel:let i=r.commandType==x.CommandType.PopFunction?u.Function:u.Tunnel,e=null;if(i==u.Tunnel){let t=this.state.PopEvaluationStack();null===(e=d(t,Q))&&this.Assert(t instanceof nt,"Expected void if ->-> doesn't override target")}if(!this.state.TryExitFunctionEvaluationFromGame())if(this.state.callStack.currentElement.type==i&&this.state.callStack.canPop)this.state.PopCallStack(),e&&(this.state.divertedPointer=this.PointerAtPath(e.targetPath));else{let t=new Map,e=(t.set(u.Function,"function return statement (~ return)"),t.set(u.Tunnel,"tunnel onwards statement (->->)"),t.get(this.state.callStack.currentElement.type)),n=(this.state.callStack.canPop||(e="end of flow (-> END or choice)"),"Found "+t.get(i)+", when expected "+e);this.Error(n)}break;case x.CommandType.BeginString:this.state.PushToOutputStream(r),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case x.CommandType.BeginTag:this.state.PushToOutputStream(r);break;case x.CommandType.EndTag:if(this.state.inStringEvaluation){let i=[],r=0;for(let n=this.state.outputStream.length-1;0<=n;--n){let t=this.state.outputStream[n],e=(r++,d(t,x));if(null!=e){if(e.commandType==x.CommandType.BeginTag)break;this.Error("Unexpected ControlCommand while extracting tag from choice");break}t instanceof _&&i.push(t)}this.state.PopFromOutputStream(r);let e=new b;for(let t of i.reverse())e.Append(""+t);let t=new Ht(this.state.CleanOutputWhitespace(""+e));this.state.PushEvaluationStack(t)}else this.state.PushToOutputStream(r);break;case x.CommandType.EndString:{let i=[],r=[],a=0;for(let n=this.state.outputStream.length-1;0<=n;--n){let t=this.state.outputStream[n],e=(a++,d(t,x));if(e&&e.commandType==x.CommandType.BeginString)break;t instanceof Ht&&r.push(t),t instanceof _&&i.push(t)}this.state.PopFromOutputStream(a);for(let t of r)this.state.PushToOutputStream(t);i=i.reverse();let e=new b;for(let t of i)e.Append(""+t);this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new _(""+e));break}case x.CommandType.ChoiceCount:let t=this.state.generatedChoices.length;this.state.PushEvaluationStack(new E(t));break;case x.CommandType.Turns:this.state.PushEvaluationStack(new E(this.state.currentTurnIndex+1));break;case x.CommandType.TurnsSince:case x.CommandType.ReadCount:var s=this.state.PopEvaluationStack();if(s instanceof Q){let t,e=f(s,Q),n=d(this.ContentAtPath(e.targetPath).correctObj,A);null!=n?t=r.commandType==x.CommandType.TurnsSince?this.state.TurnsSinceForContainer(n):this.state.VisitCountForContainer(n):(t=r.commandType==x.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+r+" lookup at "+e.targetPath)),this.state.PushEvaluationStack(new E(t))}else{let t="";s instanceof E&&(t=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+s+t)}break;case x.CommandType.Random:{let t=d(this.state.PopEvaluationStack(),E),e=d(this.state.PopEvaluationStack(),E);if(null==e||e instanceof E==0)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==t||t instanceof E==0)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===t.value)return g("maxInt.value");if(null===e.value)return g("minInt.value");let n=t.value-e.value+1,i=(isFinite(n)&&n<=Number.MAX_SAFE_INTEGER||(n=Number.MAX_SAFE_INTEGER,this.Error("RANDOM was called with a range that exceeds the size that ink numbers can use.")),0<n||this.Error("RANDOM was called with minimum as "+e.value+" and maximum as "+t.value+". The maximum must be larger"),this.state.storySeed+this.state.previousRandom),r=new Zt(i).next(),a=r%n+e.value;this.state.PushEvaluationStack(new E(a)),this.state.previousRandom=r;break}case x.CommandType.SeedRandom:s=d(this.state.PopEvaluationStack(),E);if(null==s||s instanceof E==0)return this.Error("Invalid value passed to SEED_RANDOM");if(null===s.value)return g("minInt.value");this.state.storySeed=s.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new nt);break;case x.CommandType.VisitIndex:s=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new E(s));break;case x.CommandType.SequenceShuffleIndex:s=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new E(s));break;case x.CommandType.StartThread:break;case x.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=F.Null);break;case x.CommandType.End:this.state.ForceEnd();break;case x.CommandType.ListFromInt:var s=d(this.state.PopEvaluationStack(),E),o=f(this.state.PopEvaluationStack(),_);if(null===s)throw new y("Passed non-integer when creating a list element from a numerical value.");let n=null;if(null===this.listDefinitions)return g("this.listDefinitions");var l=this.listDefinitions.TryListGetDefinition(o.value,null);if(!l.exists)throw new y("Failed to find LIST called "+o.value);{if(null===s.value)return g("minInt.value");let t=l.result.TryGetItemWithValue(s.value,C.Null);t.exists&&(n=new T(t.result,s.value))}null==n&&(n=new T),this.state.PushEvaluationStack(n);break;case x.CommandType.ListRange:o=d(this.state.PopEvaluationStack(),w),l=d(this.state.PopEvaluationStack(),w),s=d(this.state.PopEvaluationStack(),T);if(null===s||null===l||null===o)throw new y("Expected list, minimum and maximum for LIST_RANGE");if(null===s.value)return g("targetList.value");s=s.value.ListWithSubRange(l.valueObject,o.valueObject);this.state.PushEvaluationStack(new T(s));break;case x.CommandType.ListRandom:{let t=this.state.PopEvaluationStack();if(null===t)throw new y("Expected list for LIST_RANDOM");let s=t.value,o=null;if(null===s)throw g("list");if(0==s.Count)o=new S;else{let t=this.state.storySeed+this.state.previousRandom,e=new Zt(t).next(),n=e%s.Count,i=s.entries();for(let t=0;t<=n-1;t++)i.next();let r=i.next().value,a={Key:C.fromSerializedKey(r[0]),Value:r[1]};if(null===a.Key.originName)return g("randomItem.Key.originName");(o=new S(a.Key.originName,this)).Add(a.Key,a.Value),this.state.previousRandom=e}this.state.PushEvaluationStack(new T(o));break}default:this.Error("unhandled ControlCommand: "+r)}return!0}if(a instanceof ot){let t=a,e=this.state.PopEvaluationStack();return this.state.variablesState.Assign(t,e),!0}if(a instanceof St){let n=a,i=null;if(null!=n.pathForCount){let t=n.containerForCount,e=this.state.VisitCountForContainer(t);i=new E(e)}else null==(i=this.state.variablesState.GetVariableWithName(n.name))&&(this.Warning("Variable not found: '"+n.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),i=new E(0));return this.state.PushEvaluationStack(i),!0}if(a instanceof P){let t=a,e=this.state.PopEvaluationStack(t.numberOfParameters),n=t.Call(e);return this.state.PushEvaluationStack(n),!0}}return!1}ChoosePathString(n){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];if(this.IfAsyncWeCant("call ChoosePathString right now"),null!==this.onChoosePathString&&this.onChoosePathString(n,e),t)this.ResetCallstack();else if(this.state.callStack.currentElement.type==u.Function){let t="",e=this.state.callStack.currentElement.currentPointer.container;throw Error("Story was running a function "+(t=null!=e?"("+e.path+") ":t)+"when you called ChoosePathString("+n+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(e),this.ChoosePath(new m(n))}IfAsyncWeCant(t){if(this._asyncContinueActive)throw Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}ChoosePath(t){this.state.SetChosenPath(t,!(1<arguments.length&&void 0!==arguments[1])||arguments[1]),this.VisitChangedContainersDueToDivert()}ChooseChoiceIndex(t){var e=this.currentChoices,e=(this.Assert(0<=t&&t<e.length,"choice out of range"),e[t]);return null!==this.onMakeChoice&&this.onMakeChoice(e),null===e.threadAtGeneration?g("choiceToChoose.threadAtGeneration"):null===e.targetPath?g("choiceToChoose.targetPath"):(this.state.callStack.currentThread=e.threadAtGeneration,void this.ChoosePath(e.targetPath))}HasFunction(t){try{return null!=this.KnotContainerWithName(t)}catch(t){return!1}}EvaluateFunction(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(null!==this.onEvaluateFunction&&this.onEvaluateFunction(t,e),this.IfAsyncWeCant("evaluate a function"),null==t)throw Error("Function is null");if(""==t||!t.trim())throw Error("Function is empty or white space.");var i=this.KnotContainerWithName(t);if(null==i)throw Error("Function doesn't exist: '"+t+"'");for(var r=[],a=(r.push(...this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,e),new b);this.canContinue;)a.Append(this.Continue());i=""+a,this._state.ResetOutput(r),r=this.state.CompleteFunctionEvaluationFromGame();return null!=this.onCompleteEvaluateFunction&&this.onCompleteEvaluateFunction(t,e,i,r),n?{returned:r,output:i}:r}EvaluateExpression(t){var e=this.state.callStack.elements.length,t=(this.state.callStack.Push(u.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart(),this.state.evaluationStack.length);return this.Continue(),this._temporaryEvaluationContainer=null,e<this.state.callStack.elements.length&&this.state.PopCallStack(),t<this.state.evaluationStack.length?this.state.PopEvaluationStack():null}CallExternalFunction(n,i){if(null===n)return g("funcName");var r=this._externals.get(n),a=void 0!==r;if(a&&!r.lookAheadSafe&&this._state.inStringEvaluation&&this.Error("External function "+n+' could not be called because 1) it wasn\'t marked as lookaheadSafe when BindExternalFunction was called and 2) the story is in the middle of string generation, either because choice text is being generated, or because you have ink like "hello {func()}". You can work around this by generating the result of your function into a temporary variable before the string or choice gets generated: ~ temp x = '+n+"()"),a&&!r.lookAheadSafe&&null!==this._stateSnapshotAtLastNewline)this._sawLookaheadUnsafeFunctionAfterNewline=!0;else{if(!a){if(this.allowExternalFunctionFallbacks)return a=this.KnotContainerWithName(n),this.Assert(null!==a,"Trying to call EXTERNAL function '"+n+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(u.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=F.StartOf(a));this.Assert(!1,"Trying to call EXTERNAL function '"+n+"' which has not been bound (and ink fallbacks disabled).")}var s=[];for(let t=0;t<i;++t){let t=f(this.state.PopEvaluationStack(),w).valueObject;s.push(t)}s.reverse();let t=r.function(s),e=null;null!=t?(e=w.Create(t),this.Assert(null!==e,"Could not create ink value from returned object of type "+typeof t)):e=new nt,this.state.PushEvaluationStack(e)}}BindExternalFunctionGeneral(t,e){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,{function:e,lookAheadSafe:n})}TryCoerce(t){return t}BindExternalFunction(t,e){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];this.Assert(null!=e,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,n=>{this.Assert(e.length<=n.length,"External function expected "+e.length+" arguments");var i=[];for(let t=0,e=n.length;t<e;t++)i[t]=this.TryCoerce(n[t]);return e.apply(null,i)},n)}UnbindExternalFunction(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}ValidateExternalBindings(){let e=null,t=null,n=arguments[1]||new Set;if(arguments[0]instanceof A&&(e=arguments[0]),arguments[0]instanceof v&&(t=arguments[0]),null===e&&null===t)if(this.ValidateExternalBindings(this._mainContentContainer,n),this._hasValidatedExternals=!0,0==n.size)this._hasValidatedExternals=!0;else{let t="Error: Missing function binding for external";t=(t=(t=t+(1<n.size?"s":"")+": '")+Array.from(n).join("', '")+"' ")+(this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)"),this.Error(t)}else if(null!=e){for(let t of e.content)null!=t&&t.hasValidName||this.ValidateExternalBindings(t,n);for(let[,t]of e.namedContent)this.ValidateExternalBindings(d(t,v),n)}else if(null!=t){let e=d(t,W);if(e&&e.isExternal){let t=e.targetPathString;if(null===t)return g("name");this._externals.has(t)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(t)||n.add(t)}}}ObserveVariable(t,e){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw Error("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}ObserveVariables(n,i){for(let t=0,e=n.length;t<e;t++)this.ObserveVariable(n[t],i[t])}RemoveVariableObserver(n,t){if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(null!=t){var e;this._variableObservers.has(t)&&(null==n||null!=(e=this._variableObservers.get(t))&&(e.splice(e.indexOf(n),1),0===e.length))&&this._variableObservers.delete(t)}else if(null!=n){let t=this._variableObservers.keys();for(let e of t){let t=this._variableObservers.get(e);null!=t&&(t.splice(t.indexOf(n),1),0===t.length)&&this._variableObservers.delete(e)}}}VariableStateDidChangeEvent(e,t){if(null!==this._variableObservers){var n=this._variableObservers.get(e);if(void 0!==n){if(!(t instanceof w))throw Error("Tried to get the value of a variable that isn't a standard type");var i=f(t,w);for(let t of n)t(e,i.valueObject)}}}get globalTags(){return this.TagsAtStartOfFlowContainerWithPathString("")}TagsForContentAtPath(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}TagsAtStartOfFlowContainerWithPathString(t){let e=new m(t),n=this.ContentAtPath(e).container;if(null===n)return g("flowContainer");for(;;){let t=n.content[0];if(!(t instanceof A))break;n=t}let i=!1,r=null;for(let e of n.content){let t=d(e,x);if(null!=t)t.commandType==x.CommandType.BeginTag?i=!0:t.commandType==x.CommandType.EndTag&&(i=!1);else{if(!i)break;{let t=d(e,_);null!==t?(null===r&&(r=[]),null!==t.value&&r.push(t.value)):this.Error("Tag contained non-text content. Only plain text is allowed when using globalTags or TagsAtContentPath. If you want to evaluate dynamic content, you need to use story.Continue().")}}}return r}BuildStringOfHierarchy(){var t=new b;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),""+t}BuildStringOfContainer(t){var e=new b;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),""+e}NextContent(){if(this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=F.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){let t=!1;this.state.callStack.CanPop(u.Function)?(this.state.PopCallStack(u.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new nt),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}IncrementContentPointer(){let t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,null===e.container)return g("pointer.container");for(;e.index>=e.container.content.length;){t=!1;var n=d(e.container.parent,A);if(n instanceof A==0)break;var i=n.content.indexOf(e.container);if(-1==i)break;if((e=new F(n,i)).index++,t=!0,null===e.container)return g("pointer.container")}return t||(e=F.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}TryFollowDefaultInvisibleChoice(){var t=this._state.currentChoices,e=t.filter(t=>t.isInvisibleDefault);return 0!=e.length&&t.length<=e.length&&(null===(t=e[0]).targetPath?g("choice.targetPath"):null===t.threadAtGeneration?g("choice.threadAtGeneration"):(this.state.callStack.currentThread=t.threadAtGeneration,null!==this._stateSnapshotAtLastNewline&&(this.state.callStack.currentThread=this.state.callStack.ForkThread()),this.ChoosePath(t.targetPath,!1),!0))}NextSequenceShuffleIndex(){var t=d(this.state.PopEvaluationStack(),E);if(!(t instanceof E))return this.Error("expected number of elements in sequence for shuffle index"),0;var e=this.state.currentPointer.container;if(null===e)return g("seqContainer");if(null===t.value)return g("numElementsIntVal.value");var n=t.value,t=f(this.state.PopEvaluationStack(),E).value;if(null===t)return g("seqCount");let i=t/n,r=t%n,a=""+e.path,s=0;for(let t=0,e=a.length;t<e;t++)s+=a.charCodeAt(t)||0;var t=s+i+this.state.storySeed,o=new Zt(Math.floor(t)),l=[];for(let t=0;t<n;++t)l.push(t);for(let n=0;n<=r;++n){let t=o.next()%l.length,e=l[t];if(l.splice(t,1),n==r)return e}throw Error("Should never reach here")}Error(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],t=new y(t);throw t.useEndLineNumber=e,t}Warning(t){this.AddError(t,!0)}AddError(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=this.currentDebugMetadata,i=t?"WARNING":"ERROR";if(null!=n){let t=2<arguments.length&&void 0!==arguments[2]&&arguments[2]?n.endLineNumber:n.startLineNumber;e="RUNTIME "+i+": '"+n.fileName+"' line "+t+": "+e}else e=this.state.currentPointer.isNull?"RUNTIME "+i+": "+e:"RUNTIME "+i+": ("+this.state.currentPointer+"): "+e;this.state.AddError(e,t),t||this.state.ForceEnd()}Assert(t){let e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(0==t)throw Error((e=null==e?"Story assert":e)+" "+this.currentDebugMetadata)}get currentDebugMetadata(){let e,n=this.state.currentPointer;if(!n.isNull&&null!==n.Resolve()&&null!==(e=n.Resolve().debugMetadata))return e;for(let t=this.state.callStack.elements.length-1;0<=t;--t)if(!(n=this.state.callStack.elements[t].currentPointer).isNull&&null!==n.Resolve()&&null!==(e=n.Resolve().debugMetadata))return e;for(let t=this.state.outputStream.length-1;0<=t;--t)if(null!==(e=this.state.outputStream[t].debugMetadata))return e;return null}get mainContentContainer(){return this._temporaryEvaluationContainer||this._mainContentContainer}};re.inkVersionCurrent=21,(t=>{(t=t.OutputStateChange||(t.OutputStateChange={}))[t.NoChange=0]="NoChange",t[t.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",t[t.NewlineRemoved=2]="NewlineRemoved"})(re=re||{});class ae extends L{get flowLevel(){return c.Story}get hadError(){return this._hadError}get hadWarning(){return this._hadWarning}constructor(t){var o;super(null,t,null,!1,1<arguments.length&&void 0!==arguments[1]&&arguments[1]),(o=this)._errorHandler=null,this._hadError=!1,this._hadWarning=!1,this._dontFlattenContainers=new Set,this._listDefs=new Map,this.constants=new Map,this.externals=new Map,this.countAllVisits=!1,this.ExportRuntime=function(){let t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;var e,n;o._errorHandler=t,o.constants=new Map;for(let n of o.FindAll(pt)()){let e=o.constants.get(n.constantName);if(e&&!e.Equals(n.expression)){let t=`CONST '${n.constantName}' has been redefined with a different value. Multiple definitions of the same CONST are valid so long as they contain the same value. Initial definition was on ${e.debugMetadata}.`;o.Error(t,n,!1)}o.constants.set(n.constantName,n.expression)}o._listDefs=new Map;for(let t of o.FindAll(Nt)())null!=(e=t.identifier)&&e.name&&o._listDefs.set(null==(n=t.identifier)?void 0:n.name,t);o.externals=new Map,o.ResolveWeavePointNaming();var i=o.runtimeObject,r=new A,a=(r.AddContent(x.EvalStart()),[]);for(let[e,n]of o.variableDeclarations)if(n.isGlobalDeclaration){if(n.listDefinition)o._listDefs.set(e,n.listDefinition),r.AddContent(n.listDefinition.runtimeObject),a.push(n.listDefinition.runtimeListDefinition);else{if(!n.expression)throw Error();n.expression.GenerateIntoContainer(r)}let t=new ot(e,!0);t.isGlobal=!0,r.AddContent(t)}r.AddContent(x.EvalEnd()),r.AddContent(x.End()),0<o.variableDeclarations.size&&(r.name="global decl",i.AddToNamedContentOnly(r)),i.AddContent(x.Done());var s=new re(i,a);return o.runtimeObject=s,o.hadError||(o.FlattenContainersIn(i),o.ResolveReferences(o),o.hadError)?null:(s.ResetState(),s)},this.ResolveList=t=>this._listDefs.get(t)||null,this.ResolveListItem=function(t,n){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,e=null;if(t)return(e=o._listDefs.get(t))?e.ItemNamed(n):null;{let t=null,e=null;for(var[,r]of o._listDefs.entries()){var a=r.ItemNamed(n);a&&(t?o.Error(`Ambiguous item name '${n}' found in multiple sets, including ${e.identifier} and `+r.identifier,i,!1):(t=a,e=r))}return t}},this.FlattenContainersIn=t=>{var n=new Set;if(t.content)for(var e of t.content){let t=d(e,A);t&&n.add(t)}if(t.namedContent)for(let[,e]of t.namedContent){let t=d(e,A);t&&n.add(t)}for(let t of n)this.TryFlattenContainer(t),this.FlattenContainersIn(t)},this.TryFlattenContainer=e=>{if(!(e.namedContent&&0<e.namedContent.size||e.hasValidName||this._dontFlattenContainers.has(e))){var n=d(e.parent,A);if(n){let t=n.content.indexOf(e);n.content.splice(t,1);var i=e.ownDebugMetadata;if(e.content)for(var r of e.content)r.parent=null,null!==i&&null===r.ownDebugMetadata&&(r.debugMetadata=i),n.InsertContent(r,t),t+=1}}},this.Error=(t,e,n)=>{let i=n?B.Warning:B.Error,r="";if(e instanceof J?(r+="TODO: ",i=B.Author):r+=n?"WARNING: ":"ERROR: ",e&&null!==e.debugMetadata&&1<=e.debugMetadata.startLineNumber&&(null!=e.debugMetadata.fileName&&(r+=`'${e.debugMetadata.fileName}' `),r+=`line ${e.debugMetadata.startLineNumber}: `),t=r+=t,null===this._errorHandler)throw Error(t);this._errorHandler(t,i),this._hadError=i===B.Error,this._hadWarning=i===B.Warning},this.ResetError=()=>{this._hadError=!1,this._hadWarning=!1},this.IsExternal=t=>this.externals.has(t),this.AddExternal=t=>{this.externals.has(t.name)?this.Error(`Duplicate EXTERNAL definition of '${t.name}'`,t,!1):t.name&&this.externals.set(t.name,t)},this.DontFlattenContainer=t=>{this._dontFlattenContainers.add(t)},this.NameConflictError=(t,e,n,i)=>{t.Error(`${i} '${e}': name has already been used for a ${n.typeName.toLowerCase()} on `+n.debugMetadata)},this.CheckForNamingCollisions=function(n,i,t){var r,a=(3<arguments.length&&void 0!==arguments[3]?arguments[3]:"")||n.typeName;if(ae.IsReservedKeyword(null==i?void 0:i.name))n.Error(`'${i}' cannot be used for the name of a ${a.toLowerCase()} because it's a reserved keyword`);else if(wt.IsBuiltIn((null==i?void 0:i.name)||""))n.Error(`'${i}' cannot be used for the name of a ${a.toLowerCase()} because it's a built in function`);else{var e=d(o.ContentWithNameAtLevel((null==i?void 0:i.name)||"",c.Knot),L);if(!e||e===n&&t!==l.Arg){if(l.List<=t){for(let[t,e]of o._listDefs)if((null==i?void 0:i.name)===t&&n!==e&&e.variableAssignment!==n&&o.NameConflictError(n,null==i?void 0:i.name,e,a),!(n instanceof Ut))for(let t of e.itemDefinitions)(null==i?void 0:i.name)===t.name&&o.NameConflictError(n,(null==i?void 0:i.name)||"",t,a);if(t>l.Var){var s=(null==i?void 0:i.name)&&o.variableDeclarations.get(null==i?void 0:i.name)||null;if(s&&s!==n&&s.isGlobalDeclaration&&null==s.listDefinition&&o.NameConflictError(n,(null==i?void 0:i.name)||"",s,a),l.SubFlowAndWeave<=t){s=new gt(i).ResolveFromContext(n);if(s&&s!==n)o.NameConflictError(n,(null==i?void 0:i.name)||"",s,a);else if(t>=l.Arg&&t!==l.Arg){let e=d(n,L);if((e=e||bt(n))&&e.hasParameters&&e.args)for(let t of e.args)if((null==(r=t.identifier)?void 0:r.name)===(null==i?void 0:i.name))return void n.Error(`${a} '${i}': name has already been used for a argument to ${e.identifier} on `+e.debugMetadata)}}}}}else o.NameConflictError(n,(null==i?void 0:i.name)||"",e,a)}}}get typeName(){return"Story"}PreProcessTopLevelObjects(t){super.PreProcessTopLevelObjects(t);var e,i=[];for(e of t)if(e instanceof Bt){var r=e,a=t.indexOf(e);if(t.splice(a,1),r.includedStory){let e=[],n=r.includedStory;if(null!=n.content){for(let t of n.content)(t instanceof L?i:e).push(t);e.push(new R("\n")),t.splice(a,0,...e)}}}t.splice(0,0,...i)}}ae.IsReservedKeyword=t=>{switch(t){case"true":case"false":case"not":case"return":case"else":case"VAR":case"CONST":case"temp":case"LIST":case"function":return!0}return!1};class se extends I{get isSingleString(){return 1===this.content.length&&this.content[0]instanceof R}constructor(t){super(),this.GenerateIntoContainer=t=>{t.AddContent(x.BeginString());for(var e of this.content)t.AddContent(e.runtimeObject);t.AddContent(x.EndString())},this.toString=()=>{let t="";for(var e of this.content)t+=e;return t},this.AddContent(t)}get typeName(){return"String"}Equals(t){t=d(t,se);return null!==t&&!(!this.isSingleString||!t.isSingleString)&&""+this==""+t}}class oe extends p{constructor(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1];super(),this.GenerateRuntimeObject=()=>this.isStart?x.BeginTag():x.EndTag(),this.toString=()=>this.isStart?"#StartTag":"#EndTag",this.isStart=t,this.inChoice=e}get typeName(){return"Tag"}}class le{constructor(t){this.rootPath=t,this.ResolveInkFilename=()=>{throw Error("Can't resolve filename because no FileHandler was provided when instantiating the parser / compiler.")},this.LoadInkFileContents=()=>{throw Error("Can't load ink content because no FileHandler was provided when instantiating the parser / compiler.")}}}class j extends ct{get fileHandler(){if(this._fileHandler)return this._fileHandler;throw Error("No FileHandler defined")}set fileHandler(t){this._fileHandler=t}constructor(t){var a,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;if(super(t),(a=this).ParseStory=()=>{var t=this.StatementsAtLevel(s.StatementLevel.Top);return new ae(t,this._rootParser!==this)},this.SeparatedList=(e,n)=>{let t=this.Parse(e);if(null===t)return null;var i=[];for(i.push(t);;){let t=this.BeginRule();if(null===n()){this.FailRule(t);break}var r=this.Parse(e);if(null===r){this.FailRule(t);break}this.SucceedRule(t),i.push(r)}return i},this.CreateDebugMetadata=(t,e)=>{var n=new kt;return n.startLineNumber=((null==t?void 0:t.lineIndex)||0)+1,n.endLineNumber=e.lineIndex+1,n.startCharacterNumber=((null==t?void 0:t.characterInLineIndex)||0)+1,n.endCharacterNumber=e.characterInLineIndex+1,n.fileName=this._filename,n},this.RuleDidSucceed=(t,e,n)=>{var i=d(t,p),i=(i&&(i.debugMetadata=this.CreateDebugMetadata(e,n)),Array.isArray(t)?t:null);if(null!==i)for(let t of i)!d(t,p)||t.hasOwnDebugMetadata||(t.debugMetadata=this.CreateDebugMetadata(e,n));i=d(t,Ct);null!=i&&(i.debugMetadata=this.CreateDebugMetadata(e,n))},this.OnStringParserError=function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,i=3<arguments.length&&void 0!==arguments[3]&&arguments[3];let r=i?"WARNING:":"ERROR:";if(null!==a._filename&&(r+=` '${a._filename}'`),r+=` line ${n+1}: `+t,null===a._externalErrorHandler)throw Error(r);a._externalErrorHandler(r,i?B.Warning:B.Error)},this.AuthorWarning=()=>{this.Whitespace();var t=this.Parse(this.IdentifierWithMetadata);if(null===t||"TODO"!==t.name)return null;this.Whitespace(),this.ParseString(":"),this.Whitespace();t=this.ParseUntilCharactersFromString("\n\r");return t?new J(t):null},this.ExtendIdentifierCharacterRanges=t=>{var e;for(e of j.ListAllCharacterRanges())t.AddCharacters(e.ToCharacterSet())},this._parsingChoice=!1,this.Choice=()=>{let t=!0,e=this.Interleave(this.OptionalExclude(this.Whitespace),this.String("*"));if(!e){if(null===(e=this.Interleave(this.OptionalExclude(this.Whitespace),this.String("+"))))return null;t=!1}var n=this.Parse(this.BracketedName),i=(this.Whitespace(),null!=n&&this.Newline(),this.Parse(this.ChoiceCondition));if(this.Whitespace(),this._parsingChoice)throw Error("Already parsing a choice - shouldn't have nested choices");this._parsingChoice=!0;let r=null;var a=this.Parse(this.MixedTextAndLogic);a&&(r=new D(a));let s=null,o=null;a=null!==this.ParseString("[");if(a){this.EndTagIfNecessary(r);let t=this.Parse(this.MixedTextAndLogic),e=(null!==t&&(s=new D(t)),this.Expect(this.String("]"),"closing ']' for weave-style option"),this.EndTagIfNecessary(s),this.Parse(this.MixedTextAndLogic));null!==e&&(o=new D(e))}this.Whitespace(),this.EndTagIfNecessary(null!=o?o:r);var l=this.Parse(this.MultiDivert),h=(this._parsingChoice=!1,this.Whitespace(),!r&&!o&&!s);if(h&&null===l&&this.Warning("Choice is completely empty. Interpretting as a default fallback choice. Add a divert arrow to remove this warning: * ->"),r||!a||s||this.Warning("Blank choice - if you intended a default fallback choice, use the `* ->` syntax"),o=o||new D,this.EndTagIfNecessary(o),null!==l)for(let e of l){let t=d(e,$);t&&t.isEmpty||o.AddContent(e)}o.AddContent(new R("\n"));l=new k(r,s,o);return n&&(l.identifier=n),l.indentationDepth=e.length,l.hasWeaveStyleInlineBrackets=a,l.condition=i,l.onceOnly=t,l.isInvisibleDefault=h,l},this.ChoiceCondition=()=>{var t=this.Interleave(this.ChoiceSingleCondition,this.ChoiceConditionsSpace);return null===t?null:1===t.length?t[0]:new Et(t)},this.ChoiceConditionsSpace=()=>(this.Newline(),this.Whitespace(),ut),this.ChoiceSingleCondition=()=>{var t;return null===this.ParseString("{")?null:(t=this.Expect(this.Expression,"choice condition inside { }"),this.DisallowIncrement(t),this.Expect(this.String("}"),"closing '}' for choice condition"),t)},this.Gather=()=>{var t,e=this.Parse(this.GatherDashes);return null===e?null:(e=+(""+e),t=this.Parse(this.BracketedName),t=new mt(t,e),this.Newline(),t)},this.GatherDashes=()=>{this.Whitespace();let t=0;for(;null!==this.ParseDashNotArrow();)t+=1,this.Whitespace();return 0===t?null:t},this.ParseDashNotArrow=()=>{var t=this.BeginRule();return null===this.ParseString("->")&&"-"===this.ParseSingleCharacter()?this.SucceedRule(t):this.FailRule(t)},this.BracketedName=()=>{if(null===this.ParseString("("))return null;this.Whitespace();var t=this.Parse(this.IdentifierWithMetadata);return null===t?null:(this.Whitespace(),this.Expect(this.String(")"),"closing ')' for bracketed name"),t)},this.InnerConditionalContent=t=>{if(void 0===t){let t=this.Parse(this.ConditionExpression),e=this.Parse(()=>this.InnerConditionalContent(t));return null===e?null:e}let r,e=null!==t,n=null===this.Parse(this.Newline);if(n&&!e)return null;if(n)r=this.InlineConditionalBranches();else{if(null===(r=this.MultilineConditionalBranches())){if(t){let e=this.StatementsAtLevel(s.StatementLevel.InnerBlock);if(null!==e){r=[new Wt(e)];let t=this.Parse(this.SingleMultilineCondition);t&&(t.isElse||(this.ErrorWithParsedObject("Expected an '- else:' clause here rather than an extra condition",t),t.isElse=!0),r.push(t))}}if(null===r)return null}else if(1===r.length&&r[0].isElse&&t){let t=new Wt(null);t.isTrueBranch=!0,r.unshift(t)}if(t){let i=!1;for(let n=0;n<r.length;++n){let t=r[n],e=n===r.length-1;t.ownExpression?(t.matchingEquality=!0,i=!0):i&&e?(t.matchingEquality=!0,t.isElse=!0):!e&&2<r.length?this.ErrorWithParsedObject("Only final branch can be an 'else'. Did you miss a ':'?",t):0===n?t.isTrueBranch=!0:t.isElse=!0}}else{for(let n=0;n<r.length;++n){let e=r[n],t=n===r.length-1;if(null===e.ownExpression)if(t)e.isElse=!0;else if(e.isElse){let t=r[r.length-1];t.isElse?this.ErrorWithParsedObject("Multiple 'else' cases. Can have a maximum of one, at the end.",t):this.ErrorWithParsedObject("'else' case in conditional should always be the final one",e)}else this.ErrorWithParsedObject("Branch doesn't have condition. Are you missing a ':'? ",e)}1===r.length&&null===r[0].ownExpression&&this.ErrorWithParsedObject("Condition block with no conditions",r[0])}}if(null===r)return null;for(let t of r)t.isInline=n;return new ft(t,r)},this.InlineConditionalBranches=()=>{var e=this.Interleave(this.MixedTextAndLogic,this.Exclude(this.String("|")),null,!1);if(null===e||0===e.length)return null;var n=[];if(2<e.length)this.Error("Expected one or two alternatives separated by '|' in inline conditional");else{var t=new Wt(e[0]);if(t.isTrueBranch=!0,n.push(t),1<e.length){let t=new Wt(e[1]);t.isElse=!0,n.push(t)}}return n},this.MultilineConditionalBranches=()=>{this.MultilineWhitespace();var t=this.OneOrMore(this.SingleMultilineCondition);return null===t?null:(this.MultilineWhitespace(),t)},this.SingleMultilineCondition=()=>{if(this.Whitespace(),null!==this.ParseString("->")||null===this.ParseString("-"))return null;this.Whitespace();let t=null;var e=null!==this.Parse(this.ElseExpression);e||(t=this.Parse(this.ConditionExpression));let n=this.StatementsAtLevel(s.StatementLevel.InnerBlock);null===t&&null===n&&(this.Error("expected content for the conditional branch following '-'"),n=[new R("")]),this.MultilineWhitespace();var i=new Wt(n);return i.ownExpression=t,i.isElse=e,i},this.ConditionExpression=()=>{var t=this.Parse(this.Expression);return null===t||(this.DisallowIncrement(t),this.Whitespace(),null===this.ParseString(":"))?null:t},this.ElseExpression=()=>null===this.ParseString("else")||(this.Whitespace(),null===this.ParseString(":"))?null:ut,this._nonTextPauseCharacters=null,this._nonTextEndCharacters=null,this._notTextEndCharactersChoice=null,this._notTextEndCharactersString=null,this.TrimEndWhitespace=(t,e)=>{var n,i;0<t.length&&(i=t[n=t.length-1])instanceof R&&((i=i).text=i.text.replace(/[ \t]+$/g,""),e?i.text+=" ":0===i.text.length&&(t.splice(n,1),this.TrimEndWhitespace(t,!1)))},this.LineOfMixedTextAndLogic=()=>{this.Parse(this.Whitespace);var t,e=this.Parse(this.MixedTextAndLogic);return!e||!e.length||((t=e[0])&&t.text&&t.text.startsWith("return")&&this.Warning("Do you need a '~' before 'return'? If not, perhaps use a glue: <> (since it's lowercase) or rewrite somehow?"),0===e.length)?null:(e[e.length-1]instanceof $||this.TrimEndWhitespace(e,!1),this.EndTagIfNecessary(e),0<e.length&&e[0]instanceof oe&&e[0].isStart||e.push(new R("\n")),this.Expect(this.EndOfLine,"end of line",this.SkipToNextLine),e)},this.MixedTextAndLogic=()=>{null!==this.ParseObject(this.Spaced(this.String("~")))&&this.Error("You shouldn't use a '~' here - tildas are for logic that's on its own line. To do inline logic, use { curly braces } instead");let t=this.Interleave(this.Optional(this.ContentText),this.Optional(this.InlineLogicOrGlueOrStartTag));var e;return this._parsingChoice||null!==(e=this.Parse(this.MultiDivert))&&(null===t&&(t=[]),this.EndTagIfNecessary(t),this.TrimEndWhitespace(t,!0),t.push(...e)),t||null},this.ContentText=()=>this.ContentTextAllowingEscapeChar(),this.ContentTextAllowingEscapeChar=()=>{let t=null;for(;;){var e=this.Parse(this.ContentTextNoEscape),n=null!==this.ParseString("\\");if(!n&&null===e)break;null===t&&(t=""),null!==e&&(t+=""+e),n&&(t+=this.ParseSingleCharacter())}return null!==t?new R(t):null},this.ContentTextNoEscape=()=>{null===this._nonTextPauseCharacters&&(this._nonTextPauseCharacters=new O("-<")),null===this._nonTextEndCharacters&&(this._nonTextEndCharacters=new O("{}|\n\r\\#"),this._notTextEndCharactersChoice=new O(this._nonTextEndCharacters),this._notTextEndCharactersChoice.AddCharacters("[]"),this._notTextEndCharactersString=new O(this._nonTextEndCharacters),this._notTextEndCharactersString.AddCharacters('"'));var t=this.ParseUntil(()=>this.OneOf([this.ParseDivertArrow,this.ParseThreadArrow,this.EndOfLine,this.Glue]),this._nonTextPauseCharacters,this.parsingStringExpression?this._notTextEndCharactersString:this._parsingChoice?this._notTextEndCharactersChoice:this._nonTextEndCharacters);return null!==t?t:null},this.MultiDivert=()=>{this.Whitespace();let n=[],t=this.Parse(this.StartThread);if(t)n=[t];else{var i=this.Interleave(this.ParseDivertArrowOrTunnelOnwards,this.DivertIdentifierWithArguments);if(!i)return null;n=[],this.EndTagIfNecessary(n);for(let e=0;e<i.length;++e)if(e%2==0){if("->->"===i[e]){0!==e&&e!==i.length-1&&e!==i.length-2&&this.Error("Tunnel onwards '->->' must only come at the begining or the start of a divert");var r=new It;if(e<i.length-1){let t=d(i[e+1],$);r.divertAfter=t}n.push(r);break}}else{let t=i[e];e<i.length-1&&(t.isTunnel=!0),n.push(t)}if(0===n.length&&1===i.length){let t=new $(null);t.isEmpty=!0,n.push(t),this._parsingChoice||this.Error("Empty diverts (->) are only valid on choices")}}return n},this.StartThread=()=>{if(this.Whitespace(),null===this.ParseThreadArrow())return null;this.Whitespace();var t=this.Expect(this.DivertIdentifierWithArguments,"target for new thread",()=>new $(null));return t.isThread=!0,t},this.DivertIdentifierWithArguments=()=>{this.Whitespace();var t=this.Parse(this.DotSeparatedDivertPathComponents);if(!t)return null;this.Whitespace();var e=this.Parse(this.ExpressionFunctionCallArguments),t=(this.Whitespace(),new gt(t));return new $(t,e)},this.SingleDivert=()=>{var t=this.Parse(this.MultiDivert);return!t||1!==t.length||t[0]instanceof It||(t=t[0]).isTunnel?null:t},this.DotSeparatedDivertPathComponents=()=>this.Interleave(this.Spaced(this.IdentifierWithMetadata),this.Exclude(this.String("."))),this.ParseDivertArrowOrTunnelOnwards=()=>{let t=0;for(;null!==this.ParseString("->");)t+=1;return 0===t?null:1===t?"->":(2!==t&&this.Error("Unexpected number of arrows in divert. Should only have '->' or '->->'"),"->->")},this.ParseDivertArrow=()=>this.ParseString("->"),this.ParseThreadArrow=()=>this.ParseString("<-"),this._binaryOperators=[],this._maxBinaryOpLength=0,this.TempDeclarationOrAssignment=()=>{this.Whitespace();var t,e=this.ParseTempKeyword();this.Whitespace();if(null===(t=e?this.Expect(this.IdentifierWithMetadata,"variable name"):this.Parse(this.IdentifierWithMetadata)))return null;this.Whitespace();var n,i=null!==this.ParseString("+"),r=null!==this.ParseString("-");return i&&r&&this.Error("Unexpected sequence '+-'"),null===this.ParseString("=")?(e&&this.Error("Expected '='"),null):(n=this.Expect(this.Expression,"value expression to be assigned"),i||r?new jt(t,n,i):new Ot({variableIdentifier:t,assignedExpression:n,isTemporaryNewDeclaration:e}))},this.DisallowIncrement=t=>{t instanceof jt&&this.Error("Can't use increment/decrement here. It can only be used on a ~ line")},this.ParseTempKeyword=()=>{var t=this.BeginRule();return"temp"===this.Parse(this.Identifier)?(this.SucceedRule(t),!0):(this.FailRule(t),!1)},this.ReturnStatement=()=>{if(this.Whitespace(),"return"!==this.Parse(this.Identifier))return null;this.Whitespace();var t=this.Parse(this.Expression);return new vt(t)},this.Expression=function(){let t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,r=(a.Whitespace(),a.ExpressionUnary());if(null===r)return null;for(a.Whitespace();;){let n=a.BeginRule(),i=a.ParseInfixOperator();if(null===i||i.precedence<=t){a.FailRule(n);break}{let t=`right side of '${i.type}' expression`,e=a.Expect(()=>a.ExpressionInfixRight(r,i),t);if(null===e)return a.FailRule(n),null;r=a.SucceedRule(n,e)}}return a.Whitespace(),r},this.ExpressionUnary=()=>{let t=this.Parse(this.ExpressionDivertTarget);if(null!==t)return t;let e=this.OneOf([this.String("-"),this.String("!")]),n=(null===e&&(e=this.Parse(this.ExpressionNot)),this.Whitespace(),this.OneOf([this.ExpressionList,this.ExpressionParen,this.ExpressionFunctionCall,this.ExpressionVariableName,this.ExpressionLiteral]));if(null===(n=null===n&&null!==e?this.ExpressionUnary():n))return null;null!==e&&(n=it.WithInner(n,e)),this.Whitespace();var i=this.OneOf([this.String("++"),this.String("--")]);if(null!==i){let t="++"===i;n instanceof yt?n=new jt(n.identifier,t):this.Error(`can only increment and decrement variables, but saw '${n}'.`)}return n},this.ExpressionNot=()=>{var t=this.Identifier();return"not"===t?t:null},this.ExpressionLiteral=()=>this.OneOf([this.ExpressionFloat,this.ExpressionInt,this.ExpressionBool,this.ExpressionString]),this.ExpressionDivertTarget=()=>{this.Whitespace();var t=this.Parse(this.SingleDivert);return!t||t.isThread?null:(this.Whitespace(),new _t(t))},this.ExpressionInt=()=>{var t=this.ParseInt();return null===t?null:new N(t,"int")},this.ExpressionFloat=()=>{var t=this.ParseFloat();return null===t?null:new N(t,"float")},this.ExpressionString=()=>{if(null===this.ParseString('"'))return null;this.parsingStringExpression=!0;let t=this.Parse(this.MixedTextAndLogic);return this.Expect(this.String('"'),"close quote for string expression"),this.parsingStringExpression=!1,null===t?t=[new R("")]:t.find(t=>t instanceof $)&&this.Error("String expressions cannot contain diverts (->)"),new se(t)},this.ExpressionBool=()=>{var t=this.Parse(this.Identifier);return"true"===t?new N(!0,"bool"):"false"===t?new N(!1,"bool"):null},this.ExpressionFunctionCall=()=>{var t=this.Parse(this.IdentifierWithMetadata);if(null===t)return null;this.Whitespace();var e=this.Parse(this.ExpressionFunctionCallArguments);return null===e?null:new wt(t,e)},this.ExpressionFunctionCallArguments=()=>{if(null===this.ParseString("("))return null;var t=this.Exclude(this.String(","));let e=this.Interleave(this.Expression,t);return null===e&&(e=[]),this.Whitespace(),this.Expect(this.String(")"),"closing ')' for function call"),e},this.ExpressionVariableName=()=>{var t=this.Interleave(this.IdentifierWithMetadata,this.Exclude(this.Spaced(this.String("."))));return null===t||ae.IsReservedKeyword(t[0].name)?null:new yt(t)},this.ExpressionParen=()=>{var t;return null===this.ParseString("(")||null===(t=this.Parse(this.Expression))?null:(this.Whitespace(),this.Expect(this.String(")"),"closing parenthesis ')' for expression"),t)},this.ExpressionInfixRight=(t,e)=>{if(!t)return null;this.Whitespace();var n=this.Parse(()=>this.Expression(e.precedence));return n?new rt(t,n,e.type):null},this.ParseInfixOperator=()=>{for(var t of this._binaryOperators){var e=this.BeginRule();if(null!==this.ParseString(t.type)){if(t.requireWhitespace&&null===this.Whitespace()){this.FailRule(e);continue}return this.SucceedRule(e,t)}this.FailRule(e)}return null},this.ExpressionList=()=>{if(this.Whitespace(),null===this.ParseString("("))return null;this.Whitespace();var t=this.SeparatedList(this.ListMember,this.Spaced(this.String(",")));return this.Whitespace(),null===this.ParseString(")")?null:new qt(t)},this.ListMember=()=>{this.Whitespace();var t,e=this.Parse(this.IdentifierWithMetadata);return null===e?null:(null!==this.ParseString(".")&&(t=this.Expect(this.IdentifierWithMetadata,"element name within the set "+e),e.name+="."+(null==t?void 0:t.name)),this.Whitespace(),e)},this.RegisterExpressionOperators=()=>{this.RegisterBinaryOperator("&&",1),this.RegisterBinaryOperator("||",1),this.RegisterBinaryOperator("and",1,!0),this.RegisterBinaryOperator("or",1,!0),this.RegisterBinaryOperator("==",2),this.RegisterBinaryOperator(">=",2),this.RegisterBinaryOperator("<=",2),this.RegisterBinaryOperator("<",2),this.RegisterBinaryOperator(">",2),this.RegisterBinaryOperator("!=",2),this.RegisterBinaryOperator("?",3),this.RegisterBinaryOperator("has",3,!0),this.RegisterBinaryOperator("!?",3),this.RegisterBinaryOperator("hasnt",3,!0),this.RegisterBinaryOperator("^",3),this.RegisterBinaryOperator("+",4),this.RegisterBinaryOperator("-",5),this.RegisterBinaryOperator("*",6),this.RegisterBinaryOperator("/",7),this.RegisterBinaryOperator("%",8),this.RegisterBinaryOperator("mod",8,!0)},this.RegisterBinaryOperator=function(t,e){e=new Mt(t,e,2<arguments.length&&void 0!==arguments[2]&&arguments[2]);a._binaryOperators.push(e),a._maxBinaryOpLength=Math.max(a._maxBinaryOpLength,t.length)},this._openFilenames=[],this.IncludeStatement=()=>{if(this.Whitespace(),null===this.ParseString("INCLUDE"))return null;this.Whitespace();let t=this.Expect(()=>this.ParseUntilCharactersFromString("\n\r"),"filename for include statement");t=t.replace(/[ \t]+$/g,"");var e=this.fileHandler.ResolveInkFilename(t);if(this.FilenameIsAlreadyOpen(e))return this.Error(`Recursive INCLUDE detected: '${e}' is already open.`),this.ParseUntilCharactersFromString("\r\n"),new Bt(null);this.AddOpenFilename(e);let n=null,i="";try{i=this._rootParser.fileHandler.LoadInkFileContents(e)}catch(e){this.Error(`Failed to load: '${t}'.
Error:`+e)}return null!=i&&(n=new j(i,t,this._externalErrorHandler,this._rootParser,this.fileHandler).ParseStory()),this.RemoveOpenFilename(e),new Bt(n)},this.FilenameIsAlreadyOpen=t=>this._rootParser._openFilenames.includes(t),this.AddOpenFilename=t=>{this._rootParser._openFilenames.push(t)},this.RemoveOpenFilename=t=>{this._rootParser._openFilenames.splice(this._rootParser._openFilenames.indexOf(t),1)},this.KnotDefinition=()=>{var t=this.Parse(this.KnotDeclaration);if(null===t)return null;this.Expect(this.EndOfLine,"end of line after knot name definition",this.SkipToNextLine);var e=this.Expect(()=>this.StatementsAtLevel(s.StatementLevel.Knot),"at least one line within the knot",this.KnotStitchNoContentRecoveryRule);return new Gt(t.name,e,t.args,t.isFunction)},this.KnotDeclaration=()=>{if(this.Whitespace(),null===this.KnotTitleEquals())return null;this.Whitespace();var t=this.Parse(this.IdentifierWithMetadata);let e;var n="function"===(null==t?void 0:t.name),t=(null===(e=n?(this.Expect(this.Whitespace,"whitespace after the 'function' keyword"),this.Parse(this.IdentifierWithMetadata)):t)&&(this.Error("Expected the name of the "+(n?"function":"knot")),e=new Ct("")),this.Whitespace(),this.Parse(this.BracketedKnotDeclArguments));return this.Whitespace(),this.Parse(this.KnotTitleEquals),new Lt(e,t,n)},this.KnotTitleEquals=()=>{var t=this.ParseCharactersFromString("=");return null!==t&&1<t.length?t:null},this.StitchDefinition=()=>{var t=this.Parse(this.StitchDeclaration);if(null===t)return null;this.Expect(this.EndOfLine,"end of line after stitch name",this.SkipToNextLine);var e=this.Expect(()=>this.StatementsAtLevel(s.StatementLevel.Stitch),"at least one line within the stitch",this.KnotStitchNoContentRecoveryRule);return new Kt(t.name,e,t.args,t.isFunction)},this.StitchDeclaration=()=>{if(this.Whitespace(),null===this.ParseString("="))return null;if(null!==this.ParseString("="))return null;this.Whitespace();var t=null!==this.ParseString("function"),e=(t&&this.Whitespace(),this.Parse(this.IdentifierWithMetadata));if(null===e)return null;this.Whitespace();var n=this.Parse(this.BracketedKnotDeclArguments);return this.Whitespace(),new Lt(e,n,t)},this.KnotStitchNoContentRecoveryRule=()=>(this.ParseUntil(this.KnotDeclaration,new O("="),null),[new R("<ERROR IN FLOW>")]),this.BracketedKnotDeclArguments=()=>{if(null===this.ParseString("("))return null;let t=this.Interleave(this.Spaced(this.FlowDeclArgument),this.Exclude(this.String(",")));return this.Expect(this.String(")"),"closing ')' for parameter list"),t=null===t?[]:t},this.FlowDeclArgument=()=>{var t,e=this.Parse(this.IdentifierWithMetadata),n=(this.Whitespace(),this.ParseDivertArrow()),i=(this.Whitespace(),this.Parse(this.IdentifierWithMetadata));return null==e&&null===i?null:(t=new q,null!==n&&(t.isDivertTarget=!0),null!==e&&"ref"===e.name?(null===i&&this.Error("Expected an parameter name after 'ref'"),t.identifier=i,t.isByReference=!0):(t.identifier=t.isDivertTarget?i:e,null===t.identifier&&this.Error("Expected an parameter name"),t.isByReference=!1),t)},this.ExternalDeclaration=()=>{this.Whitespace();var t=this.Parse(this.IdentifierWithMetadata);if(null===t||"EXTERNAL"!=t.name)return null;this.Whitespace();t=this.Expect(this.IdentifierWithMetadata,"name of external function")||new Ct("");this.Whitespace();let e=this.Expect(this.BracketedKnotDeclArguments,`declaration of arguments for EXTERNAL, even if empty, i.e. 'EXTERNAL ${t}()'`);var n=(e=null===e?[]:e).map(t=>null==(t=t.identifier)?void 0:t.name).filter(H);return new Rt(t,n)},this._identifierCharSet=null,this.LogicLine=()=>{if(this.Whitespace(),null===this.ParseString("~"))return null;this.Whitespace();let t=this.Expect(()=>this.OneOf([this.ReturnStatement,this.TempDeclarationOrAssignment,this.Expression]),"expression after '~'",this.SkipToNextLine);if(null===t)return new D;t instanceof I&&!(t instanceof wt||t instanceof jt)&&this.Error("Logic following a '~' can't be that type of expression. It can only be something like:\n\t~ return\n\t~ var x = blah\n\t~ x++\n\t~ myFunction()");var e=d(t,wt);return e&&(e.shouldPopReturnedValue=!0),null!==t.Find(wt)()&&(t=new D(t,new R("\n"))),this.Expect(this.EndOfLine,"end of line",this.SkipToNextLine),t},this.VariableDeclaration=()=>{if(this.Whitespace(),"VAR"!==this.Parse(this.Identifier))return null;this.Whitespace();var t=this.Expect(this.IdentifierWithMetadata,"variable name"),e=(this.Whitespace(),this.Expect(this.String("="),"the '=' for an assignment of a value, e.g. '= 5' (initial values are mandatory)"),this.Whitespace(),this.Expect(this.Expression,"initial value for "));return e?(e instanceof N||e instanceof se||e instanceof _t||e instanceof yt||e instanceof qt||this.Error("initial value for a variable must be a number, constant, list or divert target"),null!==this.Parse(this.ListElementDefinitionSeparator)?this.Error("Unexpected ','. If you're trying to declare a new list, use the LIST keyword, not VAR"):e instanceof se&&(e.isSingleString||this.Error("Constant strings cannot contain any logic.")),new Ot({assignedExpression:e,isGlobalDeclaration:!0,variableIdentifier:t})):null},this.ListDeclaration=()=>{if(this.Whitespace(),"LIST"!=this.Parse(this.Identifier))return null;this.Whitespace();var t=this.Expect(this.IdentifierWithMetadata,"list name"),e=(this.Whitespace(),this.Expect(this.String("="),"the '=' for an assignment of the list definition"),this.Whitespace(),this.Expect(this.ListDefinition,"list item names"));return e?(e.identifier=new Ct(t.name),new Ot({variableIdentifier:t,listDef:e})):null},this.ListDefinition=()=>{this.AnyWhitespace();var t=this.SeparatedList(this.ListElementDefinition,this.ListElementDefinitionSeparator);return null===t?null:new Nt(t)},this.ListElementDefinitionSeparator=()=>(this.AnyWhitespace(),null===this.ParseString(",")?null:(this.AnyWhitespace(),",")),this.ListElementDefinition=()=>{let t=null!==this.ParseString("("),e=t;this.Whitespace();var n=this.Parse(this.IdentifierWithMetadata);if(null===n)return null;this.Whitespace(),t&&null!=this.ParseString(")")&&(e=!1,this.Whitespace());let i=null;if(null!==this.ParseString("=")){this.Whitespace();let t=this.Expect(this.ExpressionInt,"value to be assigned to list item");null!==t&&(i=t.value),e&&(this.Whitespace(),null!==this.ParseString(")"))&&(e=!1)}return e&&this.Error("Expected closing ')'"),new Ut(n,t,i)},this.ConstDeclaration=()=>{if(this.Whitespace(),"CONST"!==this.Parse(this.Identifier))return null;this.Whitespace();var t=this.Expect(this.IdentifierWithMetadata,"constant name"),e=(this.Whitespace(),this.Expect(this.String("="),"the '=' for an assignment of a value, e.g. '= 5' (initial values are mandatory)"),this.Whitespace(),this.Expect(this.Expression,"initial value for "));return e instanceof N||e instanceof _t||e instanceof se?e instanceof se&&(e.isSingleString||this.Error("Constant strings cannot contain any logic.")):this.Error("initial value for a constant must be a number or divert target"),new pt(t,e)},this.InlineLogicOrGlueOrStartTag=()=>this.OneOf([this.InlineLogic,this.Glue,this.StartTag]),this.Glue=()=>null!==this.ParseString("<>")?new $t(new Vt):null,this.InlineLogic=()=>{if(null===this.ParseString("{"))return null;var t=this.parsingStringExpression,e=this.tagActive,n=(this.Whitespace(),this.Expect(this.InnerLogic,"some kind of logic, conditional or sequence within braces: { ... }"));if(null===n)return this.parsingStringExpression=t,null;this.DisallowIncrement(n);let i=d(n,D);return i=i||new D(n),this.Whitespace(),this.Expect(this.String("}"),"closing brace '}' for inline logic"),this.parsingStringExpression=t,e||this.EndTagIfNecessary(i),i},this.InnerLogic=()=>{this.Whitespace();let e=this.ParseObject(this.SequenceTypeAnnotation);if(null!==e){let t=this.Expect(this.InnerSequenceObjects,"sequence elements (for cycle/stoping etc)");return null===t?null:new xt(t,e)}let t=this.Parse(this.ConditionExpression);if(t)return this.Expect(()=>this.InnerConditionalContent(t),"conditional content following query");let i=[this.InnerConditionalContent,this.InnerSequence,this.InnerExpression];for(let n of i){let t=this.BeginRule(),e=this.ParseObject(n);if(e&&null!==this.Peek(this.Spaced(this.String("}"))))return this.SucceedRule(t,e);this.FailRule(t)}return null},this.InnerExpression=()=>{var t=this.Parse(this.Expression);return t&&(t.outputWhenComplete=!0),t},this.IdentifierWithMetadata=()=>{var t=this.Identifier();return null===t?null:new Ct(t)},this.Identifier=()=>{var t,e=this.ParseCharactersFromCharSet(this.identifierCharSet);if(null===e)return null;let n=!0;for(t of e)if(t<"0"||"9"<t){n=!1;break}return n?null:e},this._sequenceTypeSymbols=new O("!&~$"),this.InnerSequence=()=>{this.Whitespace();let t=o.Stopping;var e=this.Parse(this.SequenceTypeAnnotation),e=(null!==e&&(t=e),this.Parse(this.InnerSequenceObjects));return null!==e&&1<e.length?new xt(e,t):null},this.SequenceTypeAnnotation=()=>{let t=this.Parse(this.SequenceTypeSymbolAnnotation);if(null===(t=null===t?this.Parse(this.SequenceTypeWordAnnotation):t))return null;switch(t){case o.Once:case o.Cycle:case o.Stopping:case o.Shuffle:case o.Shuffle|o.Stopping:case o.Shuffle|o.Once:break;default:return this.Error("Sequence type combination not supported: "+t),o.Stopping}return t},this.SequenceTypeSymbolAnnotation=()=>{null===this._sequenceTypeSymbols&&(this._sequenceTypeSymbols=new O("!&~$ "));let t=0;var e,n=this.ParseCharactersFromCharSet(this._sequenceTypeSymbols);if(null===n)return null;for(e of n)switch(e){case"!":t|=o.Once;break;case"&":t|=o.Cycle;break;case"~":t|=o.Shuffle;break;case"$":t|=o.Stopping}return 0===t?null:t},this.SequenceTypeWordAnnotation=()=>{var t,e=this.Interleave(this.SequenceTypeSingleWord,this.Exclude(this.Whitespace));if(null===e||0===e.length)return null;if(null===this.ParseString(":"))return null;let n=0;for(t of e)n|=t;return n},this.SequenceTypeSingleWord=()=>{let t=null;var e=this.Parse(this.IdentifierWithMetadata);if(null!==e)switch(e.name){case"once":t=o.Once;break;case"cycle":t=o.Cycle;break;case"shuffle":t=o.Shuffle;break;case"stopping":t=o.Stopping}return null===t?null:t},this.InnerSequenceObjects=()=>null!==this.Parse(this.Newline)?this.Parse(this.InnerMultilineSequenceObjects):this.Parse(this.InnerInlineSequenceObjects),this.InnerInlineSequenceObjects=()=>{let t=this.Interleave(this.Optional(this.MixedTextAndLogic),this.String("|"),null,!1);if(null===t)return null;var e,n=[];let i=!1;for(e of t)if("|"===e)i||n.push(new D),i=!1;else{let t=e;null===t?this.Error(`Expected content, but got ${e} (this is an ink compiler bug!)`):n.push(new D(t)),i=!0}return i||n.push(new D),n},this.InnerMultilineSequenceObjects=()=>{this.MultilineWhitespace();var t=this.OneOrMore(this.SingleMultilineSequenceElement);return null===t?null:t},this.SingleMultilineSequenceElement=()=>{if(this.Whitespace(),null!==this.ParseString("->"))return null;if(null===this.ParseString("-"))return null;this.Whitespace();var t=this.StatementsAtLevel(s.StatementLevel.InnerBlock);return null===t?this.MultilineWhitespace():t.unshift(new R("\n")),new D(t)},this._statementRulesAtLevel=[],this._statementBreakRulesAtLevel=[],this.StatementsAtLevel=t=>(t===s.StatementLevel.InnerBlock&&null!==this.Parse(this.GatherDashes)&&this.Error("You can't use a gather (the dashes) within the { curly braces } context. For multi-line sequences and conditions, you should only use one dash."),this.Interleave(this.Optional(this.MultilineWhitespace),()=>this.StatementAtLevel(t),()=>this.StatementsBreakForLevel(t))),this.StatementAtLevel=t=>{var e=this.OneOf(this._statementRulesAtLevel[t]);return t===s.StatementLevel.Top&&e instanceof vt&&this.Error("should not have return statement outside of a knot"),e},this.StatementsBreakForLevel=t=>{this.Whitespace();t=this.OneOf(this._statementBreakRulesAtLevel[t]);return null===t?null:t},this.GenerateStatementLevelRules=()=>{let t=Object.values(s.StatementLevel);this._statementRulesAtLevel="f".repeat(t.length).split("f").map(()=>[]),this._statementBreakRulesAtLevel="f".repeat(t.length).split("f").map(()=>[]);for(var n of t){let t=[],e=[];t.push(this.Line(this.MultiDivert)),n<s.StatementLevel.Top||t.push(this.KnotDefinition),t.push(this.Line(this.Choice)),t.push(this.Line(this.AuthorWarning)),n>s.StatementLevel.InnerBlock&&t.push(this.Gather),n<s.StatementLevel.Knot||t.push(this.StitchDefinition),t.push(this.Line(this.ListDeclaration)),t.push(this.Line(this.VariableDeclaration)),t.push(this.Line(this.ConstDeclaration)),t.push(this.Line(this.ExternalDeclaration)),t.push(this.Line(this.IncludeStatement)),t.push(this.LogicLine),t.push(this.LineOfMixedTextAndLogic),n>s.StatementLevel.Knot||e.push(this.KnotDeclaration),n>s.StatementLevel.Stitch||e.push(this.StitchDeclaration),n>s.StatementLevel.InnerBlock||(e.push(this.ParseDashNotArrow),e.push(this.String("}"))),this._statementRulesAtLevel[n]=t,this._statementBreakRulesAtLevel[n]=e}},this.SkipToNextLine=()=>(this.ParseUntilCharactersFromString("\n\r"),this.ParseNewline(),ut),this.Line=e=>()=>{var t=this.ParseObject(e);return null===t?null:(this.Expect(this.EndOfLine,"end of line",this.SkipToNextLine),t)},this.StartTag=()=>{if(this.Whitespace(),null===this.ParseString("#"))return null;this.parsingStringExpression&&this.Error("Tags aren't allowed inside of strings. Please use \\# if you want a hash symbol.");let t=null;var e;return t=this.tagActive?((e=new D).AddContent(new oe(!1)),e.AddContent(new oe(!0)),e):new oe(!0),this.tagActive=!0,this.Whitespace(),t},this._inlineWhitespaceChars=new O(" \t"),this.EndOfLine=()=>this.OneOf([this.Newline,this.EndOfFile]),this.Newline=()=>(this.Whitespace(),null!==this.ParseNewline()?ut:null),this.EndOfFile=()=>(this.Whitespace(),this.endOfInput?ut:null),this.MultilineWhitespace=()=>{var t=this.OneOrMore(this.Newline);return null===t||t.length<1?null:ut},this.Whitespace=()=>null!==this.ParseCharactersFromCharSet(this._inlineWhitespaceChars)?ut:null,this.Spaced=e=>()=>{this.Whitespace();var t=this.ParseObject(e);return null===t?null:(this.Whitespace(),t)},this.AnyWhitespace=()=>{let t=!1;for(;null!==this.OneOf([this.Whitespace,this.MultilineWhitespace]);)t=!0;return t?ut:null},this.MultiSpaced=e=>()=>{this.AnyWhitespace();var t=this.ParseObject(e);return null===t?null:(this.AnyWhitespace(),t)},this._filename=null,this._externalErrorHandler=null,this._fileHandler=null,this._filename=e,this.RegisterExpressionOperators(),this.GenerateStatementLevelRules(),this.errorHandler=this.OnStringParserError,this._externalErrorHandler=n,this._fileHandler=null===r?new le:r,null===i){if((this._rootParser=this)._openFilenames=[],null!==this._filename){let t=this.fileHandler.ResolveInkFilename(this._filename);this._openFilenames.push(t)}}else this._rootParser=i}PreProcessInputString(t){return new dt(t).Process()}get parsingStringExpression(){return this.GetFlag(+(""+e.ParsingString))}set parsingStringExpression(t){this.SetFlag(+(""+e.ParsingString),t)}get tagActive(){return this.GetFlag(+(""+e.TagActive))}set tagActive(t){this.SetFlag(+(""+e.TagActive),t)}get identifierCharSet(){return null===this._identifierCharSet&&((this._identifierCharSet=new O).AddRange("A","Z").AddRange("a","z").AddRange("0","9").Add("_"),this.ExtendIdentifierCharacterRanges(this._identifierCharSet)),this._identifierCharSet}EndTagIfNecessary(t){this.tagActive&&(null!=t&&(t instanceof D?t.AddContent(new oe(!1)):t.push(new oe(!1))),this.tagActive=!1)}}j.LatinBasic=at.Define("A","z",(new O).AddRange("[","`")),j.LatinExtendedA=at.Define("Ā","ſ"),j.LatinExtendedB=at.Define("ƀ","ɏ"),j.Greek=at.Define("Ͱ","Ͽ",(new O).AddRange("͸","΅").AddCharacters("ʹ͵͸·΋΍΢")),j.Cyrillic=at.Define("Ѐ","ӿ",(new O).AddRange("҂","҉")),j.Armenian=at.Define("԰","֏",(new O).AddCharacters("԰").AddRange("՗","ՠ").AddRange("ֈ","֎")),j.Hebrew=at.Define("֐","׿",new O),j.Arabic=at.Define("؀","ۿ",new O),j.Korean=at.Define("가","힯",new O),j.Latin1Supplement=at.Define("","ÿ",new O),j.Chinese=at.Define("一","鿿",new O),j.ListAllCharacterRanges=()=>[j.LatinBasic,j.LatinExtendedA,j.LatinExtendedB,j.Arabic,j.Armenian,j.Cyrillic,j.Greek,j.Hebrew,j.Korean,j.Latin1Supplement,j.Chinese],s.Compiler=class{get errors(){return this._errors}get warnings(){return this._warnings}get authorMessages(){return this._authorMessages}get inputString(){return this._inputString}get options(){return this._options}get parsedStory(){if(this._parsedStory)return this._parsedStory;throw Error()}get runtimeStory(){if(this._runtimeStory)return this._runtimeStory;throw Error("Compilation failed.")}get parser(){if(this._parser)return this._parser;throw Error()}get debugSourceRanges(){return this._debugSourceRanges}constructor(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;this._errors=[],this._warnings=[],this._authorMessages=[],this._parsedStory=null,this._runtimeStory=null,this._parser=null,this._debugSourceRanges=[],this.Compile=()=>(this._parser=new j(this.inputString,this.options.sourceFilename||null,this.OnError,null,this.options.fileHandler),this._parsedStory=this.parser.ParseStory(),0===this.errors.length?(this.parsedStory.countAllVisits=this.options.countAllVisits,this._runtimeStory=this.parsedStory.ExportRuntime(this.OnError)):this._runtimeStory=null,this.runtimeStory),this.RetrieveDebugSourceForLatestContent=()=>{var e,t;for(t of this.runtimeStory.state.outputStream){var n=d(t,_);if(null!==n){let t=new i((null==(e=n.value)?void 0:e.length)||0,n.debugMetadata,n.value||"unknown");this.debugSourceRanges.push(t)}}},this.DebugMetadataForContentAtOffset=t=>{let e=0,n=null;for(var i of this.debugSourceRanges){if(null!==i.debugMetadata&&(n=i.debugMetadata),t>=e&&t<e+i.length)return n;e+=i.length}return null},this.OnError=(t,e)=>{switch(e){case B.Author:this._authorMessages.push(t);break;case B.Warning:this._warnings.push(t);break;case B.Error:this._errors.push(t)}null!==this.options.errorHandler&&this.options.errorHandler(t,e)},this._inputString=t,this._options=e||new n}},s.CompilerOptions=n,s.InkList=S,s.InkParser=j,s.JsonFileHandler=class{constructor(t){this.fileHierarchy=t,this.ResolveInkFilename=t=>{if(Object.keys(this.fileHierarchy).includes(t))return t;throw Error(`Cannot locate ${t}. Are you trying a relative import ? This is not yet implemented.`)},this.LoadInkFileContents=t=>{if(Object.keys(this.fileHierarchy).includes(t))return this.fileHierarchy[t];throw Error(`Cannot open ${t}.`)}}},s.Story=re});